From f90e385cdf446af8cc34d7cfb48da99d7953f30d Mon Sep 17 00:00:00 2001
From: John Rigby <john.rigby@vivint.com>
Date: Sat, 8 Feb 2014 12:18:26 -0700
Subject: [PATCH] New version with libcurl updates and new autotools

---
 Makefile.in              |  117 ++--
 aclocal.m4               |   85 ++-
 autotools/config.guess   |  397 ++++++------
 autotools/config.sub     |  220 ++++---
 autotools/depcomp        |   74 ++-
 autotools/install-sh     |   29 +-
 autotools/missing        |   53 +-
 bootstrap                |    5 +
 client.c                 |  139 +++--
 config.h.in              |    3 +
 configure                |  614 ++++++++++--------
 configure.ac             |    2 +
 doc/Makefile.in          |   29 +-
 doc/zsync.1              |   28 +-
 format_string.h          |    2 +-
 http.c                   | 1554 +++++++++++++++++++---------------------------
 http.h                   |   15 +-
 librcksum/Makefile.in    |   36 +-
 librcksum/md4.h          |   11 +
 librcksum/state.c        |    4 +-
 libzsync/Makefile.in     |   36 +-
 libzsync/sha1.c          |    6 +
 libzsync/sha1.h          |   11 +
 libzsync/zsync.c         |   32 +-
 libzsync/zsync.h         |    6 +
 url.c                    |   51 --
 url.h                    |    7 -
 zlib/Makefile.am         |    3 +
 zlib/Makefile.in         |   24 +-
 zlib/README.zsync        |   89 +++
 zlib/zconf.in.h          |  323 ++++++++++
 zlib/zlib.h              |    1 +
 zlib/zsync_zlib_rename.h |   49 ++
 33 files changed, 2284 insertions(+), 1771 deletions(-)
 create mode 100755 bootstrap
 create mode 100644 zlib/README.zsync
 create mode 100644 zlib/zconf.in.h
 create mode 100644 zlib/zsync_zlib_rename.h

diff --git a/Makefile.in b/Makefile.in
index 910a8c2..c08e000 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -1,9 +1,9 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.11.3 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011 Free Software
+# Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -105,6 +105,12 @@ am__nobase_list = $(am__nobase_strip_setup); \
 am__base_list = \
   sed '$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;s/\n/ /g' | \
   sed '$$!N;$$!N;$$!N;$$!N;s/\n/ /g'
+am__uninstall_files_from_dir = { \
+  test -z "$$files" \
+    || { test ! -d "$$dir" && test ! -f "$$dir" && test ! -r "$$dir"; } \
+    || { echo " ( cd '$$dir' && rm -f" $$files ")"; \
+         $(am__cd) "$$dir" && rm -f $$files; }; \
+  }
 DATA = $(doc_DATA)
 RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
   distclean-recursive maintainer-clean-recursive
@@ -120,9 +126,11 @@ DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 distdir = $(PACKAGE)-$(VERSION)
 top_distdir = $(distdir)
 am__remove_distdir = \
-  { test ! -d "$(distdir)" \
-    || { find "$(distdir)" -type d ! -perm -200 -exec chmod u+w {} ';' \
-         && rm -fr "$(distdir)"; }; }
+  if test -d "$(distdir)"; then \
+    find "$(distdir)" -type d ! -perm -200 -exec chmod u+w {} ';' \
+      && rm -rf "$(distdir)" \
+      || { sleep 5 && rm -rf "$(distdir)"; }; \
+  else :; fi
 am__relativize = \
   dir0=`pwd`; \
   sed_first='s,^\([^/]*\)/.*$$,\1,'; \
@@ -151,6 +159,8 @@ am__relativize = \
 GZIP_ENV = --best
 DIST_ARCHIVES = $(distdir).tar.bz2
 distuninstallcheck_listfiles = find . -type f -print
+am__distuninstallcheck_listfiles = $(distuninstallcheck_listfiles) \
+  | sed 's|^\./|$(prefix)/|' | grep -v '$(infodir)/dir$$'
 distcleancheck_listfiles = find . -type f -print
 ACLOCAL = @ACLOCAL@
 AMTAR = @AMTAR@
@@ -280,7 +290,7 @@ all: config.h
 
 .SUFFIXES:
 .SUFFIXES: .c .o .obj
-am--refresh:
+am--refresh: Makefile
 	@:
 $(srcdir)/Makefile.in: @MAINTAINER_MODE_TRUE@ $(srcdir)/Makefile.am  $(am__configure_deps)
 	@for dep in $?; do \
@@ -316,10 +326,8 @@ $(ACLOCAL_M4): @MAINTAINER_MODE_TRUE@ $(am__aclocal_m4_deps)
 $(am__aclocal_m4_deps):
 
 config.h: stamp-h1
-	@if test ! -f $@; then \
-	  rm -f stamp-h1; \
-	  $(MAKE) $(AM_MAKEFLAGS) stamp-h1; \
-	else :; fi
+	@if test ! -f $@; then rm -f stamp-h1; else :; fi
+	@if test ! -f $@; then $(MAKE) $(AM_MAKEFLAGS) stamp-h1; else :; fi
 
 stamp-h1: $(srcdir)/config.h.in $(top_builddir)/config.status
 	@rm -f stamp-h1
@@ -368,10 +376,10 @@ uninstall-binPROGRAMS:
 
 clean-binPROGRAMS:
 	-test -z "$(bin_PROGRAMS)" || rm -f $(bin_PROGRAMS)
-zsync$(EXEEXT): $(zsync_OBJECTS) $(zsync_DEPENDENCIES) 
+zsync$(EXEEXT): $(zsync_OBJECTS) $(zsync_DEPENDENCIES) $(EXTRA_zsync_DEPENDENCIES) 
 	@rm -f zsync$(EXEEXT)
 	$(LINK) $(zsync_OBJECTS) $(zsync_LDADD) $(LIBS)
-zsyncmake$(EXEEXT): $(zsyncmake_OBJECTS) $(zsyncmake_DEPENDENCIES) 
+zsyncmake$(EXEEXT): $(zsyncmake_OBJECTS) $(zsyncmake_DEPENDENCIES) $(EXTRA_zsyncmake_DEPENDENCIES) 
 	@rm -f zsyncmake$(EXEEXT)
 	$(LINK) $(zsyncmake_OBJECTS) $(zsyncmake_LDADD) $(LIBS)
 
@@ -420,9 +428,7 @@ uninstall-docDATA:
 	@$(NORMAL_UNINSTALL)
 	@list='$(doc_DATA)'; test -n "$(docdir)" || list=; \
 	files=`for p in $$list; do echo $$p; done | sed -e 's|^.*/||'`; \
-	test -n "$$files" || exit 0; \
-	echo " ( cd '$(DESTDIR)$(docdir)' && rm -f" $$files ")"; \
-	cd "$(DESTDIR)$(docdir)" && rm -f $$files
+	dir='$(DESTDIR)$(docdir)'; $(am__uninstall_files_from_dir)
 
 # This directory's subdirectories are mostly independent; you can cd
 # into them and run `make' without going through this Makefile.
@@ -640,14 +646,15 @@ check-TESTS: $(TESTS)
 	  fi; \
 	  dashes=`echo "$$dashes" | sed s/./=/g`; \
 	  if test "$$failed" -eq 0; then \
-	    echo "$$grn$$dashes"; \
+	    col="$$grn"; \
 	  else \
-	    echo "$$red$$dashes"; \
+	    col="$$red"; \
 	  fi; \
-	  echo "$$banner"; \
-	  test -z "$$skipped" || echo "$$skipped"; \
-	  test -z "$$report" || echo "$$report"; \
-	  echo "$$dashes$$std"; \
+	  echo "$${col}$$dashes$${std}"; \
+	  echo "$${col}$$banner$${std}"; \
+	  test -z "$$skipped" || echo "$${col}$$skipped$${std}"; \
+	  test -z "$$report" || echo "$${col}$$report$${std}"; \
+	  echo "$${col}$$dashes$${std}"; \
 	  test "$$failed" -eq 0; \
 	else :; fi
 
@@ -728,7 +735,11 @@ dist-gzip: distdir
 	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
 	$(am__remove_distdir)
 dist-bzip2: distdir
-	tardir=$(distdir) && $(am__tar) | bzip2 -9 -c >$(distdir).tar.bz2
+	tardir=$(distdir) && $(am__tar) | BZIP2=$${BZIP2--9} bzip2 -c >$(distdir).tar.bz2
+	$(am__remove_distdir)
+
+dist-lzip: distdir
+	tardir=$(distdir) && $(am__tar) | lzip -c $${LZIP_OPT--9} >$(distdir).tar.lz
 	$(am__remove_distdir)
 
 dist-lzma: distdir
@@ -736,7 +747,7 @@ dist-lzma: distdir
 	$(am__remove_distdir)
 
 dist-xz: distdir
-	tardir=$(distdir) && $(am__tar) | xz -c >$(distdir).tar.xz
+	tardir=$(distdir) && $(am__tar) | XZ_OPT=$${XZ_OPT--e} xz -c >$(distdir).tar.xz
 	$(am__remove_distdir)
 
 dist-tarZ: distdir
@@ -753,7 +764,7 @@ dist-zip: distdir
 	$(am__remove_distdir)
 
 dist dist-all: distdir
-	tardir=$(distdir) && $(am__tar) | bzip2 -9 -c >$(distdir).tar.bz2
+	tardir=$(distdir) && $(am__tar) | BZIP2=$${BZIP2--9} bzip2 -c >$(distdir).tar.bz2
 	$(am__remove_distdir)
 
 # This target untars the dist file and tries a VPATH configuration.  Then
@@ -767,6 +778,8 @@ distcheck: dist
 	  bzip2 -dc $(distdir).tar.bz2 | $(am__untar) ;;\
 	*.tar.lzma*) \
 	  lzma -dc $(distdir).tar.lzma | $(am__untar) ;;\
+	*.tar.lz*) \
+	  lzip -dc $(distdir).tar.lz | $(am__untar) ;;\
 	*.tar.xz*) \
 	  xz -dc $(distdir).tar.xz | $(am__untar) ;;\
 	*.tar.Z*) \
@@ -786,6 +799,7 @@ distcheck: dist
 	  && am__cwd=`pwd` \
 	  && $(am__cd) $(distdir)/_build \
 	  && ../configure --srcdir=.. --prefix="$$dc_install_base" \
+	    $(AM_DISTCHECK_CONFIGURE_FLAGS) \
 	    $(DISTCHECK_CONFIGURE_FLAGS) \
 	  && $(MAKE) $(AM_MAKEFLAGS) \
 	  && $(MAKE) $(AM_MAKEFLAGS) dvi \
@@ -814,8 +828,16 @@ distcheck: dist
 	  list='$(DIST_ARCHIVES)'; for i in $$list; do echo $$i; done) | \
 	  sed -e 1h -e 1s/./=/g -e 1p -e 1x -e '$$p' -e '$$x'
 distuninstallcheck:
-	@$(am__cd) '$(distuninstallcheck_dir)' \
-	&& test `$(distuninstallcheck_listfiles) | wc -l` -le 1 \
+	@test -n '$(distuninstallcheck_dir)' || { \
+	  echo 'ERROR: trying to run $@ with an empty' \
+	       '$$(distuninstallcheck_dir)' >&2; \
+	  exit 1; \
+	}; \
+	$(am__cd) '$(distuninstallcheck_dir)' || { \
+	  echo 'ERROR: cannot chdir into $(distuninstallcheck_dir)' >&2; \
+	  exit 1; \
+	}; \
+	test `$(am__distuninstallcheck_listfiles) | wc -l` -eq 0 \
 	   || { echo "ERROR: files left after uninstall:" ; \
 	        if test -n "$(DESTDIR)"; then \
 	          echo "  (check DESTDIR support)"; \
@@ -850,10 +872,15 @@ install-am: all-am
 
 installcheck: installcheck-recursive
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -943,20 +970,20 @@ uninstall-am: uninstall-binPROGRAMS uninstall-docDATA
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am am--refresh check check-TESTS check-am clean \
 	clean-binPROGRAMS clean-generic ctags ctags-recursive dist \
-	dist-all dist-bzip2 dist-gzip dist-lzma dist-shar dist-tarZ \
-	dist-xz dist-zip distcheck distclean distclean-compile \
-	distclean-generic distclean-hdr distclean-tags distcleancheck \
-	distdir distuninstallcheck dvi dvi-am html html-am info \
-	info-am install install-am install-binPROGRAMS install-data \
-	install-data-am install-docDATA install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs installdirs-am \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-compile mostlyclean-generic pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am \
-	uninstall-binPROGRAMS uninstall-docDATA
+	dist-all dist-bzip2 dist-gzip dist-lzip dist-lzma dist-shar \
+	dist-tarZ dist-xz dist-zip distcheck distclean \
+	distclean-compile distclean-generic distclean-hdr \
+	distclean-tags distcleancheck distdir distuninstallcheck dvi \
+	dvi-am html html-am info info-am install install-am \
+	install-binPROGRAMS install-data install-data-am \
+	install-docDATA install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs installdirs-am maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic pdf pdf-am ps ps-am tags tags-recursive \
+	uninstall uninstall-am uninstall-binPROGRAMS uninstall-docDATA
 
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
diff --git a/aclocal.m4 b/aclocal.m4
index 44cf250..7f84837 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -1,7 +1,8 @@
-# generated automatically by aclocal 1.11.1 -*- Autoconf -*-
+# generated automatically by aclocal 1.11.3 -*- Autoconf -*-
 
 # Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
-# 2005, 2006, 2007, 2008, 2009  Free Software Foundation, Inc.
+# 2005, 2006, 2007, 2008, 2009, 2010, 2011 Free Software Foundation,
+# Inc.
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -13,18 +14,21 @@
 
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
-m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.65],,
-[m4_warning([this file was generated for autoconf 2.65.
+m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.68],,
+[m4_warning([this file was generated for autoconf 2.68.
 You have another version of autoconf.  It may work, but is not guaranteed to.
 If you have problems, you may need to regenerate the build system entirely.
 To do so, use the procedure documented by the package, typically `autoreconf'.])])
 
-# Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008, 2011 Free Software
+# Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
+# serial 1
+
 # AM_AUTOMAKE_VERSION(VERSION)
 # ----------------------------
 # Automake X.Y traces this macro to ensure aclocal.m4 has been
@@ -34,7 +38,7 @@ AC_DEFUN([AM_AUTOMAKE_VERSION],
 [am__api_version='1.11'
 dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
 dnl require some minimum version.  Point them to the right macro.
-m4_if([$1], [1.11.1], [],
+m4_if([$1], [1.11.3], [],
       [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
 ])
 
@@ -50,19 +54,21 @@ m4_define([_AM_AUTOCONF_VERSION], [])
 # Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
 # This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-[AM_AUTOMAKE_VERSION([1.11.1])dnl
+[AM_AUTOMAKE_VERSION([1.11.3])dnl
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
 _AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
 
 # AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
 
-# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+# Copyright (C) 2001, 2003, 2005, 2011 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
+# serial 1
+
 # For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
 # $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
 # `$srcdir', `$srcdir/..', or `$srcdir/../..'.
@@ -144,14 +150,14 @@ AC_CONFIG_COMMANDS_PRE(
 Usually this means the macro was only invoked conditionally.]])
 fi])])
 
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2009
-# Free Software Foundation, Inc.
+# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2009,
+# 2010, 2011 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 10
+# serial 12
 
 # There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
 # written in clear, in which case automake, when reading aclocal.m4,
@@ -191,6 +197,7 @@ AC_CACHE_CHECK([dependency style of $depcc],
   # instance it was reported that on HP-UX the gcc test will end up
   # making a dummy file named `D' -- because `-MD' means `put the output
   # in D'.
+  rm -rf conftest.dir
   mkdir conftest.dir
   # Copy depcomp to subdir because otherwise we won't find it if we're
   # using a relative directory.
@@ -255,7 +262,7 @@ AC_CACHE_CHECK([dependency style of $depcc],
 	break
       fi
       ;;
-    msvisualcpp | msvcmsys)
+    msvc7 | msvc7msys | msvisualcpp | msvcmsys)
       # This compiler won't grok `-c -o', but also, the minuso test has
       # not run yet.  These depmodes are late enough in the game, and
       # so weak that their functioning should not be impacted.
@@ -320,10 +327,13 @@ AC_DEFUN([AM_DEP_TRACK],
 if test "x$enable_dependency_tracking" != xno; then
   am_depcomp="$ac_aux_dir/depcomp"
   AMDEPBACKSLASH='\'
+  am__nodep='_no'
 fi
 AM_CONDITIONAL([AMDEP], [test "x$enable_dependency_tracking" != xno])
 AC_SUBST([AMDEPBACKSLASH])dnl
 _AM_SUBST_NOTMAKE([AMDEPBACKSLASH])dnl
+AC_SUBST([am__nodep])dnl
+_AM_SUBST_NOTMAKE([am__nodep])dnl
 ])
 
 # Generate code to set up dependency tracking.              -*- Autoconf -*-
@@ -407,20 +417,19 @@ AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
 ])
 
 
-# Copyright (C) 1996, 1998, 1999, 2000, 2001, 2002, 2003, 2005
+# Copyright (C) 1996, 1998, 1999, 2000, 2001, 2002, 2003, 2005, 2010
 # Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 3
+# serial 4
 
 AC_DEFUN([AM_WITH_DMALLOC],
 [AC_MSG_CHECKING([if malloc debugging is wanted])
 AC_ARG_WITH(dmalloc,
-[  --with-dmalloc          use dmalloc, as in
-			  http://www.dmalloc.com/dmalloc.tar.gz],
+[  --with-dmalloc          use dmalloc, as in http://www.dmalloc.com],
 [if test "$withval" = yes; then
   AC_MSG_RESULT(yes)
   AC_DEFINE(WITH_DMALLOC,1,
@@ -573,12 +582,15 @@ for _am_header in $config_headers :; do
 done
 echo "timestamp for $_am_arg" >`AS_DIRNAME(["$_am_arg"])`/stamp-h[]$_am_stamp_count])
 
-# Copyright (C) 2001, 2003, 2005, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2001, 2003, 2005, 2008, 2011 Free Software Foundation,
+# Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
+# serial 1
+
 # AM_PROG_INSTALL_SH
 # ------------------
 # Define $install_sh.
@@ -618,8 +630,8 @@ AC_SUBST([am__leading_dot])])
 # Add --enable-maintainer-mode option to configure.         -*- Autoconf -*-
 # From Jim Meyering
 
-# Copyright (C) 1996, 1998, 2000, 2001, 2002, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1996, 1998, 2000, 2001, 2002, 2003, 2004, 2005, 2008,
+# 2011 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -639,7 +651,7 @@ AC_DEFUN([AM_MAINTAINER_MODE],
        [disable], [m4_define([am_maintainer_other], [enable])],
        [m4_define([am_maintainer_other], [enable])
         m4_warn([syntax], [unexpected argument to AM@&t@_MAINTAINER_MODE: $1])])
-AC_MSG_CHECKING([whether to am_maintainer_other maintainer-specific portions of Makefiles])
+AC_MSG_CHECKING([whether to enable maintainer-specific portions of Makefiles])
   dnl maintainer-mode's default is 'disable' unless 'enable' is passed
   AC_ARG_ENABLE([maintainer-mode],
 [  --][am_maintainer_other][-maintainer-mode  am_maintainer_other make rules and dependencies not useful
@@ -750,12 +762,15 @@ else
 fi
 ])
 
-# Copyright (C) 2003, 2004, 2005, 2006  Free Software Foundation, Inc.
+# Copyright (C) 2003, 2004, 2005, 2006, 2011 Free Software Foundation,
+# Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
+# serial 1
+
 # AM_PROG_MKDIR_P
 # ---------------
 # Check for `mkdir -p'.
@@ -778,13 +793,14 @@ esac
 
 # Helper functions for option handling.                     -*- Autoconf -*-
 
-# Copyright (C) 2001, 2002, 2003, 2005, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2001, 2002, 2003, 2005, 2008, 2010 Free Software
+# Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 4
+# serial 5
 
 # _AM_MANGLE_OPTION(NAME)
 # -----------------------
@@ -792,13 +808,13 @@ AC_DEFUN([_AM_MANGLE_OPTION],
 [[_AM_OPTION_]m4_bpatsubst($1, [[^a-zA-Z0-9_]], [_])])
 
 # _AM_SET_OPTION(NAME)
-# ------------------------------
+# --------------------
 # Set option NAME.  Presently that only means defining a flag for this option.
 AC_DEFUN([_AM_SET_OPTION],
 [m4_define(_AM_MANGLE_OPTION([$1]), 1)])
 
 # _AM_SET_OPTIONS(OPTIONS)
-# ----------------------------------
+# ------------------------
 # OPTIONS is a space-separated list of Automake options.
 AC_DEFUN([_AM_SET_OPTIONS],
 [m4_foreach_w([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
@@ -874,12 +890,14 @@ Check your system clock])
 fi
 AC_MSG_RESULT(yes)])
 
-# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+# Copyright (C) 2001, 2003, 2005, 2011 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
+# serial 1
+
 # AM_PROG_INSTALL_STRIP
 # ---------------------
 # One issue with vendor `install' (even GNU) is that you can't
@@ -902,13 +920,13 @@ fi
 INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
 AC_SUBST([INSTALL_STRIP_PROGRAM])])
 
-# Copyright (C) 2006, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2006, 2008, 2010 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 2
+# serial 3
 
 # _AM_SUBST_NOTMAKE(VARIABLE)
 # ---------------------------
@@ -917,13 +935,13 @@ AC_SUBST([INSTALL_STRIP_PROGRAM])])
 AC_DEFUN([_AM_SUBST_NOTMAKE])
 
 # AM_SUBST_NOTMAKE(VARIABLE)
-# ---------------------------
+# --------------------------
 # Public sister of _AM_SUBST_NOTMAKE.
 AC_DEFUN([AM_SUBST_NOTMAKE], [_AM_SUBST_NOTMAKE($@)])
 
 # Check how to create a tarball.                            -*- Autoconf -*-
 
-# Copyright (C) 2004, 2005  Free Software Foundation, Inc.
+# Copyright (C) 2004, 2005, 2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -945,10 +963,11 @@ AC_DEFUN([AM_SUBST_NOTMAKE], [_AM_SUBST_NOTMAKE($@)])
 # a tarball read from stdin.
 #     $(am__untar) < result.tar
 AC_DEFUN([_AM_PROG_TAR],
-[# Always define AMTAR for backward compatibility.
-AM_MISSING_PROG([AMTAR], [tar])
+[# Always define AMTAR for backward compatibility.  Yes, it's still used
+# in the wild :-(  We should find a proper way to deprecate it ...
+AC_SUBST([AMTAR], ['$${TAR-tar}'])
 m4_if([$1], [v7],
-     [am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'],
+     [am__tar='$${TAR-tar} chof - "$$tardir"' am__untar='$${TAR-tar} xf -'],
      [m4_case([$1], [ustar],, [pax],,
               [m4_fatal([Unknown tar format])])
 AC_MSG_CHECKING([how to create a $1 tar archive])
diff --git a/autotools/config.guess b/autotools/config.guess
index e3a2116..d622a44 100755
--- a/autotools/config.guess
+++ b/autotools/config.guess
@@ -1,10 +1,10 @@
 #! /bin/sh
 # Attempt to guess a canonical system name.
 #   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
-#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009
-#   Free Software Foundation, Inc.
+#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
+#   2011, 2012 Free Software Foundation, Inc.
 
-timestamp='2009-06-10'
+timestamp='2012-02-10'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -17,9 +17,7 @@ timestamp='2009-06-10'
 # General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
-# 02110-1301, USA.
+# along with this program; if not, see <http://www.gnu.org/licenses/>.
 #
 # As a special exception to the GNU General Public License, if you
 # distribute this file as part of a program that contains a
@@ -27,16 +25,16 @@ timestamp='2009-06-10'
 # the same distribution terms that you use for the rest of that program.
 
 
-# Originally written by Per Bothner <per@bothner.com>.
-# Please send patches to <config-patches@gnu.org>.  Submit a context
-# diff and a properly formatted ChangeLog entry.
+# Originally written by Per Bothner.  Please send patches (context
+# diff format) to <config-patches@gnu.org> and include a ChangeLog
+# entry.
 #
 # This script attempts to guess a canonical system name similar to
 # config.sub.  If it succeeds, it prints the system name on stdout, and
 # exits with 0.  Otherwise, it exits with 1.
 #
-# The plan is that this can be called by configure scripts if you
-# don't specify an explicit build system type.
+# You can get the latest version of this script from:
+# http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD
 
 me=`echo "$0" | sed -e 's,.*/,,'`
 
@@ -56,8 +54,9 @@ version="\
 GNU config.guess ($timestamp)
 
 Originally written by Per Bothner.
-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001,
-2002, 2003, 2004, 2005, 2006, 2007, 2008 Free Software Foundation, Inc.
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
+2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012
+Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
@@ -144,7 +143,7 @@ UNAME_VERSION=`(uname -v) 2>/dev/null` || UNAME_VERSION=unknown
 case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
     *:NetBSD:*:*)
 	# NetBSD (nbsd) targets should (where applicable) match one or
-	# more of the tupples: *-*-netbsdelf*, *-*-netbsdaout*,
+	# more of the tuples: *-*-netbsdelf*, *-*-netbsdaout*,
 	# *-*-netbsdecoff* and *-*-netbsd*.  For targets that recently
 	# switched to ELF, *-*-netbsd* would select the old
 	# object file format.  This provides both forward
@@ -180,7 +179,7 @@ case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
 		fi
 		;;
 	    *)
-	        os=netbsd
+		os=netbsd
 		;;
 	esac
 	# The OS release
@@ -223,7 +222,7 @@ case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
 		UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $3}'`
 		;;
 	*5.*)
-	        UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $4}'`
+		UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $4}'`
 		;;
 	esac
 	# According to Compaq, /usr/sbin/psrinfo has been available on
@@ -269,7 +268,10 @@ case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
 	# A Xn.n version is an unreleased experimental baselevel.
 	# 1.2 uses "1.2" for uname -r.
 	echo ${UNAME_MACHINE}-dec-osf`echo ${UNAME_RELEASE} | sed -e 's/^[PVTX]//' | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
-	exit ;;
+	# Reset EXIT trap before exiting to avoid spurious non-zero exit code.
+	exitcode=$?
+	trap '' 0
+	exit $exitcode ;;
     Alpha\ *:Windows_NT*:*)
 	# How do we know it's Interix rather than the generic POSIX subsystem?
 	# Should we change UNAME_MACHINE based on the output of uname instead
@@ -295,7 +297,7 @@ case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
 	echo s390-ibm-zvmoe
 	exit ;;
     *:OS400:*:*)
-        echo powerpc-ibm-os400
+	echo powerpc-ibm-os400
 	exit ;;
     arm:RISC*:1.[012]*:*|arm:riscix:1.[012]*:*)
 	echo arm-acorn-riscix${UNAME_RELEASE}
@@ -333,6 +335,9 @@ case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
     sun4*:SunOS:5.*:* | tadpole*:SunOS:5.*:*)
 	echo sparc-sun-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
 	exit ;;
+    i86pc:AuroraUX:5.*:* | i86xen:AuroraUX:5.*:*)
+	echo i386-pc-auroraux${UNAME_RELEASE}
+	exit ;;
     i86pc:SunOS:5.*:* | i86xen:SunOS:5.*:*)
 	eval $set_cc_for_build
 	SUN_ARCH="i386"
@@ -391,23 +396,23 @@ case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
     # MiNT.  But MiNT is downward compatible to TOS, so this should
     # be no problem.
     atarist[e]:*MiNT:*:* | atarist[e]:*mint:*:* | atarist[e]:*TOS:*:*)
-        echo m68k-atari-mint${UNAME_RELEASE}
+	echo m68k-atari-mint${UNAME_RELEASE}
 	exit ;;
     atari*:*MiNT:*:* | atari*:*mint:*:* | atarist[e]:*TOS:*:*)
 	echo m68k-atari-mint${UNAME_RELEASE}
-        exit ;;
+	exit ;;
     *falcon*:*MiNT:*:* | *falcon*:*mint:*:* | *falcon*:*TOS:*:*)
-        echo m68k-atari-mint${UNAME_RELEASE}
+	echo m68k-atari-mint${UNAME_RELEASE}
 	exit ;;
     milan*:*MiNT:*:* | milan*:*mint:*:* | *milan*:*TOS:*:*)
-        echo m68k-milan-mint${UNAME_RELEASE}
-        exit ;;
+	echo m68k-milan-mint${UNAME_RELEASE}
+	exit ;;
     hades*:*MiNT:*:* | hades*:*mint:*:* | *hades*:*TOS:*:*)
-        echo m68k-hades-mint${UNAME_RELEASE}
-        exit ;;
+	echo m68k-hades-mint${UNAME_RELEASE}
+	exit ;;
     *:*MiNT:*:* | *:*mint:*:* | *:*TOS:*:*)
-        echo m68k-unknown-mint${UNAME_RELEASE}
-        exit ;;
+	echo m68k-unknown-mint${UNAME_RELEASE}
+	exit ;;
     m68k:machten:*:*)
 	echo m68k-apple-machten${UNAME_RELEASE}
 	exit ;;
@@ -477,8 +482,8 @@ EOF
 	echo m88k-motorola-sysv3
 	exit ;;
     AViiON:dgux:*:*)
-        # DG/UX returns AViiON for all architectures
-        UNAME_PROCESSOR=`/usr/bin/uname -p`
+	# DG/UX returns AViiON for all architectures
+	UNAME_PROCESSOR=`/usr/bin/uname -p`
 	if [ $UNAME_PROCESSOR = mc88100 ] || [ $UNAME_PROCESSOR = mc88110 ]
 	then
 	    if [ ${TARGET_BINARY_INTERFACE}x = m88kdguxelfx ] || \
@@ -491,7 +496,7 @@ EOF
 	else
 	    echo i586-dg-dgux${UNAME_RELEASE}
 	fi
- 	exit ;;
+	exit ;;
     M88*:DolphinOS:*:*)	# DolphinOS (SVR3)
 	echo m88k-dolphin-sysv3
 	exit ;;
@@ -548,7 +553,7 @@ EOF
 		echo rs6000-ibm-aix3.2
 	fi
 	exit ;;
-    *:AIX:*:[456])
+    *:AIX:*:[4567])
 	IBM_CPU_ID=`/usr/sbin/lsdev -C -c processor -S available | sed 1q | awk '{ print $1 }'`
 	if /usr/sbin/lsattr -El ${IBM_CPU_ID} | grep ' POWER' >/dev/null 2>&1; then
 		IBM_ARCH=rs6000
@@ -591,52 +596,52 @@ EOF
 	    9000/[678][0-9][0-9])
 		if [ -x /usr/bin/getconf ]; then
 		    sc_cpu_version=`/usr/bin/getconf SC_CPU_VERSION 2>/dev/null`
-                    sc_kernel_bits=`/usr/bin/getconf SC_KERNEL_BITS 2>/dev/null`
-                    case "${sc_cpu_version}" in
-                      523) HP_ARCH="hppa1.0" ;; # CPU_PA_RISC1_0
-                      528) HP_ARCH="hppa1.1" ;; # CPU_PA_RISC1_1
-                      532)                      # CPU_PA_RISC2_0
-                        case "${sc_kernel_bits}" in
-                          32) HP_ARCH="hppa2.0n" ;;
-                          64) HP_ARCH="hppa2.0w" ;;
+		    sc_kernel_bits=`/usr/bin/getconf SC_KERNEL_BITS 2>/dev/null`
+		    case "${sc_cpu_version}" in
+		      523) HP_ARCH="hppa1.0" ;; # CPU_PA_RISC1_0
+		      528) HP_ARCH="hppa1.1" ;; # CPU_PA_RISC1_1
+		      532)                      # CPU_PA_RISC2_0
+			case "${sc_kernel_bits}" in
+			  32) HP_ARCH="hppa2.0n" ;;
+			  64) HP_ARCH="hppa2.0w" ;;
 			  '') HP_ARCH="hppa2.0" ;;   # HP-UX 10.20
-                        esac ;;
-                    esac
+			esac ;;
+		    esac
 		fi
 		if [ "${HP_ARCH}" = "" ]; then
 		    eval $set_cc_for_build
-		    sed 's/^              //' << EOF >$dummy.c
+		    sed 's/^		//' << EOF >$dummy.c
 
-              #define _HPUX_SOURCE
-              #include <stdlib.h>
-              #include <unistd.h>
+		#define _HPUX_SOURCE
+		#include <stdlib.h>
+		#include <unistd.h>
 
-              int main ()
-              {
-              #if defined(_SC_KERNEL_BITS)
-                  long bits = sysconf(_SC_KERNEL_BITS);
-              #endif
-                  long cpu  = sysconf (_SC_CPU_VERSION);
+		int main ()
+		{
+		#if defined(_SC_KERNEL_BITS)
+		    long bits = sysconf(_SC_KERNEL_BITS);
+		#endif
+		    long cpu  = sysconf (_SC_CPU_VERSION);
 
-                  switch (cpu)
-              	{
-              	case CPU_PA_RISC1_0: puts ("hppa1.0"); break;
-              	case CPU_PA_RISC1_1: puts ("hppa1.1"); break;
-              	case CPU_PA_RISC2_0:
-              #if defined(_SC_KERNEL_BITS)
-              	    switch (bits)
-              		{
-              		case 64: puts ("hppa2.0w"); break;
-              		case 32: puts ("hppa2.0n"); break;
-              		default: puts ("hppa2.0"); break;
-              		} break;
-              #else  /* !defined(_SC_KERNEL_BITS) */
-              	    puts ("hppa2.0"); break;
-              #endif
-              	default: puts ("hppa1.0"); break;
-              	}
-                  exit (0);
-              }
+		    switch (cpu)
+			{
+			case CPU_PA_RISC1_0: puts ("hppa1.0"); break;
+			case CPU_PA_RISC1_1: puts ("hppa1.1"); break;
+			case CPU_PA_RISC2_0:
+		#if defined(_SC_KERNEL_BITS)
+			    switch (bits)
+				{
+				case 64: puts ("hppa2.0w"); break;
+				case 32: puts ("hppa2.0n"); break;
+				default: puts ("hppa2.0"); break;
+				} break;
+		#else  /* !defined(_SC_KERNEL_BITS) */
+			    puts ("hppa2.0"); break;
+		#endif
+			default: puts ("hppa1.0"); break;
+			}
+		    exit (0);
+		}
 EOF
 		    (CCOPTS= $CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null) && HP_ARCH=`$dummy`
 		    test -z "$HP_ARCH" && HP_ARCH=hppa
@@ -727,22 +732,22 @@ EOF
 	exit ;;
     C1*:ConvexOS:*:* | convex:ConvexOS:C1*:*)
 	echo c1-convex-bsd
-        exit ;;
+	exit ;;
     C2*:ConvexOS:*:* | convex:ConvexOS:C2*:*)
 	if getsysinfo -f scalar_acc
 	then echo c32-convex-bsd
 	else echo c2-convex-bsd
 	fi
-        exit ;;
+	exit ;;
     C34*:ConvexOS:*:* | convex:ConvexOS:C34*:*)
 	echo c34-convex-bsd
-        exit ;;
+	exit ;;
     C38*:ConvexOS:*:* | convex:ConvexOS:C38*:*)
 	echo c38-convex-bsd
-        exit ;;
+	exit ;;
     C4*:ConvexOS:*:* | convex:ConvexOS:C4*:*)
 	echo c4-convex-bsd
-        exit ;;
+	exit ;;
     CRAY*Y-MP:*:*:*)
 	echo ymp-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
 	exit ;;
@@ -766,14 +771,14 @@ EOF
 	exit ;;
     F30[01]:UNIX_System_V:*:* | F700:UNIX_System_V:*:*)
 	FUJITSU_PROC=`uname -m | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
-        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
-        FUJITSU_REL=`echo ${UNAME_RELEASE} | sed -e 's/ /_/'`
-        echo "${FUJITSU_PROC}-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
-        exit ;;
+	FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
+	FUJITSU_REL=`echo ${UNAME_RELEASE} | sed -e 's/ /_/'`
+	echo "${FUJITSU_PROC}-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
+	exit ;;
     5000:UNIX_System_V:4.*:*)
-        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
-        FUJITSU_REL=`echo ${UNAME_RELEASE} | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/ /_/'`
-        echo "sparc-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
+	FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
+	FUJITSU_REL=`echo ${UNAME_RELEASE} | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/ /_/'`
+	echo "sparc-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
 	exit ;;
     i*86:BSD/386:*:* | i*86:BSD/OS:*:* | *:Ascend\ Embedded/OS:*:*)
 	echo ${UNAME_MACHINE}-pc-bsdi${UNAME_RELEASE}
@@ -785,13 +790,12 @@ EOF
 	echo ${UNAME_MACHINE}-unknown-bsdi${UNAME_RELEASE}
 	exit ;;
     *:FreeBSD:*:*)
-	case ${UNAME_MACHINE} in
-	    pc98)
-		echo i386-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
+	UNAME_PROCESSOR=`/usr/bin/uname -p`
+	case ${UNAME_PROCESSOR} in
 	    amd64)
 		echo x86_64-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
 	    *)
-		echo ${UNAME_MACHINE}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
+		echo ${UNAME_PROCESSOR}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
 	esac
 	exit ;;
     i*:CYGWIN*:*)
@@ -800,19 +804,22 @@ EOF
     *:MINGW*:*)
 	echo ${UNAME_MACHINE}-pc-mingw32
 	exit ;;
+    i*:MSYS*:*)
+	echo ${UNAME_MACHINE}-pc-msys
+	exit ;;
     i*:windows32*:*)
-    	# uname -m includes "-pc" on this system.
-    	echo ${UNAME_MACHINE}-mingw32
+	# uname -m includes "-pc" on this system.
+	echo ${UNAME_MACHINE}-mingw32
 	exit ;;
     i*:PW*:*)
 	echo ${UNAME_MACHINE}-pc-pw32
 	exit ;;
-    *:Interix*:[3456]*)
-    	case ${UNAME_MACHINE} in
+    *:Interix*:*)
+	case ${UNAME_MACHINE} in
 	    x86)
 		echo i586-pc-interix${UNAME_RELEASE}
 		exit ;;
-	    EM64T | authenticamd | genuineintel)
+	    authenticamd | genuineintel | EM64T)
 		echo x86_64-unknown-interix${UNAME_RELEASE}
 		exit ;;
 	    IA64)
@@ -854,6 +861,27 @@ EOF
     i*86:Minix:*:*)
 	echo ${UNAME_MACHINE}-pc-minix
 	exit ;;
+    aarch64:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit ;;
+    aarch64_be:Linux:*:*)
+	UNAME_MACHINE=aarch64_be
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit ;;
+    alpha:Linux:*:*)
+	case `sed -n '/^cpu model/s/^.*: \(.*\)/\1/p' < /proc/cpuinfo` in
+	  EV5)   UNAME_MACHINE=alphaev5 ;;
+	  EV56)  UNAME_MACHINE=alphaev56 ;;
+	  PCA56) UNAME_MACHINE=alphapca56 ;;
+	  PCA57) UNAME_MACHINE=alphapca56 ;;
+	  EV6)   UNAME_MACHINE=alphaev6 ;;
+	  EV67)  UNAME_MACHINE=alphaev67 ;;
+	  EV68*) UNAME_MACHINE=alphaev68 ;;
+	esac
+	objdump --private-headers /bin/sh | grep -q ld.so.1
+	if test "$?" = 0 ; then LIBC="libc1" ; else LIBC="" ; fi
+	echo ${UNAME_MACHINE}-unknown-linux-gnu${LIBC}
+	exit ;;
     arm*:Linux:*:*)
 	eval $set_cc_for_build
 	if echo __ARM_EABI__ | $CC_FOR_BUILD -E - 2>/dev/null \
@@ -861,20 +889,40 @@ EOF
 	then
 	    echo ${UNAME_MACHINE}-unknown-linux-gnu
 	else
-	    echo ${UNAME_MACHINE}-unknown-linux-gnueabi
+	    if echo __ARM_PCS_VFP | $CC_FOR_BUILD -E - 2>/dev/null \
+		| grep -q __ARM_PCS_VFP
+	    then
+		echo ${UNAME_MACHINE}-unknown-linux-gnueabi
+	    else
+		echo ${UNAME_MACHINE}-unknown-linux-gnueabihf
+	    fi
 	fi
 	exit ;;
     avr32*:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
 	exit ;;
     cris:Linux:*:*)
-	echo cris-axis-linux-gnu
+	echo ${UNAME_MACHINE}-axis-linux-gnu
 	exit ;;
     crisv32:Linux:*:*)
-	echo crisv32-axis-linux-gnu
+	echo ${UNAME_MACHINE}-axis-linux-gnu
 	exit ;;
     frv:Linux:*:*)
-    	echo frv-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit ;;
+    hexagon:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit ;;
+    i*86:Linux:*:*)
+	LIBC=gnu
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+	#ifdef __dietlibc__
+	LIBC=dietlibc
+	#endif
+EOF
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^LIBC'`
+	echo "${UNAME_MACHINE}-pc-linux-${LIBC}"
 	exit ;;
     ia64:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
@@ -901,39 +949,18 @@ EOF
 	#endif
 	#endif
 EOF
-	eval "`$CC_FOR_BUILD -E $dummy.c 2>/dev/null | sed -n '
-	    /^CPU/{
-		s: ::g
-		p
-	    }'`"
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^CPU'`
 	test x"${CPU}" != x && { echo "${CPU}-unknown-linux-gnu"; exit; }
 	;;
     or32:Linux:*:*)
-	echo or32-unknown-linux-gnu
-	exit ;;
-    ppc:Linux:*:*)
-	echo powerpc-unknown-linux-gnu
-	exit ;;
-    ppc64:Linux:*:*)
-	echo powerpc64-unknown-linux-gnu
-	exit ;;
-    alpha:Linux:*:*)
-	case `sed -n '/^cpu model/s/^.*: \(.*\)/\1/p' < /proc/cpuinfo` in
-	  EV5)   UNAME_MACHINE=alphaev5 ;;
-	  EV56)  UNAME_MACHINE=alphaev56 ;;
-	  PCA56) UNAME_MACHINE=alphapca56 ;;
-	  PCA57) UNAME_MACHINE=alphapca56 ;;
-	  EV6)   UNAME_MACHINE=alphaev6 ;;
-	  EV67)  UNAME_MACHINE=alphaev67 ;;
-	  EV68*) UNAME_MACHINE=alphaev68 ;;
-        esac
-	objdump --private-headers /bin/sh | grep -q ld.so.1
-	if test "$?" = 0 ; then LIBC="libc1" ; else LIBC="" ; fi
-	echo ${UNAME_MACHINE}-unknown-linux-gnu${LIBC}
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
 	exit ;;
     padre:Linux:*:*)
 	echo sparc-unknown-linux-gnu
 	exit ;;
+    parisc64:Linux:*:* | hppa64:Linux:*:*)
+	echo hppa64-unknown-linux-gnu
+	exit ;;
     parisc:Linux:*:* | hppa:Linux:*:*)
 	# Look for CPU level
 	case `grep '^cpu[^a-z]*:' /proc/cpuinfo 2>/dev/null | cut -d' ' -f2` in
@@ -942,14 +969,17 @@ EOF
 	  *)    echo hppa-unknown-linux-gnu ;;
 	esac
 	exit ;;
-    parisc64:Linux:*:* | hppa64:Linux:*:*)
-	echo hppa64-unknown-linux-gnu
+    ppc64:Linux:*:*)
+	echo powerpc64-unknown-linux-gnu
+	exit ;;
+    ppc:Linux:*:*)
+	echo powerpc-unknown-linux-gnu
 	exit ;;
     s390:Linux:*:* | s390x:Linux:*:*)
 	echo ${UNAME_MACHINE}-ibm-linux
 	exit ;;
     sh64*:Linux:*:*)
-    	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
 	exit ;;
     sh*:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
@@ -957,67 +987,18 @@ EOF
     sparc:Linux:*:* | sparc64:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-gnu
 	exit ;;
+    tile*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit ;;
     vax:Linux:*:*)
 	echo ${UNAME_MACHINE}-dec-linux-gnu
 	exit ;;
     x86_64:Linux:*:*)
-	echo x86_64-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
 	exit ;;
     xtensa*:Linux:*:*)
-    	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
 	exit ;;
-    i*86:Linux:*:*)
-	# The BFD linker knows what the default object file format is, so
-	# first see if it will tell us. cd to the root directory to prevent
-	# problems with other programs or directories called `ld' in the path.
-	# Set LC_ALL=C to ensure ld outputs messages in English.
-	ld_supported_targets=`cd /; LC_ALL=C ld --help 2>&1 \
-			 | sed -ne '/supported targets:/!d
-				    s/[ 	][ 	]*/ /g
-				    s/.*supported targets: *//
-				    s/ .*//
-				    p'`
-        case "$ld_supported_targets" in
-	  elf32-i386)
-		TENTATIVE="${UNAME_MACHINE}-pc-linux-gnu"
-		;;
-	esac
-	# Determine whether the default compiler is a.out or elf
-	eval $set_cc_for_build
-	sed 's/^	//' << EOF >$dummy.c
-	#include <features.h>
-	#ifdef __ELF__
-	# ifdef __GLIBC__
-	#  if __GLIBC__ >= 2
-	LIBC=gnu
-	#  else
-	LIBC=gnulibc1
-	#  endif
-	# else
-	LIBC=gnulibc1
-	# endif
-	#else
-	#if defined(__INTEL_COMPILER) || defined(__PGI) || defined(__SUNPRO_C) || defined(__SUNPRO_CC)
-	LIBC=gnu
-	#else
-	LIBC=gnuaout
-	#endif
-	#endif
-	#ifdef __dietlibc__
-	LIBC=dietlibc
-	#endif
-EOF
-	eval "`$CC_FOR_BUILD -E $dummy.c 2>/dev/null | sed -n '
-	    /^LIBC/{
-		s: ::g
-		p
-	    }'`"
-	test x"${LIBC}" != x && {
-		echo "${UNAME_MACHINE}-pc-linux-${LIBC}"
-		exit
-	}
-	test x"${TENTATIVE}" != x && { echo "${TENTATIVE}"; exit; }
-	;;
     i*86:DYNIX/ptx:4*:*)
 	# ptx 4.0 does uname -s correctly, with DYNIX/ptx in there.
 	# earlier versions are messed up and put the nodename in both
@@ -1025,11 +1006,11 @@ EOF
 	echo i386-sequent-sysv4
 	exit ;;
     i*86:UNIX_SV:4.2MP:2.*)
-        # Unixware is an offshoot of SVR4, but it has its own version
-        # number series starting with 2...
-        # I am not positive that other SVR4 systems won't match this,
+	# Unixware is an offshoot of SVR4, but it has its own version
+	# number series starting with 2...
+	# I am not positive that other SVR4 systems won't match this,
 	# I just have to hope.  -- rms.
-        # Use sysv4.2uw... so that sysv4* matches it.
+	# Use sysv4.2uw... so that sysv4* matches it.
 	echo ${UNAME_MACHINE}-pc-sysv4.2uw${UNAME_VERSION}
 	exit ;;
     i*86:OS/2:*:*)
@@ -1061,7 +1042,7 @@ EOF
 	fi
 	exit ;;
     i*86:*:5:[678]*)
-    	# UnixWare 7.x, OpenUNIX and OpenServer 6.
+	# UnixWare 7.x, OpenUNIX and OpenServer 6.
 	case `/bin/uname -X | grep "^Machine"` in
 	    *486*)	     UNAME_MACHINE=i486 ;;
 	    *Pentium)	     UNAME_MACHINE=i586 ;;
@@ -1089,13 +1070,13 @@ EOF
 	exit ;;
     pc:*:*:*)
 	# Left here for compatibility:
-        # uname -m prints for DJGPP always 'pc', but it prints nothing about
-        # the processor, so we play safe by assuming i586.
+	# uname -m prints for DJGPP always 'pc', but it prints nothing about
+	# the processor, so we play safe by assuming i586.
 	# Note: whatever this is, it MUST be the same as what config.sub
 	# prints for the "djgpp" host, or else GDB configury will decide that
 	# this is a cross-build.
 	echo i586-pc-msdosdjgpp
-        exit ;;
+	exit ;;
     Intel:Mach:3*:*)
 	echo i386-pc-mach3
 	exit ;;
@@ -1130,8 +1111,8 @@ EOF
 	/bin/uname -p 2>/dev/null | /bin/grep entium >/dev/null \
 	  && { echo i586-ncr-sysv4.3${OS_REL}; exit; } ;;
     3[34]??:*:4.0:* | 3[34]??,*:*:4.0:*)
-        /bin/uname -p 2>/dev/null | grep 86 >/dev/null \
-          && { echo i486-ncr-sysv4; exit; } ;;
+	/bin/uname -p 2>/dev/null | grep 86 >/dev/null \
+	  && { echo i486-ncr-sysv4; exit; } ;;
     NCR*:*:4.2:* | MPRAS*:*:4.2:*)
 	OS_REL='.3'
 	test -r /etc/.relid \
@@ -1174,10 +1155,10 @@ EOF
 		echo ns32k-sni-sysv
 	fi
 	exit ;;
-    PENTIUM:*:4.0*:*) # Unisys `ClearPath HMP IX 4000' SVR4/MP effort
-                      # says <Richard.M.Bartel@ccMail.Census.GOV>
-        echo i586-unisys-sysv4
-        exit ;;
+    PENTIUM:*:4.0*:*)	# Unisys `ClearPath HMP IX 4000' SVR4/MP effort
+			# says <Richard.M.Bartel@ccMail.Census.GOV>
+	echo i586-unisys-sysv4
+	exit ;;
     *:UNIX_System_V:4*:FTX*)
 	# From Gerald Hewes <hewes@openmarket.com>.
 	# How about differentiating between stratus architectures? -djm
@@ -1203,11 +1184,11 @@ EOF
 	exit ;;
     R[34]000:*System_V*:*:* | R4000:UNIX_SYSV:*:* | R*000:UNIX_SV:*:*)
 	if [ -d /usr/nec ]; then
-	        echo mips-nec-sysv${UNAME_RELEASE}
+		echo mips-nec-sysv${UNAME_RELEASE}
 	else
-	        echo mips-unknown-sysv${UNAME_RELEASE}
+		echo mips-unknown-sysv${UNAME_RELEASE}
 	fi
-        exit ;;
+	exit ;;
     BeBox:BeOS:*:*)	# BeOS running on hardware made by Be, PPC only.
 	echo powerpc-be-beos
 	exit ;;
@@ -1247,6 +1228,16 @@ EOF
     *:Darwin:*:*)
 	UNAME_PROCESSOR=`uname -p` || UNAME_PROCESSOR=unknown
 	case $UNAME_PROCESSOR in
+	    i386)
+		eval $set_cc_for_build
+		if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
+		  if (echo '#ifdef __LP64__'; echo IS_64BIT_ARCH; echo '#endif') | \
+		      (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
+		      grep IS_64BIT_ARCH >/dev/null
+		  then
+		      UNAME_PROCESSOR="x86_64"
+		  fi
+		fi ;;
 	    unknown) UNAME_PROCESSOR=powerpc ;;
 	esac
 	echo ${UNAME_PROCESSOR}-apple-darwin${UNAME_RELEASE}
@@ -1262,6 +1253,9 @@ EOF
     *:QNX:*:4*)
 	echo i386-pc-qnx
 	exit ;;
+    NEO-?:NONSTOP_KERNEL:*:*)
+	echo neo-tandem-nsk${UNAME_RELEASE}
+	exit ;;
     NSE-?:NONSTOP_KERNEL:*:*)
 	echo nse-tandem-nsk${UNAME_RELEASE}
 	exit ;;
@@ -1307,13 +1301,13 @@ EOF
 	echo pdp10-unknown-its
 	exit ;;
     SEI:*:*:SEIUX)
-        echo mips-sei-seiux${UNAME_RELEASE}
+	echo mips-sei-seiux${UNAME_RELEASE}
 	exit ;;
     *:DragonFly:*:*)
 	echo ${UNAME_MACHINE}-unknown-dragonfly`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`
 	exit ;;
     *:*VMS:*:*)
-    	UNAME_MACHINE=`(uname -p) 2>/dev/null`
+	UNAME_MACHINE=`(uname -p) 2>/dev/null`
 	case "${UNAME_MACHINE}" in
 	    A*) echo alpha-dec-vms ; exit ;;
 	    I*) echo ia64-dec-vms ; exit ;;
@@ -1331,6 +1325,9 @@ EOF
     i*86:AROS:*:*)
 	echo ${UNAME_MACHINE}-pc-aros
 	exit ;;
+    x86_64:VMkernel:*:*)
+	echo ${UNAME_MACHINE}-unknown-esx
+	exit ;;
 esac
 
 #echo '(No uname command or uname output not recognized.)' 1>&2
@@ -1353,11 +1350,11 @@ main ()
 #include <sys/param.h>
   printf ("m68k-sony-newsos%s\n",
 #ifdef NEWSOS4
-          "4"
+	"4"
 #else
-	  ""
+	""
 #endif
-         ); exit (0);
+	); exit (0);
 #endif
 #endif
 
diff --git a/autotools/config.sub b/autotools/config.sub
index eb0389a..c894da4 100755
--- a/autotools/config.sub
+++ b/autotools/config.sub
@@ -1,10 +1,10 @@
 #! /bin/sh
 # Configuration validation subroutine script.
 #   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
-#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009
-#   Free Software Foundation, Inc.
+#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010,
+#   2011, 2012 Free Software Foundation, Inc.
 
-timestamp='2009-06-11'
+timestamp='2012-02-10'
 
 # This file is (in principle) common to ALL GNU software.
 # The presence of a machine in this file suggests that SOME GNU software
@@ -21,9 +21,7 @@ timestamp='2009-06-11'
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
-# 02110-1301, USA.
+# along with this program; if not, see <http://www.gnu.org/licenses/>.
 #
 # As a special exception to the GNU General Public License, if you
 # distribute this file as part of a program that contains a
@@ -32,13 +30,16 @@ timestamp='2009-06-11'
 
 
 # Please send patches to <config-patches@gnu.org>.  Submit a context
-# diff and a properly formatted ChangeLog entry.
+# diff and a properly formatted GNU ChangeLog entry.
 #
 # Configuration subroutine to validate and canonicalize a configuration type.
 # Supply the specified configuration type as an argument.
 # If it is invalid, we print an error message on stderr and exit with code 1.
 # Otherwise, we print the canonical config type on stdout and succeed.
 
+# You can get the latest version of this script from:
+# http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD
+
 # This file is supposed to be the same for all GNU packages
 # and recognize all the CPU types, system types and aliases
 # that are meaningful with *any* GNU software.
@@ -72,8 +73,9 @@ Report bugs and patches to <config-patches@gnu.org>."
 version="\
 GNU config.sub ($timestamp)
 
-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001,
-2002, 2003, 2004, 2005, 2006, 2007, 2008 Free Software Foundation, Inc.
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
+2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012
+Free Software Foundation, Inc.
 
 This is free software; see the source for copying conditions.  There is NO
 warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
@@ -120,13 +122,18 @@ esac
 # Here we must recognize all the valid KERNEL-OS combinations.
 maybe_os=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\2/'`
 case $maybe_os in
-  nto-qnx* | linux-gnu* | linux-dietlibc | linux-newlib* | linux-uclibc* | \
-  uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | knetbsd*-gnu* | netbsd*-gnu* | \
+  nto-qnx* | linux-gnu* | linux-android* | linux-dietlibc | linux-newlib* | \
+  linux-uclibc* | uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | \
+  knetbsd*-gnu* | netbsd*-gnu* | \
   kopensolaris*-gnu* | \
   storm-chaos* | os2-emx* | rtmk-nova*)
     os=-$maybe_os
     basic_machine=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\1/'`
     ;;
+  android-linux)
+    os=-linux-android
+    basic_machine=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\1/'`-unknown
+    ;;
   *)
     basic_machine=`echo $1 | sed 's/-[^-]*$//'`
     if [ $basic_machine != $1 ]
@@ -149,12 +156,12 @@ case $os in
 	-convergent* | -ncr* | -news | -32* | -3600* | -3100* | -hitachi* |\
 	-c[123]* | -convex* | -sun | -crds | -omron* | -dg | -ultra | -tti* | \
 	-harris | -dolphin | -highlevel | -gould | -cbm | -ns | -masscomp | \
-	-apple | -axis | -knuth | -cray)
+	-apple | -axis | -knuth | -cray | -microblaze)
 		os=
 		basic_machine=$1
 		;;
-        -bluegene*)
-	        os=-cnk
+	-bluegene*)
+		os=-cnk
 		;;
 	-sim | -cisco | -oki | -wec | -winbond)
 		os=
@@ -170,10 +177,10 @@ case $os in
 		os=-chorusos
 		basic_machine=$1
 		;;
- 	-chorusrdb)
- 		os=-chorusrdb
+	-chorusrdb)
+		os=-chorusrdb
 		basic_machine=$1
- 		;;
+		;;
 	-hiux*)
 		os=-hiuxwe2
 		;;
@@ -242,17 +249,22 @@ case $basic_machine in
 	# Some are omitted here because they have special meanings below.
 	1750a | 580 \
 	| a29k \
+	| aarch64 | aarch64_be \
 	| alpha | alphaev[4-8] | alphaev56 | alphaev6[78] | alphapca5[67] \
 	| alpha64 | alpha64ev[4-8] | alpha64ev56 | alpha64ev6[78] | alpha64pca5[67] \
 	| am33_2.0 \
 	| arc | arm | arm[bl]e | arme[lb] | armv[2345] | armv[345][lb] | avr | avr32 \
+        | be32 | be64 \
 	| bfin \
 	| c4x | clipper \
 	| d10v | d30v | dlx | dsp16xx \
+	| epiphany \
 	| fido | fr30 | frv \
 	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
+	| hexagon \
 	| i370 | i860 | i960 | ia64 \
 	| ip2k | iq2000 \
+	| le32 | le64 \
 	| lm32 \
 	| m32c | m32r | m32rle | m68000 | m68k | m88k \
 	| maxq | mb | microblaze | mcore | mep | metag \
@@ -278,27 +290,39 @@ case $basic_machine in
 	| moxie \
 	| mt \
 	| msp430 \
+	| nds32 | nds32le | nds32be \
 	| nios | nios2 \
 	| ns16k | ns32k \
+	| open8 \
 	| or32 \
 	| pdp10 | pdp11 | pj | pjl \
-	| powerpc | powerpc64 | powerpc64le | powerpcle | ppcbe \
+	| powerpc | powerpc64 | powerpc64le | powerpcle \
 	| pyramid \
+	| rl78 | rx \
 	| score \
 	| sh | sh[1234] | sh[24]a | sh[24]aeb | sh[23]e | sh[34]eb | sheb | shbe | shle | sh[1234]le | sh3ele \
 	| sh64 | sh64le \
 	| sparc | sparc64 | sparc64b | sparc64v | sparc86x | sparclet | sparclite \
 	| sparcv8 | sparcv9 | sparcv9b | sparcv9v \
-	| spu | strongarm \
-	| tahoe | thumb | tic4x | tic80 | tron \
-	| v850 | v850e \
+	| spu \
+	| tahoe | tic4x | tic54x | tic55x | tic6x | tic80 | tron \
+	| ubicom32 \
+	| v850 | v850e | v850e1 | v850e2 | v850es | v850e2v3 \
 	| we32k \
-	| x86 | xc16x | xscale | xscalee[bl] | xstormy16 | xtensa \
+	| x86 | xc16x | xstormy16 | xtensa \
 	| z8k | z80)
 		basic_machine=$basic_machine-unknown
 		;;
-	m6811 | m68hc11 | m6812 | m68hc12)
-		# Motorola 68HC11/12.
+	c54x)
+		basic_machine=tic54x-unknown
+		;;
+	c55x)
+		basic_machine=tic55x-unknown
+		;;
+	c6x)
+		basic_machine=tic6x-unknown
+		;;
+	m6811 | m68hc11 | m6812 | m68hc12 | m68hcs12x | picochip)
 		basic_machine=$basic_machine-unknown
 		os=-none
 		;;
@@ -308,6 +332,21 @@ case $basic_machine in
 		basic_machine=mt-unknown
 		;;
 
+	strongarm | thumb | xscale)
+		basic_machine=arm-unknown
+		;;
+	xgate)
+		basic_machine=$basic_machine-unknown
+		os=-none
+		;;
+	xscaleeb)
+		basic_machine=armeb-unknown
+		;;
+
+	xscaleel)
+		basic_machine=armel-unknown
+		;;
+
 	# We use `pc' rather than `unknown'
 	# because (1) that's what they normally are, and
 	# (2) the word "unknown" tends to confuse beginning users.
@@ -322,25 +361,29 @@ case $basic_machine in
 	# Recognize the basic CPU types with company name.
 	580-* \
 	| a29k-* \
+	| aarch64-* | aarch64_be-* \
 	| alpha-* | alphaev[4-8]-* | alphaev56-* | alphaev6[78]-* \
 	| alpha64-* | alpha64ev[4-8]-* | alpha64ev56-* | alpha64ev6[78]-* \
 	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* \
 	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
 	| avr-* | avr32-* \
+	| be32-* | be64-* \
 	| bfin-* | bs2000-* \
-	| c[123]* | c30-* | [cjt]90-* | c4x-* | c54x-* | c55x-* | c6x-* \
+	| c[123]* | c30-* | [cjt]90-* | c4x-* \
 	| clipper-* | craynv-* | cydra-* \
 	| d10v-* | d30v-* | dlx-* \
 	| elxsi-* \
 	| f30[01]-* | f700-* | fido-* | fr30-* | frv-* | fx80-* \
 	| h8300-* | h8500-* \
 	| hppa-* | hppa1.[01]-* | hppa2.0-* | hppa2.0[nw]-* | hppa64-* \
+	| hexagon-* \
 	| i*86-* | i860-* | i960-* | ia64-* \
 	| ip2k-* | iq2000-* \
+	| le32-* | le64-* \
 	| lm32-* \
 	| m32c-* | m32r-* | m32rle-* \
 	| m68000-* | m680[012346]0-* | m68360-* | m683?2-* | m68k-* \
-	| m88110-* | m88k-* | maxq-* | mcore-* | metag-* \
+	| m88110-* | m88k-* | maxq-* | mcore-* | metag-* | microblaze-* \
 	| mips-* | mipsbe-* | mipseb-* | mipsel-* | mipsle-* \
 	| mips16-* \
 	| mips64-* | mips64el-* \
@@ -362,24 +405,29 @@ case $basic_machine in
 	| mmix-* \
 	| mt-* \
 	| msp430-* \
+	| nds32-* | nds32le-* | nds32be-* \
 	| nios-* | nios2-* \
 	| none-* | np1-* | ns16k-* | ns32k-* \
+	| open8-* \
 	| orion-* \
 	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
-	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* | ppcbe-* \
+	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* \
 	| pyramid-* \
-	| romp-* | rs6000-* \
+	| rl78-* | romp-* | rs6000-* | rx-* \
 	| sh-* | sh[1234]-* | sh[24]a-* | sh[24]aeb-* | sh[23]e-* | sh[34]eb-* | sheb-* | shbe-* \
 	| shle-* | sh[1234]le-* | sh3ele-* | sh64-* | sh64le-* \
 	| sparc-* | sparc64-* | sparc64b-* | sparc64v-* | sparc86x-* | sparclet-* \
 	| sparclite-* \
-	| sparcv8-* | sparcv9-* | sparcv9b-* | sparcv9v-* | strongarm-* | sv1-* | sx?-* \
-	| tahoe-* | thumb-* \
-	| tic30-* | tic4x-* | tic54x-* | tic55x-* | tic6x-* | tic80-* | tile-* \
+	| sparcv8-* | sparcv9-* | sparcv9b-* | sparcv9v-* | sv1-* | sx?-* \
+	| tahoe-* \
+	| tic30-* | tic4x-* | tic54x-* | tic55x-* | tic6x-* | tic80-* \
+	| tile*-* \
 	| tron-* \
-	| v850-* | v850e-* | vax-* \
+	| ubicom32-* \
+	| v850-* | v850e-* | v850e1-* | v850es-* | v850e2-* | v850e2v3-* \
+	| vax-* \
 	| we32k-* \
-	| x86-* | x86_64-* | xc16x-* | xps100-* | xscale-* | xscalee[bl]-* \
+	| x86-* | x86_64-* | xc16x-* | xps100-* \
 	| xstormy16-* | xtensa*-* \
 	| ymp-* \
 	| z8k-* | z80-*)
@@ -404,7 +452,7 @@ case $basic_machine in
 		basic_machine=a29k-amd
 		os=-udi
 		;;
-    	abacus)
+	abacus)
 		basic_machine=abacus-unknown
 		;;
 	adobe68k)
@@ -474,11 +522,20 @@ case $basic_machine in
 		basic_machine=powerpc-ibm
 		os=-cnk
 		;;
+	c54x-*)
+		basic_machine=tic54x-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	c55x-*)
+		basic_machine=tic55x-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	c6x-*)
+		basic_machine=tic6x-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
 	c90)
 		basic_machine=c90-cray
 		os=-unicos
 		;;
-        cegcc)
+	cegcc)
 		basic_machine=arm-unknown
 		os=-cegcc
 		;;
@@ -510,7 +567,7 @@ case $basic_machine in
 		basic_machine=craynv-cray
 		os=-unicosmp
 		;;
-	cr16)
+	cr16 | cr16-*)
 		basic_machine=cr16-unknown
 		os=-elf
 		;;
@@ -668,7 +725,6 @@ case $basic_machine in
 	i370-ibm* | ibm*)
 		basic_machine=i370-ibm
 		;;
-# I'm not sure what "Sysv32" means.  Should this be sysv3.2?
 	i*86v32)
 		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
 		os=-sysv32
@@ -726,6 +782,9 @@ case $basic_machine in
 		basic_machine=ns32k-utek
 		os=-sysv
 		;;
+	microblaze)
+		basic_machine=microblaze-xilinx
+		;;
 	mingw32)
 		basic_machine=i386-pc
 		os=-mingw32
@@ -762,10 +821,18 @@ case $basic_machine in
 	ms1-*)
 		basic_machine=`echo $basic_machine | sed -e 's/ms1-/mt-/'`
 		;;
+	msys)
+		basic_machine=i386-pc
+		os=-msys
+		;;
 	mvs)
 		basic_machine=i370-ibm
 		os=-mvs
 		;;
+	nacl)
+		basic_machine=le32-unknown
+		os=-nacl
+		;;
 	ncr3000)
 		basic_machine=i486-ncr
 		os=-sysv4
@@ -830,6 +897,12 @@ case $basic_machine in
 	np1)
 		basic_machine=np1-gould
 		;;
+	neo-tandem)
+		basic_machine=neo-tandem
+		;;
+	nse-tandem)
+		basic_machine=nse-tandem
+		;;
 	nsr-tandem)
 		basic_machine=nsr-tandem
 		;;
@@ -912,9 +985,10 @@ case $basic_machine in
 		;;
 	power)	basic_machine=power-ibm
 		;;
-	ppc)	basic_machine=powerpc-unknown
+	ppc | ppcbe)	basic_machine=powerpc-unknown
 		;;
-	ppc-*)	basic_machine=powerpc-`echo $basic_machine | sed 's/^[^-]*-//'`
+	ppc-* | ppcbe-*)
+		basic_machine=powerpc-`echo $basic_machine | sed 's/^[^-]*-//'`
 		;;
 	ppcle | powerpclittle | ppc-le | powerpc-little)
 		basic_machine=powerpcle-unknown
@@ -1008,6 +1082,9 @@ case $basic_machine in
 		basic_machine=i860-stratus
 		os=-sysv4
 		;;
+	strongarm-* | thumb-*)
+		basic_machine=arm-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
 	sun2)
 		basic_machine=m68000-sun
 		;;
@@ -1064,20 +1141,8 @@ case $basic_machine in
 		basic_machine=t90-cray
 		os=-unicos
 		;;
-	tic54x | c54x*)
-		basic_machine=tic54x-unknown
-		os=-coff
-		;;
-	tic55x | c55x*)
-		basic_machine=tic55x-unknown
-		os=-coff
-		;;
-	tic6x | c6x*)
-		basic_machine=tic6x-unknown
-		os=-coff
-		;;
 	tile*)
-		basic_machine=tile-unknown
+		basic_machine=$basic_machine-unknown
 		os=-linux-gnu
 		;;
 	tx39)
@@ -1147,6 +1212,9 @@ case $basic_machine in
 	xps | xps100)
 		basic_machine=xps100-honeywell
 		;;
+	xscale-* | xscalee[bl]-*)
+		basic_machine=`echo $basic_machine | sed 's/^xscale/arm/'`
+		;;
 	ymp)
 		basic_machine=ymp-cray
 		os=-unicos
@@ -1244,9 +1312,12 @@ esac
 if [ x"$os" != x"" ]
 then
 case $os in
-        # First match some system type aliases
-        # that might get confused with valid system types.
+	# First match some system type aliases
+	# that might get confused with valid system types.
 	# -solaris* is a basic system type, with this one exception.
+	-auroraux)
+		os=-auroraux
+		;;
 	-solaris1 | -solaris1.*)
 		os=`echo $os | sed -e 's|solaris1|sunos4|'`
 		;;
@@ -1268,8 +1339,8 @@ case $os in
 	# -sysv* is not here because it comes later, after sysvr4.
 	-gnu* | -bsd* | -mach* | -minix* | -genix* | -ultrix* | -irix* \
 	      | -*vms* | -sco* | -esix* | -isc* | -aix* | -cnk* | -sunos | -sunos[34]*\
-	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -solaris* | -sym* \
-	      | -kopensolaris* \
+	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -auroraux* | -solaris* \
+	      | -sym* | -kopensolaris* \
 	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
 	      | -aos* | -aros* \
 	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
@@ -1281,8 +1352,9 @@ case $os in
 	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
 	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
 	      | -chorusos* | -chorusrdb* | -cegcc* \
-	      | -cygwin* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
-	      | -mingw32* | -linux-gnu* | -linux-newlib* | -linux-uclibc* \
+	      | -cygwin* | -msys* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
+	      | -mingw32* | -linux-gnu* | -linux-android* \
+	      | -linux-newlib* | -linux-uclibc* \
 	      | -uxpv* | -beos* | -mpeix* | -udk* \
 	      | -interix* | -uwin* | -mks* | -rhapsody* | -darwin* | -opened* \
 	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
@@ -1290,7 +1362,7 @@ case $os in
 	      | -os2* | -vos* | -palmos* | -uclinux* | -nucleus* \
 	      | -morphos* | -superux* | -rtmk* | -rtmk-nova* | -windiss* \
 	      | -powermax* | -dnix* | -nx6 | -nx7 | -sei* | -dragonfly* \
-	      | -skyos* | -haiku* | -rdos* | -toppers* | -drops*)
+	      | -skyos* | -haiku* | -rdos* | -toppers* | -drops* | -es*)
 	# Remember, each alternative MUST END IN *, to match a version number.
 		;;
 	-qnx*)
@@ -1329,7 +1401,7 @@ case $os in
 	-opened*)
 		os=-openedition
 		;;
-        -os400*)
+	-os400*)
 		os=-os400
 		;;
 	-wince*)
@@ -1378,7 +1450,7 @@ case $os in
 	-sinix*)
 		os=-sysv4
 		;;
-        -tpf*)
+	-tpf*)
 		os=-tpf
 		;;
 	-triton*)
@@ -1423,6 +1495,8 @@ case $os in
 	-dicos*)
 		os=-dicos
 		;;
+	-nacl*)
+		;;
 	-none)
 		;;
 	*)
@@ -1445,10 +1519,10 @@ else
 # system, and we'll never get to this point.
 
 case $basic_machine in
-        score-*)
+	score-*)
 		os=-elf
 		;;
-        spu-*)
+	spu-*)
 		os=-elf
 		;;
 	*-acorn)
@@ -1460,8 +1534,17 @@ case $basic_machine in
 	arm*-semi)
 		os=-aout
 		;;
-        c4x-* | tic4x-*)
-        	os=-coff
+	c4x-* | tic4x-*)
+		os=-coff
+		;;
+	tic54x-*)
+		os=-coff
+		;;
+	tic55x-*)
+		os=-coff
+		;;
+	tic6x-*)
+		os=-coff
 		;;
 	# This must come before the *-dec entry.
 	pdp10-*)
@@ -1481,14 +1564,11 @@ case $basic_machine in
 		;;
 	m68000-sun)
 		os=-sunos3
-		# This also exists in the configure program, but was not the
-		# default.
-		# os=-sunos4
 		;;
 	m68*-cisco)
 		os=-aout
 		;;
-        mep-*)
+	mep-*)
 		os=-elf
 		;;
 	mips*-cisco)
@@ -1515,7 +1595,7 @@ case $basic_machine in
 	*-ibm)
 		os=-aix
 		;;
-    	*-knuth)
+	*-knuth)
 		os=-mmixware
 		;;
 	*-wec)
diff --git a/autotools/depcomp b/autotools/depcomp
index df8eea7..bd0ac08 100755
--- a/autotools/depcomp
+++ b/autotools/depcomp
@@ -1,10 +1,10 @@
 #! /bin/sh
 # depcomp - compile a program generating dependencies as side-effects
 
-scriptversion=2009-04-28.21; # UTC
+scriptversion=2011-12-04.11; # UTC
 
-# Copyright (C) 1999, 2000, 2003, 2004, 2005, 2006, 2007, 2009 Free
-# Software Foundation, Inc.
+# Copyright (C) 1999, 2000, 2003, 2004, 2005, 2006, 2007, 2009, 2010,
+# 2011 Free Software Foundation, Inc.
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -44,7 +44,7 @@ Environment variables:
   object      Object file output by `PROGRAMS ARGS'.
   DEPDIR      directory where to store dependencies.
   depfile     Dependency file to output.
-  tmpdepfile  Temporary file to use when outputing dependencies.
+  tmpdepfile  Temporary file to use when outputting dependencies.
   libtool     Whether libtool is used (yes/no).
 
 Report bugs to <bug-automake@gnu.org>.
@@ -90,10 +90,18 @@ if test "$depmode" = msvcmsys; then
    # This is just like msvisualcpp but w/o cygpath translation.
    # Just convert the backslash-escaped backslashes to single forward
    # slashes to satisfy depend.m4
-   cygpath_u="sed s,\\\\\\\\,/,g"
+   cygpath_u='sed s,\\\\,/,g'
    depmode=msvisualcpp
 fi
 
+if test "$depmode" = msvc7msys; then
+   # This is just like msvc7 but w/o cygpath translation.
+   # Just convert the backslash-escaped backslashes to single forward
+   # slashes to satisfy depend.m4
+   cygpath_u='sed s,\\\\,/,g'
+   depmode=msvc7
+fi
+
 case "$depmode" in
 gcc3)
 ## gcc 3 implements dependency tracking that does exactly what
@@ -158,10 +166,12 @@ gcc)
 ' < "$tmpdepfile" |
 ## Some versions of gcc put a space before the `:'.  On the theory
 ## that the space means something, we add a space to the output as
-## well.
+## well.  hp depmode also adds that space, but also prefixes the VPATH
+## to the object.  Take care to not repeat it in the output.
 ## Some versions of the HPUX 10.20 sed can't process this invocation
 ## correctly.  Breaking it into two sed invocations is a workaround.
-    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
+    sed -e 's/^\\$//' -e '/^$/d' -e "s|.*$object$||" -e '/:$/d' \
+      | sed -e 's/$/ :/' >> "$depfile"
   rm -f "$tmpdepfile"
   ;;
 
@@ -405,6 +415,52 @@ tru64)
    rm -f "$tmpdepfile"
    ;;
 
+msvc7)
+  if test "$libtool" = yes; then
+    showIncludes=-Wc,-showIncludes
+  else
+    showIncludes=-showIncludes
+  fi
+  "$@" $showIncludes > "$tmpdepfile"
+  stat=$?
+  grep -v '^Note: including file: ' "$tmpdepfile"
+  if test "$stat" = 0; then :
+  else
+    rm -f "$tmpdepfile"
+    exit $stat
+  fi
+  rm -f "$depfile"
+  echo "$object : \\" > "$depfile"
+  # The first sed program below extracts the file names and escapes
+  # backslashes for cygpath.  The second sed program outputs the file
+  # name when reading, but also accumulates all include files in the
+  # hold buffer in order to output them again at the end.  This only
+  # works with sed implementations that can handle large buffers.
+  sed < "$tmpdepfile" -n '
+/^Note: including file:  *\(.*\)/ {
+  s//\1/
+  s/\\/\\\\/g
+  p
+}' | $cygpath_u | sort -u | sed -n '
+s/ /\\ /g
+s/\(.*\)/	\1 \\/p
+s/.\(.*\) \\/\1:/
+H
+$ {
+  s/.*/	/
+  G
+  p
+}' >> "$depfile"
+  rm -f "$tmpdepfile"
+  ;;
+
+msvc7msys)
+  # This case exists only to let depend.m4 do its work.  It works by
+  # looking at the text of this script.  This case will never be run,
+  # since it is checked for above.
+  exit 1
+  ;;
+
 #nosideeffect)
   # This comment above is used by automake to tell side-effect
   # dependency tracking mechanisms from slower ones.
@@ -503,7 +559,9 @@ makedepend)
   touch "$tmpdepfile"
   ${MAKEDEPEND-makedepend} -o"$obj_suffix" -f"$tmpdepfile" "$@"
   rm -f "$depfile"
-  cat < "$tmpdepfile" > "$depfile"
+  # makedepend may prepend the VPATH from the source file name to the object.
+  # No need to regex-escape $object, excess matching of '.' is harmless.
+  sed "s|^.*\($object *:\)|\1|" "$tmpdepfile" > "$depfile"
   sed '1,2d' "$tmpdepfile" | tr ' ' '
 ' | \
 ## Some versions of the HPUX 10.20 sed can't process this invocation
diff --git a/autotools/install-sh b/autotools/install-sh
index 6781b98..a9244eb 100755
--- a/autotools/install-sh
+++ b/autotools/install-sh
@@ -1,7 +1,7 @@
 #!/bin/sh
 # install - install a program, script, or datafile
 
-scriptversion=2009-04-28.21; # UTC
+scriptversion=2011-01-19.21; # UTC
 
 # This originates from X11R5 (mit/util/scripts/install.sh), which was
 # later released in X11R6 (xc/config/util/install.sh) with the
@@ -156,6 +156,10 @@ while test $# -ne 0; do
     -s) stripcmd=$stripprog;;
 
     -t) dst_arg=$2
+	# Protect names problematic for `test' and other utilities.
+	case $dst_arg in
+	  -* | [=\(\)!]) dst_arg=./$dst_arg;;
+	esac
 	shift;;
 
     -T) no_target_directory=true;;
@@ -186,6 +190,10 @@ if test $# -ne 0 && test -z "$dir_arg$dst_arg"; then
     fi
     shift # arg
     dst_arg=$arg
+    # Protect names problematic for `test' and other utilities.
+    case $dst_arg in
+      -* | [=\(\)!]) dst_arg=./$dst_arg;;
+    esac
   done
 fi
 
@@ -200,7 +208,11 @@ if test $# -eq 0; then
 fi
 
 if test -z "$dir_arg"; then
-  trap '(exit $?); exit' 1 2 13 15
+  do_exit='(exit $ret); exit $ret'
+  trap "ret=129; $do_exit" 1
+  trap "ret=130; $do_exit" 2
+  trap "ret=141; $do_exit" 13
+  trap "ret=143; $do_exit" 15
 
   # Set umask so as not to create temps with too-generous modes.
   # However, 'strip' requires both read and write access to temps.
@@ -228,9 +240,9 @@ fi
 
 for src
 do
-  # Protect names starting with `-'.
+  # Protect names problematic for `test' and other utilities.
   case $src in
-    -*) src=./$src;;
+    -* | [=\(\)!]) src=./$src;;
   esac
 
   if test -n "$dir_arg"; then
@@ -252,12 +264,7 @@ do
       echo "$0: no destination specified." >&2
       exit 1
     fi
-
     dst=$dst_arg
-    # Protect names starting with `-'.
-    case $dst in
-      -*) dst=./$dst;;
-    esac
 
     # If destination is a directory, append the input filename; won't work
     # if double slashes aren't ignored.
@@ -385,7 +392,7 @@ do
 
       case $dstdir in
 	/*) prefix='/';;
-	-*) prefix='./';;
+	[-=\(\)!]*) prefix='./';;
 	*)  prefix='';;
       esac
 
@@ -403,7 +410,7 @@ do
 
       for d
       do
-	test -z "$d" && continue
+	test X"$d" = X && continue
 
 	prefix=$prefix$d
 	if test -d "$prefix"; then
diff --git a/autotools/missing b/autotools/missing
index 28055d2..86a8fc3 100755
--- a/autotools/missing
+++ b/autotools/missing
@@ -1,10 +1,10 @@
 #! /bin/sh
 # Common stub for a few missing GNU programs while installing.
 
-scriptversion=2009-04-28.21; # UTC
+scriptversion=2012-01-06.13; # UTC
 
 # Copyright (C) 1996, 1997, 1999, 2000, 2002, 2003, 2004, 2005, 2006,
-# 2008, 2009 Free Software Foundation, Inc.
+# 2008, 2009, 2010, 2011, 2012 Free Software Foundation, Inc.
 # Originally by Fran,cois Pinard <pinard@iro.umontreal.ca>, 1996.
 
 # This program is free software; you can redistribute it and/or modify
@@ -84,7 +84,6 @@ Supported PROGRAM values:
   help2man     touch the output file
   lex          create \`lex.yy.c', if possible, from existing .c
   makeinfo     touch the output file
-  tar          try tar, gnutar, gtar, then tar without non-portable flags
   yacc         create \`y.tab.[ch]', if possible, from existing .[ch]
 
 Version suffixes to PROGRAM as well as the prefixes \`gnu-', \`gnu', and
@@ -122,15 +121,6 @@ case $1 in
     # Not GNU programs, they don't have --version.
     ;;
 
-  tar*)
-    if test -n "$run"; then
-       echo 1>&2 "ERROR: \`tar' requires --run"
-       exit 1
-    elif test "x$2" = "x--version" || test "x$2" = "x--help"; then
-       exit 1
-    fi
-    ;;
-
   *)
     if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
        # We have it, but it failed.
@@ -226,7 +216,7 @@ WARNING: \`$1' $msg.  You should only need it if
          \`Bison' from any GNU archive site."
     rm -f y.tab.c y.tab.h
     if test $# -ne 1; then
-        eval LASTARG="\${$#}"
+        eval LASTARG=\${$#}
 	case $LASTARG in
 	*.y)
 	    SRCFILE=`echo "$LASTARG" | sed 's/y$/c/'`
@@ -256,7 +246,7 @@ WARNING: \`$1' is $msg.  You should only need it if
          \`Flex' from any GNU archive site."
     rm -f lex.yy.c
     if test $# -ne 1; then
-        eval LASTARG="\${$#}"
+        eval LASTARG=\${$#}
 	case $LASTARG in
 	*.l)
 	    SRCFILE=`echo "$LASTARG" | sed 's/l$/c/'`
@@ -318,41 +308,6 @@ WARNING: \`$1' is $msg.  You should only need it if
     touch $file
     ;;
 
-  tar*)
-    shift
-
-    # We have already tried tar in the generic part.
-    # Look for gnutar/gtar before invocation to avoid ugly error
-    # messages.
-    if (gnutar --version > /dev/null 2>&1); then
-       gnutar "$@" && exit 0
-    fi
-    if (gtar --version > /dev/null 2>&1); then
-       gtar "$@" && exit 0
-    fi
-    firstarg="$1"
-    if shift; then
-	case $firstarg in
-	*o*)
-	    firstarg=`echo "$firstarg" | sed s/o//`
-	    tar "$firstarg" "$@" && exit 0
-	    ;;
-	esac
-	case $firstarg in
-	*h*)
-	    firstarg=`echo "$firstarg" | sed s/h//`
-	    tar "$firstarg" "$@" && exit 0
-	    ;;
-	esac
-    fi
-
-    echo 1>&2 "\
-WARNING: I can't seem to be able to run \`tar' with the given arguments.
-         You may want to install GNU tar or Free paxutils, or check the
-         command line arguments."
-    exit 1
-    ;;
-
   *)
     echo 1>&2 "\
 WARNING: \`$1' is needed, and is $msg.
diff --git a/bootstrap b/bootstrap
new file mode 100755
index 0000000..0ee7f14
--- /dev/null
+++ b/bootstrap
@@ -0,0 +1,5 @@
+ mkdir -p autotools
+ aclocal -I autotools/
+ autoheader
+ automake --add-missing -c
+ autoconf
diff --git a/client.c b/client.c
index ddb56a5..4895553 100644
--- a/client.c
+++ b/client.c
@@ -40,6 +40,9 @@
 #include "url.h"
 #include "progress.h"
 
+/* For curl_global_init, curl_global_cleanup */
+#include <curl/curl.h>
+
 /* FILE* f = open_zcat_pipe(file_str)
  * Returns a (popen) filehandle which when read returns the un-gzipped content
  * of the given file. Or NULL on error; or the filehandle may fail to read. It
@@ -280,15 +283,12 @@ static float calc_zsync_progress(const struct zsync_state *zs) {
  * For the given zsync_state, using the given URL (which is a copy of the
  * actual content of the target file is type == 0, or a compressed copy of it
  * if type == 1), retrieve the parts of the target that are currently missing. 
- * Returns true if this URL was useful, false if we crashed and burned.
+ * Returns zero if this URL was useful, nonzero if we crashed and burned.
  */
-#define BUFFERSIZE 8192
-
 int fetch_remaining_blocks_http(struct zsync_state *z, const char *url,
                                 int type) {
     int ret = 0;
     struct range_fetch *rf;
-    unsigned char *buf;
     struct zsync_receiver *zr;
 
     /* URL might be relative - we need an absolute URL to do a fetch */
@@ -301,30 +301,21 @@ int fetch_remaining_blocks_http(struct zsync_state *z, const char *url,
     }
 
     /* Start a range fetch and a zsync receiver */
-    rf = range_fetch_start(u);
-    if (!rf) {
-        free(u);
-        return -1;
-    }
     zr = zsync_begin_receive(z, type);
     if (!zr) {
-        range_fetch_end(rf);
         free(u);
         return -1;
     }
-
-    if (!no_progress)
-        fprintf(stderr, "downloading from %s:", u);
-
-    /* Create a read buffer */
-    buf = malloc(BUFFERSIZE);
-    if (!buf) {
+    rf = range_fetch_start(u, zr);
+    if (!rf) {
         zsync_end_receive(zr);
-        range_fetch_end(rf);
         free(u);
         return -1;
     }
 
+    if (!no_progress)
+        fprintf(stderr, "downloading from %s:", u);
+
     {   /* Get a set of byte ranges that we need to complete the target */
         int nrange;
         off_t *zbyterange = zsync_needed_byte_ranges(z, &nrange, type);
@@ -339,8 +330,6 @@ int fetch_remaining_blocks_http(struct zsync_state *z, const char *url,
     }
 
     {
-        int len;
-        off_t zoffset;
         struct progress p = { 0, 0, 0, 0 };
 
         /* Set up progress display to run during the fetch */
@@ -349,36 +338,22 @@ int fetch_remaining_blocks_http(struct zsync_state *z, const char *url,
             do_progress(&p, calc_zsync_progress(z), range_fetch_bytes_down(rf));
         }
 
-        /* Loop while we're receiving data, until we're done or there is an error */
-        while (!ret
-               && (len = get_range_block(rf, &zoffset, buf, BUFFERSIZE)) > 0) {
-            /* Pass received data to the zsync receiver, which writes it to the
-             * appropriate location in the target file */
-            if (zsync_receive_data(zr, buf, zoffset, len) != 0)
-                ret = 1;
+        do {
+            ret = range_fetch_perform(rf);
 
-            /* Maintain progress display */
-            if (!no_progress)
+            if (ret && ! no_progress) {
+                /* Maintain progress display
+                 * XXX: Non-curl version could update in the middle of responses */
                 do_progress(&p, calc_zsync_progress(z),
                             range_fetch_bytes_down(rf));
-
-            // Needed in case next call returns len=0 and we need to signal where the EOF was.
-            zoffset += len;     
-        }
-
-        /* If error, we need to flag that to our caller */
-        if (len < 0)
-            ret = -1;
-        else    /* Else, let the zsync receiver know that we're at EOF; there
-                 *could be data in its buffer that it can use or needs to process */
-            zsync_receive_data(zr, NULL, zoffset, 0);
+            }
+        } while( ret > 0 );
 
         if (!no_progress)
-            end_progress(&p, zsync_status(z) >= 2 ? 2 : len == 0 ? 1 : 0);
+            end_progress(&p, zsync_status(z) >= 2 ? 2 : ret == 0 ? 1 : 0);
     }
 
     /* Clean up */
-    free(buf);
     http_down += range_fetch_bytes_down(rf);
     zsync_end_receive(zr);
     range_fetch_end(rf);
@@ -459,8 +434,7 @@ int main(int argc, char **argv) {
     srand(getpid());
     {   /* Option parsing */
         int opt;
-
-        while ((opt = getopt(argc, argv, "A:k:o:i:Vsqu:")) != -1) {
+        while ((opt = getopt(argc, argv, "A:k:o:i:Vsqvu:C:KT:I:R:S:")) != -1) {
             switch (opt) {
             case 'A':           /* Authentication options for remote server */
                 {               /* Scan string as hostname=username:password */
@@ -474,8 +448,15 @@ int main(int argc, char **argv) {
                         exit(1);
                     }
                     else {
+                        /* XXX - HTTP Auth not working right now */
+                        fprintf(stderr,
+                               "HTTP Authentication is not supported in this version\n");
+                        exit(1);
+
+                        /*
                         *q++ = *r++ = 0;
                         add_auth(p, q, r);
+                        */
                     }
                 }
                 break;
@@ -499,9 +480,45 @@ int main(int argc, char **argv) {
             case 'q':
                 no_progress = 1;
                 break;
+            case 'v':
+                be_verbose = 1;
+                break;
             case 'u':
                 referer = strdup(optarg);
                 break;
+            case 'C':
+                /* CA Cert path */
+                cacert = strdup(optarg);
+                break;
+            case 'K':
+                /* Insecure (disable SSL host/peer verification) */
+                be_insecure = 1;
+                break;
+            case 'R':
+                /* SSL certificate path */
+                sslcert = strdup(optarg);
+                break;
+            case 'S':
+                /* SSL private key path */
+                sslkey = strdup(optarg);
+                break;
+            case 'T':
+                /* Timeout */
+                {
+                    char *endptr = NULL;
+                    errno = 0;
+                    use_timeout = strtol( optarg, &endptr, 10 );
+                    if( errno || *endptr != 0 || use_timeout < 0 ) {
+                        /* Unable to convert, garbage at the end of the string, or number was negative */
+                        fprintf( stderr, "Timeout (-T): Invalid number `%s'\n", optarg );
+                        exit(1);
+                    }
+                }
+                break;
+            case 'I':
+                /* Interface */
+                want_interface = strdup(optarg);
+                break;
             }
         }
     }
@@ -521,11 +538,21 @@ int main(int argc, char **argv) {
     /* No progress display except on terminal */
     if (!isatty(0))
         no_progress = 1;
-    {   /* Get proxy setting from the environment */
-        char *pr = getenv("http_proxy");
 
-        if (pr != NULL)
-            set_proxy_from_string(pr);
+    /* Respect ZSYNC_CA_BUNDLE environment variable */
+    if( !cacert ) {
+        char *env_cacert;
+        if( env_cacert = getenv("ZSYNC_CA_BUNDLE") ) {
+            cacert = strdup(env_cacert);
+        }
+    }
+
+    /* Global libcurl init -- must be called exactly once per program */
+    if( curl_global_init( CURL_GLOBAL_ALL ) ) {
+        /* libcurl is busted */
+        fprintf(stderr,
+                "curl_global_init failed miserably!\n");
+        exit(3);
     }
 
     /* STEP 1: Read the zsync control file */
@@ -539,6 +566,19 @@ int main(int argc, char **argv) {
     strcpy(temp_file, filename);
     strcat(temp_file, ".part");
 
+    /* Bail out for 0 length files */
+    if (! zsync_filelen(zs)) {
+        FILE *f = fopen(filename, "w");
+        if (!f) {
+            perror("open");
+            fprintf(stderr, "Could not open %s for writing zero byte file\n", filename);
+            exit(1);
+        }
+        mtime = zsync_mtime(zs);
+        if (mtime != -1) set_mtime(filename, mtime);
+        return 0;
+    }
+
     {   /* STEP 2: read available local data and fill in what we know in the
          *target file */
         int i;
@@ -689,7 +729,10 @@ int main(int argc, char **argv) {
     /* Final stats and cleanup */
     if (!no_progress)
         printf("used %lld local, fetched %lld\n", local_used, http_down);
+    free(cacert);
+    free(want_interface);
     free(referer);
     free(temp_file);
+    curl_global_cleanup();
     return 0;
 }
diff --git a/config.h.in b/config.h.in
index 95ca8dd..c7abe47 100644
--- a/config.h.in
+++ b/config.h.in
@@ -9,6 +9,9 @@
 /* Define to 1 if you have the <inttypes.h> header file. */
 #undef HAVE_INTTYPES_H
 
+/* Define to 1 if you have the `curl' library (-lcurl). */
+#undef HAVE_LIBCURL
+
 /* Define to 1 if you have the `socket' library (-lsocket). */
 #undef HAVE_LIBSOCKET
 
diff --git a/configure b/configure
index 1e95e0e..8ed9bb2 100755
--- a/configure
+++ b/configure
@@ -1,13 +1,13 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.65 for zsync 0.6.2.
+# Generated by GNU Autoconf 2.68 for zsync 0.6.2.
 #
 # Report bugs to <http://zsync.moria.org.uk/>.
 #
 #
 # Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
-# 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009 Free Software Foundation,
-# Inc.
+# 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010 Free Software
+# Foundation, Inc.
 #
 #
 # This configure script is free software; the Free Software Foundation
@@ -91,6 +91,7 @@ fi
 IFS=" ""	$as_nl"
 
 # Find who we are.  Look in the path if we contain no directory separator.
+as_myself=
 case $0 in #((
   *[\\/]* ) as_myself=$0 ;;
   *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
@@ -216,11 +217,18 @@ IFS=$as_save_IFS
   # We cannot yet assume a decent shell, so we have to provide a
 	# neutralization value for shells without unset; and this also
 	# works around shells that cannot unset nonexistent variables.
+	# Preserve -v and -x to the replacement shell.
 	BASH_ENV=/dev/null
 	ENV=/dev/null
 	(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
 	export CONFIG_SHELL
-	exec "$CONFIG_SHELL" "$as_myself" ${1+"$@"}
+	case $- in # ((((
+	  *v*x* | *x*v* ) as_opts=-vx ;;
+	  *v* ) as_opts=-v ;;
+	  *x* ) as_opts=-x ;;
+	  * ) as_opts= ;;
+	esac
+	exec "$CONFIG_SHELL" $as_opts "$as_myself" ${1+"$@"}
 fi
 
     if test x$as_have_required = xno; then :
@@ -319,7 +327,7 @@ $as_echo X"$as_dir" |
       test -d "$as_dir" && break
     done
     test -z "$as_dirs" || eval "mkdir $as_dirs"
-  } || test -d "$as_dir" || as_fn_error "cannot create directory $as_dir"
+  } || test -d "$as_dir" || as_fn_error $? "cannot create directory $as_dir"
 
 
 } # as_fn_mkdir_p
@@ -359,19 +367,19 @@ else
 fi # as_fn_arith
 
 
-# as_fn_error ERROR [LINENO LOG_FD]
-# ---------------------------------
+# as_fn_error STATUS ERROR [LINENO LOG_FD]
+# ----------------------------------------
 # Output "`basename $0`: error: ERROR" to stderr. If LINENO and LOG_FD are
 # provided, also output the error to LOG_FD, referencing LINENO. Then exit the
-# script with status $?, using 1 if that was 0.
+# script with STATUS, using 1 if that was 0.
 as_fn_error ()
 {
-  as_status=$?; test $as_status -eq 0 && as_status=1
-  if test "$3"; then
-    as_lineno=${as_lineno-"$2"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-    $as_echo "$as_me:${as_lineno-$LINENO}: error: $1" >&$3
+  as_status=$1; test $as_status -eq 0 && as_status=1
+  if test "$4"; then
+    as_lineno=${as_lineno-"$3"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+    $as_echo "$as_me:${as_lineno-$LINENO}: error: $2" >&$4
   fi
-  $as_echo "$as_me: error: $1" >&2
+  $as_echo "$as_me: error: $2" >&2
   as_fn_exit $as_status
 } # as_fn_error
 
@@ -533,7 +541,7 @@ test -n "$DJDIR" || exec 7<&0 </dev/null
 exec 6>&1
 
 # Name of the host.
-# hostname on some systems (SVR3.2, Linux) returns a bogus exit status,
+# hostname on some systems (SVR3.2, old GNU/Linux) returns a bogus exit status,
 # so uname gets run too.
 ac_hostname=`(hostname || uname -n) 2>/dev/null | sed 1q`
 
@@ -609,6 +617,7 @@ LN_S
 am__fastdepCC_FALSE
 am__fastdepCC_TRUE
 CCDEPMODE
+am__nodep
 AMDEPBACKSLASH
 AMDEP_FALSE
 AMDEP_TRUE
@@ -774,8 +783,9 @@ do
   fi
 
   case $ac_option in
-  *=*)	ac_optarg=`expr "X$ac_option" : '[^=]*=\(.*\)'` ;;
-  *)	ac_optarg=yes ;;
+  *=?*) ac_optarg=`expr "X$ac_option" : '[^=]*=\(.*\)'` ;;
+  *=)   ac_optarg= ;;
+  *)    ac_optarg=yes ;;
   esac
 
   # Accept the important Cygnus configure options, so we can diagnose typos.
@@ -820,7 +830,7 @@ do
     ac_useropt=`expr "x$ac_option" : 'x-*disable-\(.*\)'`
     # Reject names that are not valid shell variable names.
     expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
-      as_fn_error "invalid feature name: $ac_useropt"
+      as_fn_error $? "invalid feature name: $ac_useropt"
     ac_useropt_orig=$ac_useropt
     ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
     case $ac_user_opts in
@@ -846,7 +856,7 @@ do
     ac_useropt=`expr "x$ac_option" : 'x-*enable-\([^=]*\)'`
     # Reject names that are not valid shell variable names.
     expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
-      as_fn_error "invalid feature name: $ac_useropt"
+      as_fn_error $? "invalid feature name: $ac_useropt"
     ac_useropt_orig=$ac_useropt
     ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
     case $ac_user_opts in
@@ -1050,7 +1060,7 @@ do
     ac_useropt=`expr "x$ac_option" : 'x-*with-\([^=]*\)'`
     # Reject names that are not valid shell variable names.
     expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
-      as_fn_error "invalid package name: $ac_useropt"
+      as_fn_error $? "invalid package name: $ac_useropt"
     ac_useropt_orig=$ac_useropt
     ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
     case $ac_user_opts in
@@ -1066,7 +1076,7 @@ do
     ac_useropt=`expr "x$ac_option" : 'x-*without-\(.*\)'`
     # Reject names that are not valid shell variable names.
     expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
-      as_fn_error "invalid package name: $ac_useropt"
+      as_fn_error $? "invalid package name: $ac_useropt"
     ac_useropt_orig=$ac_useropt
     ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
     case $ac_user_opts in
@@ -1096,8 +1106,8 @@ do
   | --x-librar=* | --x-libra=* | --x-libr=* | --x-lib=* | --x-li=* | --x-l=*)
     x_libraries=$ac_optarg ;;
 
-  -*) as_fn_error "unrecognized option: \`$ac_option'
-Try \`$0 --help' for more information."
+  -*) as_fn_error $? "unrecognized option: \`$ac_option'
+Try \`$0 --help' for more information"
     ;;
 
   *=*)
@@ -1105,7 +1115,7 @@ Try \`$0 --help' for more information."
     # Reject names that are not valid shell variable names.
     case $ac_envvar in #(
       '' | [0-9]* | *[!_$as_cr_alnum]* )
-      as_fn_error "invalid variable name: \`$ac_envvar'" ;;
+      as_fn_error $? "invalid variable name: \`$ac_envvar'" ;;
     esac
     eval $ac_envvar=\$ac_optarg
     export $ac_envvar ;;
@@ -1115,7 +1125,7 @@ Try \`$0 --help' for more information."
     $as_echo "$as_me: WARNING: you should use --build, --host, --target" >&2
     expr "x$ac_option" : ".*[^-._$as_cr_alnum]" >/dev/null &&
       $as_echo "$as_me: WARNING: invalid host type: $ac_option" >&2
-    : ${build_alias=$ac_option} ${host_alias=$ac_option} ${target_alias=$ac_option}
+    : "${build_alias=$ac_option} ${host_alias=$ac_option} ${target_alias=$ac_option}"
     ;;
 
   esac
@@ -1123,13 +1133,13 @@ done
 
 if test -n "$ac_prev"; then
   ac_option=--`echo $ac_prev | sed 's/_/-/g'`
-  as_fn_error "missing argument to $ac_option"
+  as_fn_error $? "missing argument to $ac_option"
 fi
 
 if test -n "$ac_unrecognized_opts"; then
   case $enable_option_checking in
     no) ;;
-    fatal) as_fn_error "unrecognized options: $ac_unrecognized_opts" ;;
+    fatal) as_fn_error $? "unrecognized options: $ac_unrecognized_opts" ;;
     *)     $as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2 ;;
   esac
 fi
@@ -1152,7 +1162,7 @@ do
     [\\/$]* | ?:[\\/]* )  continue;;
     NONE | '' ) case $ac_var in *prefix ) continue;; esac;;
   esac
-  as_fn_error "expected an absolute directory name for --$ac_var: $ac_val"
+  as_fn_error $? "expected an absolute directory name for --$ac_var: $ac_val"
 done
 
 # There might be people who depend on the old broken behavior: `$host'
@@ -1166,8 +1176,8 @@ target=$target_alias
 if test "x$host_alias" != x; then
   if test "x$build_alias" = x; then
     cross_compiling=maybe
-    $as_echo "$as_me: WARNING: If you wanted to set the --build type, don't use --host.
-    If a cross compiler is detected then cross compile mode will be used." >&2
+    $as_echo "$as_me: WARNING: if you wanted to set the --build type, don't use --host.
+    If a cross compiler is detected then cross compile mode will be used" >&2
   elif test "x$build_alias" != "x$host_alias"; then
     cross_compiling=yes
   fi
@@ -1182,9 +1192,9 @@ test "$silent" = yes && exec 6>/dev/null
 ac_pwd=`pwd` && test -n "$ac_pwd" &&
 ac_ls_di=`ls -di .` &&
 ac_pwd_ls_di=`cd "$ac_pwd" && ls -di .` ||
-  as_fn_error "working directory cannot be determined"
+  as_fn_error $? "working directory cannot be determined"
 test "X$ac_ls_di" = "X$ac_pwd_ls_di" ||
-  as_fn_error "pwd does not report name of working directory"
+  as_fn_error $? "pwd does not report name of working directory"
 
 
 # Find the source files, if location was not specified.
@@ -1223,11 +1233,11 @@ else
 fi
 if test ! -r "$srcdir/$ac_unique_file"; then
   test "$ac_srcdir_defaulted" = yes && srcdir="$ac_confdir or .."
-  as_fn_error "cannot find sources ($ac_unique_file) in $srcdir"
+  as_fn_error $? "cannot find sources ($ac_unique_file) in $srcdir"
 fi
 ac_msg="sources are in $srcdir, but \`cd $srcdir' does not work"
 ac_abs_confdir=`(
-	cd "$srcdir" && test -r "./$ac_unique_file" || as_fn_error "$ac_msg"
+	cd "$srcdir" && test -r "./$ac_unique_file" || as_fn_error $? "$ac_msg"
 	pwd)`
 # When building in place, set srcdir=.
 if test "$ac_abs_confdir" = "$ac_pwd"; then
@@ -1267,7 +1277,7 @@ Configuration:
       --help=short        display options specific to this package
       --help=recursive    display the short help of all the included packages
   -V, --version           display version information and exit
-  -q, --quiet, --silent   do not print \`checking...' messages
+  -q, --quiet, --silent   do not print \`checking ...' messages
       --cache-file=FILE   cache test results in FILE [disabled]
   -C, --config-cache      alias for \`--cache-file=config.cache'
   -n, --no-create         do not create output files
@@ -1341,8 +1351,7 @@ Optional Features:
 Optional Packages:
   --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
   --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
-  --with-dmalloc          use dmalloc, as in
-			  http://www.dmalloc.com/dmalloc.tar.gz
+  --with-dmalloc          use dmalloc, as in http://www.dmalloc.com
 
 Some influential environment variables:
   CC          C compiler command
@@ -1421,9 +1430,9 @@ test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
 zsync configure 0.6.2
-generated by GNU Autoconf 2.65
+generated by GNU Autoconf 2.68
 
-Copyright (C) 2009 Free Software Foundation, Inc.
+Copyright (C) 2010 Free Software Foundation, Inc.
 This configure script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it.
 _ACEOF
@@ -1467,7 +1476,7 @@ sed 's/^/| /' conftest.$ac_ext >&5
 
 	ac_retval=1
 fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
   as_fn_set_status $ac_retval
 
 } # ac_fn_c_try_compile
@@ -1493,7 +1502,7 @@ $as_echo "$ac_try_echo"; } >&5
     mv -f conftest.er1 conftest.err
   fi
   $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } >/dev/null && {
+  test $ac_status = 0; } > conftest.i && {
 	 test -z "$ac_c_preproc_warn_flag$ac_c_werror_flag" ||
 	 test ! -s conftest.err
        }; then :
@@ -1504,7 +1513,7 @@ sed 's/^/| /' conftest.$ac_ext >&5
 
     ac_retval=1
 fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
   as_fn_set_status $ac_retval
 
 } # ac_fn_c_try_cpp
@@ -1546,7 +1555,7 @@ sed 's/^/| /' conftest.$ac_ext >&5
        ac_retval=$ac_status
 fi
   rm -rf conftest.dSYM conftest_ipa8_conftest.oo
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
   as_fn_set_status $ac_retval
 
 } # ac_fn_c_try_run
@@ -1559,10 +1568,10 @@ fi
 ac_fn_c_check_header_mongrel ()
 {
   as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+  if eval \${$3+:} false; then :
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
 $as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+if eval \${$3+:} false; then :
   $as_echo_n "(cached) " >&6
 fi
 eval ac_res=\$$3
@@ -1598,7 +1607,7 @@ if ac_fn_c_try_cpp "$LINENO"; then :
 else
   ac_header_preproc=no
 fi
-rm -f conftest.err conftest.$ac_ext
+rm -f conftest.err conftest.i conftest.$ac_ext
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_header_preproc" >&5
 $as_echo "$ac_header_preproc" >&6; }
 
@@ -1621,17 +1630,15 @@ $as_echo "$as_me: WARNING: $2: see the Autoconf documentation" >&2;}
 $as_echo "$as_me: WARNING: $2:     section \"Present But Cannot Be Compiled\"" >&2;}
     { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: proceeding with the compiler's result" >&5
 $as_echo "$as_me: WARNING: $2: proceeding with the compiler's result" >&2;}
-( cat <<\_ASBOX
-## ----------------------------------------- ##
+( $as_echo "## ----------------------------------------- ##
 ## Report this to http://zsync.moria.org.uk/ ##
-## ----------------------------------------- ##
-_ASBOX
+## ----------------------------------------- ##"
      ) | sed "s/^/$as_me: WARNING:     /" >&2
     ;;
 esac
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
 $as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+if eval \${$3+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   eval "$3=\$ac_header_compiler"
@@ -1640,7 +1647,7 @@ eval ac_res=\$$3
 	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
 $as_echo "$ac_res" >&6; }
 fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
 
 } # ac_fn_c_check_header_mongrel
 
@@ -1653,7 +1660,7 @@ ac_fn_c_check_header_compile ()
   as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
 $as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+if eval \${$3+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -1671,7 +1678,7 @@ fi
 eval ac_res=\$$3
 	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
 $as_echo "$ac_res" >&6; }
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
 
 } # ac_fn_c_check_header_compile
 
@@ -1684,7 +1691,7 @@ ac_fn_c_check_type ()
   as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
 $as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+if eval \${$3+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   eval "$3=no"
@@ -1725,7 +1732,7 @@ fi
 eval ac_res=\$$3
 	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
 $as_echo "$ac_res" >&6; }
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
 
 } # ac_fn_c_check_type
 
@@ -1770,7 +1777,7 @@ fi
   # interfere with the next link command; also delete a directory that is
   # left behind by Apple's compiler.  We do this before executing the actions.
   rm -rf conftest.dSYM conftest_ipa8_conftest.oo
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
   as_fn_set_status $ac_retval
 
 } # ac_fn_c_try_link
@@ -1783,7 +1790,7 @@ ac_fn_c_check_func ()
   as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
 $as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+if eval \${$3+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -1838,7 +1845,7 @@ fi
 eval ac_res=\$$3
 	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
 $as_echo "$ac_res" >&6; }
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
 
 } # ac_fn_c_check_func
 
@@ -2015,7 +2022,7 @@ rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
 rm -f conftest.val
 
   fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+  eval $as_lineno_stack; ${as_lineno_stack:+:} unset as_lineno
   as_fn_set_status $ac_retval
 
 } # ac_fn_c_compute_int
@@ -2024,7 +2031,7 @@ This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
 It was created by zsync $as_me 0.6.2, which was
-generated by GNU Autoconf 2.65.  Invocation command line was
+generated by GNU Autoconf 2.68.  Invocation command line was
 
   $ $0 $@
 
@@ -2134,11 +2141,9 @@ trap 'exit_status=$?
   {
     echo
 
-    cat <<\_ASBOX
-## ---------------- ##
+    $as_echo "## ---------------- ##
 ## Cache variables. ##
-## ---------------- ##
-_ASBOX
+## ---------------- ##"
     echo
     # The following way of writing the cache mishandles newlines in values,
 (
@@ -2172,11 +2177,9 @@ $as_echo "$as_me: WARNING: cache variable $ac_var contains a newline" >&2;} ;;
 )
     echo
 
-    cat <<\_ASBOX
-## ----------------- ##
+    $as_echo "## ----------------- ##
 ## Output variables. ##
-## ----------------- ##
-_ASBOX
+## ----------------- ##"
     echo
     for ac_var in $ac_subst_vars
     do
@@ -2189,11 +2192,9 @@ _ASBOX
     echo
 
     if test -n "$ac_subst_files"; then
-      cat <<\_ASBOX
-## ------------------- ##
+      $as_echo "## ------------------- ##
 ## File substitutions. ##
-## ------------------- ##
-_ASBOX
+## ------------------- ##"
       echo
       for ac_var in $ac_subst_files
       do
@@ -2207,11 +2208,9 @@ _ASBOX
     fi
 
     if test -s confdefs.h; then
-      cat <<\_ASBOX
-## ----------- ##
+      $as_echo "## ----------- ##
 ## confdefs.h. ##
-## ----------- ##
-_ASBOX
+## ----------- ##"
       echo
       cat confdefs.h
       echo
@@ -2266,7 +2265,12 @@ _ACEOF
 ac_site_file1=NONE
 ac_site_file2=NONE
 if test -n "$CONFIG_SITE"; then
-  ac_site_file1=$CONFIG_SITE
+  # We do not want a PATH search for config.site.
+  case $CONFIG_SITE in #((
+    -*)  ac_site_file1=./$CONFIG_SITE;;
+    */*) ac_site_file1=$CONFIG_SITE;;
+    *)   ac_site_file1=./$CONFIG_SITE;;
+  esac
 elif test "x$prefix" != xNONE; then
   ac_site_file1=$prefix/share/config.site
   ac_site_file2=$prefix/etc/config.site
@@ -2281,7 +2285,11 @@ do
     { $as_echo "$as_me:${as_lineno-$LINENO}: loading site script $ac_site_file" >&5
 $as_echo "$as_me: loading site script $ac_site_file" >&6;}
     sed 's/^/| /' "$ac_site_file" >&5
-    . "$ac_site_file"
+    . "$ac_site_file" \
+      || { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+as_fn_error $? "failed to load site script $ac_site_file
+See \`config.log' for more details" "$LINENO" 5; }
   fi
 done
 
@@ -2357,7 +2365,7 @@ if $ac_cache_corrupted; then
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
   { $as_echo "$as_me:${as_lineno-$LINENO}: error: changes in the environment can compromise the build" >&5
 $as_echo "$as_me: error: changes in the environment can compromise the build" >&2;}
-  as_fn_error "run \`make distclean' and/or \`rm $cache_file' and start over" "$LINENO" 5
+  as_fn_error $? "run \`make distclean' and/or \`rm $cache_file' and start over" "$LINENO" 5
 fi
 ## -------------------- ##
 ## Main body of script. ##
@@ -2374,16 +2382,22 @@ ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
 ac_aux_dir=
 for ac_dir in autotools "$srcdir"/autotools; do
-  for ac_t in install-sh install.sh shtool; do
-    if test -f "$ac_dir/$ac_t"; then
-      ac_aux_dir=$ac_dir
-      ac_install_sh="$ac_aux_dir/$ac_t -c"
-      break 2
-    fi
-  done
+  if test -f "$ac_dir/install-sh"; then
+    ac_aux_dir=$ac_dir
+    ac_install_sh="$ac_aux_dir/install-sh -c"
+    break
+  elif test -f "$ac_dir/install.sh"; then
+    ac_aux_dir=$ac_dir
+    ac_install_sh="$ac_aux_dir/install.sh -c"
+    break
+  elif test -f "$ac_dir/shtool"; then
+    ac_aux_dir=$ac_dir
+    ac_install_sh="$ac_aux_dir/shtool install -c"
+    break
+  fi
 done
 if test -z "$ac_aux_dir"; then
-  as_fn_error "cannot find install-sh, install.sh, or shtool in autotools \"$srcdir\"/autotools" "$LINENO" 5
+  as_fn_error $? "cannot find install-sh, install.sh, or shtool in autotools \"$srcdir\"/autotools" "$LINENO" 5
 fi
 
 # These three variables are undocumented and unsupported,
@@ -2399,27 +2413,27 @@ ac_configure="$SHELL $ac_aux_dir/configure"  # Please don't use this var.
 
 # Make sure we can run config.sub.
 $SHELL "$ac_aux_dir/config.sub" sun4 >/dev/null 2>&1 ||
-  as_fn_error "cannot run $SHELL $ac_aux_dir/config.sub" "$LINENO" 5
+  as_fn_error $? "cannot run $SHELL $ac_aux_dir/config.sub" "$LINENO" 5
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking build system type" >&5
 $as_echo_n "checking build system type... " >&6; }
-if test "${ac_cv_build+set}" = set; then :
+if ${ac_cv_build+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_build_alias=$build_alias
 test "x$ac_build_alias" = x &&
   ac_build_alias=`$SHELL "$ac_aux_dir/config.guess"`
 test "x$ac_build_alias" = x &&
-  as_fn_error "cannot guess build type; you must specify one" "$LINENO" 5
+  as_fn_error $? "cannot guess build type; you must specify one" "$LINENO" 5
 ac_cv_build=`$SHELL "$ac_aux_dir/config.sub" $ac_build_alias` ||
-  as_fn_error "$SHELL $ac_aux_dir/config.sub $ac_build_alias failed" "$LINENO" 5
+  as_fn_error $? "$SHELL $ac_aux_dir/config.sub $ac_build_alias failed" "$LINENO" 5
 
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_build" >&5
 $as_echo "$ac_cv_build" >&6; }
 case $ac_cv_build in
 *-*-*) ;;
-*) as_fn_error "invalid value of canonical build" "$LINENO" 5;;
+*) as_fn_error $? "invalid value of canonical build" "$LINENO" 5;;
 esac
 build=$ac_cv_build
 ac_save_IFS=$IFS; IFS='-'
@@ -2437,14 +2451,14 @@ case $build_os in *\ *) build_os=`echo "$build_os" | sed 's/ /-/g'`;; esac
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking host system type" >&5
 $as_echo_n "checking host system type... " >&6; }
-if test "${ac_cv_host+set}" = set; then :
+if ${ac_cv_host+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test "x$host_alias" = x; then
   ac_cv_host=$ac_cv_build
 else
   ac_cv_host=`$SHELL "$ac_aux_dir/config.sub" $host_alias` ||
-    as_fn_error "$SHELL $ac_aux_dir/config.sub $host_alias failed" "$LINENO" 5
+    as_fn_error $? "$SHELL $ac_aux_dir/config.sub $host_alias failed" "$LINENO" 5
 fi
 
 fi
@@ -2452,7 +2466,7 @@ fi
 $as_echo "$ac_cv_host" >&6; }
 case $ac_cv_host in
 *-*-*) ;;
-*) as_fn_error "invalid value of canonical host" "$LINENO" 5;;
+*) as_fn_error $? "invalid value of canonical host" "$LINENO" 5;;
 esac
 host=$ac_cv_host
 ac_save_IFS=$IFS; IFS='-'
@@ -2488,7 +2502,7 @@ am__api_version='1.11'
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for a BSD-compatible install" >&5
 $as_echo_n "checking for a BSD-compatible install... " >&6; }
 if test -z "$INSTALL"; then
-if test "${ac_cv_path_install+set}" = set; then :
+if ${ac_cv_path_install+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
@@ -2575,11 +2589,11 @@ am_lf='
 '
 case `pwd` in
   *[\\\"\#\$\&\'\`$am_lf]*)
-    as_fn_error "unsafe absolute working directory name" "$LINENO" 5;;
+    as_fn_error $? "unsafe absolute working directory name" "$LINENO" 5;;
 esac
 case $srcdir in
   *[\\\"\#\$\&\'\`$am_lf\ \	]*)
-    as_fn_error "unsafe srcdir value: \`$srcdir'" "$LINENO" 5;;
+    as_fn_error $? "unsafe srcdir value: \`$srcdir'" "$LINENO" 5;;
 esac
 
 # Do `set' in a subshell so we don't clobber the current shell's
@@ -2601,7 +2615,7 @@ if (
       # if, for instance, CONFIG_SHELL is bash and it inherits a
       # broken ls alias from the environment.  This has actually
       # happened.  Such a system could not be considered "sane".
-      as_fn_error "ls -t appears to fail.  Make sure there is not a broken
+      as_fn_error $? "ls -t appears to fail.  Make sure there is not a broken
 alias in your environment" "$LINENO" 5
    fi
 
@@ -2611,7 +2625,7 @@ then
    # Ok.
    :
 else
-   as_fn_error "newly created file is older than distributed files!
+   as_fn_error $? "newly created file is older than distributed files!
 Check your system clock" "$LINENO" 5
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
@@ -2665,7 +2679,7 @@ if test "$cross_compiling" != no; then
 set dummy ${ac_tool_prefix}strip; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_STRIP+set}" = set; then :
+if ${ac_cv_prog_STRIP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$STRIP"; then
@@ -2705,7 +2719,7 @@ if test -z "$ac_cv_prog_STRIP"; then
 set dummy strip; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_STRIP+set}" = set; then :
+if ${ac_cv_prog_ac_ct_STRIP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_STRIP"; then
@@ -2758,7 +2772,7 @@ INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for a thread-safe mkdir -p" >&5
 $as_echo_n "checking for a thread-safe mkdir -p... " >&6; }
 if test -z "$MKDIR_P"; then
-  if test "${ac_cv_path_mkdir+set}" = set; then :
+  if ${ac_cv_path_mkdir+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
@@ -2809,7 +2823,7 @@ do
 set dummy $ac_prog; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_AWK+set}" = set; then :
+if ${ac_cv_prog_AWK+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$AWK"; then
@@ -2849,7 +2863,7 @@ done
 $as_echo_n "checking whether ${MAKE-make} sets \$(MAKE)... " >&6; }
 set x ${MAKE-make}
 ac_make=`$as_echo "$2" | sed 's/+/p/g; s/[^a-zA-Z0-9_]/_/g'`
-if { as_var=ac_cv_prog_make_${ac_make}_set; eval "test \"\${$as_var+set}\" = set"; }; then :
+if eval \${ac_cv_prog_make_${ac_make}_set+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat >conftest.make <<\_ACEOF
@@ -2857,7 +2871,7 @@ SHELL = /bin/sh
 all:
 	@echo '@@@%%%=$(MAKE)=@@@%%%'
 _ACEOF
-# GNU make sometimes prints "make[1]: Entering...", which would confuse us.
+# GNU make sometimes prints "make[1]: Entering ...", which would confuse us.
 case `${MAKE-make} -f conftest.make 2>/dev/null` in
   *@@@%%%=?*=@@@%%%*)
     eval ac_cv_prog_make_${ac_make}_set=yes;;
@@ -2891,7 +2905,7 @@ if test "`cd $srcdir && pwd`" != "`pwd`"; then
   am__isrc=' -I$(srcdir)'
   # test to see if srcdir already configured
   if test -f $srcdir/config.status; then
-    as_fn_error "source directory already configured; run \"make distclean\" there first" "$LINENO" 5
+    as_fn_error $? "source directory already configured; run \"make distclean\" there first" "$LINENO" 5
   fi
 fi
 
@@ -2937,11 +2951,11 @@ MAKEINFO=${MAKEINFO-"${am_missing_run}makeinfo"}
 
 # We need awk for the "check" target.  The system "awk" is bad on
 # some platforms.
-# Always define AMTAR for backward compatibility.
-
-AMTAR=${AMTAR-"${am_missing_run}tar"}
+# Always define AMTAR for backward compatibility.  Yes, it's still used
+# in the wild :-(  We should find a proper way to deprecate it ...
+AMTAR='$${TAR-tar}'
 
-am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'
+am__tar='$${TAR-tar} chof - "$$tardir"' am__untar='$${TAR-tar} xf -'
 
 
 
@@ -2981,7 +2995,7 @@ if test -n "$ac_tool_prefix"; then
 set dummy ${ac_tool_prefix}gcc; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CC+set}" = set; then :
+if ${ac_cv_prog_CC+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$CC"; then
@@ -3021,7 +3035,7 @@ if test -z "$ac_cv_prog_CC"; then
 set dummy gcc; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_CC+set}" = set; then :
+if ${ac_cv_prog_ac_ct_CC+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_CC"; then
@@ -3074,7 +3088,7 @@ if test -z "$CC"; then
 set dummy ${ac_tool_prefix}cc; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CC+set}" = set; then :
+if ${ac_cv_prog_CC+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$CC"; then
@@ -3114,7 +3128,7 @@ if test -z "$CC"; then
 set dummy cc; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CC+set}" = set; then :
+if ${ac_cv_prog_CC+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$CC"; then
@@ -3173,7 +3187,7 @@ if test -z "$CC"; then
 set dummy $ac_tool_prefix$ac_prog; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CC+set}" = set; then :
+if ${ac_cv_prog_CC+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$CC"; then
@@ -3217,7 +3231,7 @@ do
 set dummy $ac_prog; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_CC+set}" = set; then :
+if ${ac_cv_prog_ac_ct_CC+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_CC"; then
@@ -3271,8 +3285,8 @@ fi
 
 test -z "$CC" && { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "no acceptable C compiler found in \$PATH
-See \`config.log' for more details." "$LINENO" 5; }
+as_fn_error $? "no acceptable C compiler found in \$PATH
+See \`config.log' for more details" "$LINENO" 5; }
 
 # Provide some information about the compiler.
 $as_echo "$as_me:${as_lineno-$LINENO}: checking for C compiler version" >&5
@@ -3386,9 +3400,8 @@ sed 's/^/| /' conftest.$ac_ext >&5
 
 { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "C compiler cannot create executables
-See \`config.log' for more details." "$LINENO" 5; }; }
+as_fn_error 77 "C compiler cannot create executables
+See \`config.log' for more details" "$LINENO" 5; }
 else
   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
 $as_echo "yes" >&6; }
@@ -3430,8 +3443,8 @@ done
 else
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot compute suffix of executables: cannot compile and link
-See \`config.log' for more details." "$LINENO" 5; }
+as_fn_error $? "cannot compute suffix of executables: cannot compile and link
+See \`config.log' for more details" "$LINENO" 5; }
 fi
 rm -f conftest conftest$ac_cv_exeext
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_exeext" >&5
@@ -3488,9 +3501,9 @@ $as_echo "$ac_try_echo"; } >&5
     else
 	{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot run C compiled programs.
+as_fn_error $? "cannot run C compiled programs.
 If you meant to cross compile, use \`--host'.
-See \`config.log' for more details." "$LINENO" 5; }
+See \`config.log' for more details" "$LINENO" 5; }
     fi
   fi
 fi
@@ -3501,7 +3514,7 @@ rm -f conftest.$ac_ext conftest$ac_cv_exeext conftest.out
 ac_clean_files=$ac_clean_files_save
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for suffix of object files" >&5
 $as_echo_n "checking for suffix of object files... " >&6; }
-if test "${ac_cv_objext+set}" = set; then :
+if ${ac_cv_objext+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -3541,8 +3554,8 @@ sed 's/^/| /' conftest.$ac_ext >&5
 
 { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot compute suffix of object files: cannot compile
-See \`config.log' for more details." "$LINENO" 5; }
+as_fn_error $? "cannot compute suffix of object files: cannot compile
+See \`config.log' for more details" "$LINENO" 5; }
 fi
 rm -f conftest.$ac_cv_objext conftest.$ac_ext
 fi
@@ -3552,7 +3565,7 @@ OBJEXT=$ac_cv_objext
 ac_objext=$OBJEXT
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether we are using the GNU C compiler" >&5
 $as_echo_n "checking whether we are using the GNU C compiler... " >&6; }
-if test "${ac_cv_c_compiler_gnu+set}" = set; then :
+if ${ac_cv_c_compiler_gnu+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -3589,7 +3602,7 @@ ac_test_CFLAGS=${CFLAGS+set}
 ac_save_CFLAGS=$CFLAGS
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC accepts -g" >&5
 $as_echo_n "checking whether $CC accepts -g... " >&6; }
-if test "${ac_cv_prog_cc_g+set}" = set; then :
+if ${ac_cv_prog_cc_g+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_save_c_werror_flag=$ac_c_werror_flag
@@ -3667,7 +3680,7 @@ else
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $CC option to accept ISO C89" >&5
 $as_echo_n "checking for $CC option to accept ISO C89... " >&6; }
-if test "${ac_cv_prog_cc_c89+set}" = set; then :
+if ${ac_cv_prog_cc_c89+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_cv_prog_cc_c89=no
@@ -3813,6 +3826,7 @@ fi
 if test "x$enable_dependency_tracking" != xno; then
   am_depcomp="$ac_aux_dir/depcomp"
   AMDEPBACKSLASH='\'
+  am__nodep='_no'
 fi
  if test "x$enable_dependency_tracking" != xno; then
   AMDEP_TRUE=
@@ -3828,7 +3842,7 @@ depcc="$CC"   am_compiler_list=
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
 $as_echo_n "checking dependency style of $depcc... " >&6; }
-if test "${am_cv_CC_dependencies_compiler_type+set}" = set; then :
+if ${am_cv_CC_dependencies_compiler_type+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
@@ -3837,6 +3851,7 @@ else
   # instance it was reported that on HP-UX the gcc test will end up
   # making a dummy file named `D' -- because `-MD' means `put the output
   # in D'.
+  rm -rf conftest.dir
   mkdir conftest.dir
   # Copy depcomp to subdir because otherwise we won't find it if we're
   # using a relative directory.
@@ -3896,7 +3911,7 @@ else
 	break
       fi
       ;;
-    msvisualcpp | msvcmsys)
+    msvc7 | msvc7msys | msvisualcpp | msvcmsys)
       # This compiler won't grok `-c -o', but also, the minuso test has
       # not run yet.  These depmodes are late enough in the game, and
       # so weak that their functioning should not be impacted.
@@ -3967,7 +3982,7 @@ if test -n "$ac_tool_prefix"; then
 set dummy ${ac_tool_prefix}ranlib; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_RANLIB+set}" = set; then :
+if ${ac_cv_prog_RANLIB+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$RANLIB"; then
@@ -4007,7 +4022,7 @@ if test -z "$ac_cv_prog_RANLIB"; then
 set dummy ranlib; ac_word=$2
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
 $as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_RANLIB+set}" = set; then :
+if ${ac_cv_prog_ac_ct_RANLIB+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -n "$ac_ct_RANLIB"; then
@@ -4069,7 +4084,7 @@ fi
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for an ANSI C-conforming const" >&5
 $as_echo_n "checking for an ANSI C-conforming const... " >&6; }
-if test "${ac_cv_c_const+set}" = set; then :
+if ${ac_cv_c_const+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -4159,7 +4174,7 @@ if test -n "$CPP" && test -d "$CPP"; then
   CPP=
 fi
 if test -z "$CPP"; then
-  if test "${ac_cv_prog_CPP+set}" = set; then :
+  if ${ac_cv_prog_CPP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
       # Double quotes because CPP needs to be expanded
@@ -4189,7 +4204,7 @@ else
   # Broken: fails on valid input.
 continue
 fi
-rm -f conftest.err conftest.$ac_ext
+rm -f conftest.err conftest.i conftest.$ac_ext
 
   # OK, works on sane cases.  Now check whether nonexistent headers
   # can be detected and how.
@@ -4205,11 +4220,11 @@ else
 ac_preproc_ok=:
 break
 fi
-rm -f conftest.err conftest.$ac_ext
+rm -f conftest.err conftest.i conftest.$ac_ext
 
 done
 # Because of `break', _AC_PREPROC_IFELSE's cleaning code was skipped.
-rm -f conftest.err conftest.$ac_ext
+rm -f conftest.i conftest.err conftest.$ac_ext
 if $ac_preproc_ok; then :
   break
 fi
@@ -4248,7 +4263,7 @@ else
   # Broken: fails on valid input.
 continue
 fi
-rm -f conftest.err conftest.$ac_ext
+rm -f conftest.err conftest.i conftest.$ac_ext
 
   # OK, works on sane cases.  Now check whether nonexistent headers
   # can be detected and how.
@@ -4264,18 +4279,18 @@ else
 ac_preproc_ok=:
 break
 fi
-rm -f conftest.err conftest.$ac_ext
+rm -f conftest.err conftest.i conftest.$ac_ext
 
 done
 # Because of `break', _AC_PREPROC_IFELSE's cleaning code was skipped.
-rm -f conftest.err conftest.$ac_ext
+rm -f conftest.i conftest.err conftest.$ac_ext
 if $ac_preproc_ok; then :
 
 else
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "C preprocessor \"$CPP\" fails sanity check
-See \`config.log' for more details." "$LINENO" 5; }
+as_fn_error $? "C preprocessor \"$CPP\" fails sanity check
+See \`config.log' for more details" "$LINENO" 5; }
 fi
 
 ac_ext=c
@@ -4287,7 +4302,7 @@ ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for grep that handles long lines and -e" >&5
 $as_echo_n "checking for grep that handles long lines and -e... " >&6; }
-if test "${ac_cv_path_GREP+set}" = set; then :
+if ${ac_cv_path_GREP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if test -z "$GREP"; then
@@ -4336,7 +4351,7 @@ esac
   done
 IFS=$as_save_IFS
   if test -z "$ac_cv_path_GREP"; then
-    as_fn_error "no acceptable grep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+    as_fn_error $? "no acceptable grep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
   fi
 else
   ac_cv_path_GREP=$GREP
@@ -4350,7 +4365,7 @@ $as_echo "$ac_cv_path_GREP" >&6; }
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for egrep" >&5
 $as_echo_n "checking for egrep... " >&6; }
-if test "${ac_cv_path_EGREP+set}" = set; then :
+if ${ac_cv_path_EGREP+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if echo a | $GREP -E '(a|b)' >/dev/null 2>&1
@@ -4402,7 +4417,7 @@ esac
   done
 IFS=$as_save_IFS
   if test -z "$ac_cv_path_EGREP"; then
-    as_fn_error "no acceptable egrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+    as_fn_error $? "no acceptable egrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
   fi
 else
   ac_cv_path_EGREP=$EGREP
@@ -4417,7 +4432,7 @@ $as_echo "$ac_cv_path_EGREP" >&6; }
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for ANSI C header files" >&5
 $as_echo_n "checking for ANSI C header files... " >&6; }
-if test "${ac_cv_header_stdc+set}" = set; then :
+if ${ac_cv_header_stdc+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -4536,8 +4551,7 @@ do :
   as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
 ac_fn_c_check_header_compile "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default
 "
-eval as_val=\$$as_ac_Header
-   if test "x$as_val" = x""yes; then :
+if eval test \"x\$"$as_ac_Header"\" = x"yes"; then :
   cat >>confdefs.h <<_ACEOF
 #define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
 _ACEOF
@@ -4550,7 +4564,7 @@ done
 for ac_header in string.h
 do :
   ac_fn_c_check_header_mongrel "$LINENO" "string.h" "ac_cv_header_string_h" "$ac_includes_default"
-if test "x$ac_cv_header_string_h" = x""yes; then :
+if test "x$ac_cv_header_string_h" = xyes; then :
   cat >>confdefs.h <<_ACEOF
 #define HAVE_STRING_H 1
 _ACEOF
@@ -4560,7 +4574,7 @@ fi
 done
 
 ac_fn_c_check_type "$LINENO" "size_t" "ac_cv_type_size_t" "$ac_includes_default"
-if test "x$ac_cv_type_size_t" = x""yes; then :
+if test "x$ac_cv_type_size_t" = xyes; then :
 
 else
 
@@ -4574,8 +4588,7 @@ for ac_func in memcpy pwrite pread mkstemp
 do :
   as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
 ac_fn_c_check_func "$LINENO" "$ac_func" "$as_ac_var"
-eval as_val=\$$as_ac_var
-   if test "x$as_val" = x""yes; then :
+if eval test \"x\$"$as_ac_var"\" = x"yes"; then :
   cat >>confdefs.h <<_ACEOF
 #define `$as_echo "HAVE_$ac_func" | $as_tr_cpp` 1
 _ACEOF
@@ -4586,7 +4599,7 @@ done
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for socklen_t" >&5
 $as_echo_n "checking for socklen_t... " >&6; }
-if test "${ac_cv_type_socklen_t+set}" = set; then :
+if ${ac_cv_type_socklen_t+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -4620,7 +4633,7 @@ $as_echo "#define socklen_t int" >>confdefs.h
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for in_port_t" >&5
 $as_echo_n "checking for in_port_t... " >&6; }
-if test "${ac_cv_type_in_port_t+set}" = set; then :
+if ${ac_cv_type_in_port_t+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -4653,8 +4666,8 @@ if test "$ac_cv_type_in_port_t" != yes; then
     if test "$cross_compiling" = yes; then :
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot run test program while cross compiling
-See \`config.log' for more details." "$LINENO" 5; }
+as_fn_error $? "cannot run test program while cross compiling
+See \`config.log' for more details" "$LINENO" 5; }
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
@@ -4678,8 +4691,8 @@ fi
     if test "$cross_compiling" = yes; then :
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot run test program while cross compiling
-See \`config.log' for more details." "$LINENO" 5; }
+as_fn_error $? "cannot run test program while cross compiling
+See \`config.log' for more details" "$LINENO" 5; }
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
@@ -4703,8 +4716,8 @@ fi
     if test "$cross_compiling" = yes; then :
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot run test program while cross compiling
-See \`config.log' for more details." "$LINENO" 5; }
+as_fn_error $? "cannot run test program while cross compiling
+See \`config.log' for more details" "$LINENO" 5; }
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
@@ -4728,8 +4741,8 @@ fi
     if test "$cross_compiling" = yes; then :
   { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot run test program while cross compiling
-See \`config.log' for more details." "$LINENO" 5; }
+as_fn_error $? "cannot run test program while cross compiling
+See \`config.log' for more details" "$LINENO" 5; }
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
@@ -4751,7 +4764,7 @@ rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
 fi
 
     if test "$ac_cv_sin_port_size" = unknown; then
-	as_fn_error "Failed to get size of sin_port in struct sockaddr_in." "$LINENO" 5
+	as_fn_error $? "Failed to get size of sin_port in struct sockaddr_in." "$LINENO" 5
     fi
 
 cat >>confdefs.h <<_ACEOF
@@ -4761,7 +4774,7 @@ _ACEOF
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for h_errno declaration in netdb.h" >&5
 $as_echo_n "checking for h_errno declaration in netdb.h... " >&6; }
-if test "${ac_cv_decl_h_errno+set}" = set; then :
+if ${ac_cv_decl_h_errno+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
@@ -4795,7 +4808,7 @@ fi
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for socket in -lsocket" >&5
 $as_echo_n "checking for socket in -lsocket... " >&6; }
-if test "${ac_cv_lib_socket_socket+set}" = set; then :
+if ${ac_cv_lib_socket_socket+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_check_lib_save_LIBS=$LIBS
@@ -4829,7 +4842,7 @@ LIBS=$ac_check_lib_save_LIBS
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_socket_socket" >&5
 $as_echo "$ac_cv_lib_socket_socket" >&6; }
-if test "x$ac_cv_lib_socket_socket" = x""yes; then :
+if test "x$ac_cv_lib_socket_socket" = xyes; then :
   cat >>confdefs.h <<_ACEOF
 #define HAVE_LIBSOCKET 1
 _ACEOF
@@ -4839,23 +4852,66 @@ _ACEOF
 fi
 
 
-for ac_func in getaddrinfo
-do :
-  ac_fn_c_check_func "$LINENO" "getaddrinfo" "ac_cv_func_getaddrinfo"
-if test "x$ac_cv_func_getaddrinfo" = x""yes; then :
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for curl_easy_init in -lcurl" >&5
+$as_echo_n "checking for curl_easy_init in -lcurl... " >&6; }
+if ${ac_cv_lib_curl_curl_easy_init+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_check_lib_save_LIBS=$LIBS
+LIBS="-lcurl  $LIBS"
+cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+char curl_easy_init ();
+int
+main ()
+{
+return curl_easy_init ();
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  ac_cv_lib_curl_curl_easy_init=yes
+else
+  ac_cv_lib_curl_curl_easy_init=no
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+LIBS=$ac_check_lib_save_LIBS
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_curl_curl_easy_init" >&5
+$as_echo "$ac_cv_lib_curl_curl_easy_init" >&6; }
+if test "x$ac_cv_lib_curl_curl_easy_init" = xyes; then :
   cat >>confdefs.h <<_ACEOF
-#define HAVE_GETADDRINFO 1
+#define HAVE_LIBCURL 1
 _ACEOF
 
+  LIBS="-lcurl $LIBS"
+
+else
+  as_fn_error $? "libcurl not found." "$LINENO" 5
+fi
+
+
+ac_fn_c_check_func "$LINENO" "getaddrinfo" "ac_cv_func_getaddrinfo"
+if test "x$ac_cv_func_getaddrinfo" = xyes; then :
+  $as_echo "#define HAVE_GETADDRINFO 1" >>confdefs.h
+
 else
   case " $LIBOBJS " in
-  *" $ac_func.$ac_objext "* ) ;;
-  *) LIBOBJS="$LIBOBJS $ac_func.$ac_objext"
+  *" getaddrinfo.$ac_objext "* ) ;;
+  *) LIBOBJS="$LIBOBJS getaddrinfo.$ac_objext"
  ;;
 esac
 
 fi
-done
 
 
 
@@ -4868,7 +4924,7 @@ if test "$enable_largefile" != no; then
 
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for special C compiler options needed for large files" >&5
 $as_echo_n "checking for special C compiler options needed for large files... " >&6; }
-if test "${ac_cv_sys_largefile_CC+set}" = set; then :
+if ${ac_cv_sys_largefile_CC+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   ac_cv_sys_largefile_CC=no
@@ -4919,7 +4975,7 @@ $as_echo "$ac_cv_sys_largefile_CC" >&6; }
 
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for _FILE_OFFSET_BITS value needed for large files" >&5
 $as_echo_n "checking for _FILE_OFFSET_BITS value needed for large files... " >&6; }
-if test "${ac_cv_sys_file_offset_bits+set}" = set; then :
+if ${ac_cv_sys_file_offset_bits+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   while :; do
@@ -4988,7 +5044,7 @@ rm -rf conftest*
   if test $ac_cv_sys_file_offset_bits = unknown; then
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for _LARGE_FILES value needed for large files" >&5
 $as_echo_n "checking for _LARGE_FILES value needed for large files... " >&6; }
-if test "${ac_cv_sys_large_files+set}" = set; then :
+if ${ac_cv_sys_large_files+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   while :; do
@@ -5059,7 +5115,7 @@ fi
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for _LARGEFILE_SOURCE value needed for large files" >&5
 $as_echo_n "checking for _LARGEFILE_SOURCE value needed for large files... " >&6; }
-if test "${ac_cv_sys_largefile_source+set}" = set; then :
+if ${ac_cv_sys_largefile_source+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   while :; do
@@ -5131,7 +5187,7 @@ fi
 # This bug is HP SR number 8606223364.
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking size of size_t" >&5
 $as_echo_n "checking size of size_t... " >&6; }
-if test "${ac_cv_sizeof_size_t+set}" = set; then :
+if ${ac_cv_sizeof_size_t+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (size_t))" "ac_cv_sizeof_size_t"        "$ac_includes_default"; then :
@@ -5140,9 +5196,8 @@ else
   if test "$ac_cv_type_size_t" = yes; then
      { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "cannot compute sizeof (size_t)
-See \`config.log' for more details." "$LINENO" 5; }; }
+as_fn_error 77 "cannot compute sizeof (size_t)
+See \`config.log' for more details" "$LINENO" 5; }
    else
      ac_cv_sizeof_size_t=0
    fi
@@ -5165,7 +5220,7 @@ _ACEOF
 # This bug is HP SR number 8606223364.
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking size of off_t" >&5
 $as_echo_n "checking size of off_t... " >&6; }
-if test "${ac_cv_sizeof_off_t+set}" = set; then :
+if ${ac_cv_sizeof_off_t+:} false; then :
   $as_echo_n "(cached) " >&6
 else
   if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (off_t))" "ac_cv_sizeof_off_t"        "$ac_includes_default"; then :
@@ -5174,9 +5229,8 @@ else
   if test "$ac_cv_type_off_t" = yes; then
      { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
 $as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "cannot compute sizeof (off_t)
-See \`config.log' for more details." "$LINENO" 5; }; }
+as_fn_error 77 "cannot compute sizeof (off_t)
+See \`config.log' for more details" "$LINENO" 5; }
    else
      ac_cv_sizeof_off_t=0
    fi
@@ -5345,10 +5399,21 @@ $as_echo "$as_me: WARNING: cache variable $ac_var contains a newline" >&2;} ;;
      :end' >>confcache
 if diff "$cache_file" confcache >/dev/null 2>&1; then :; else
   if test -w "$cache_file"; then
-    test "x$cache_file" != "x/dev/null" &&
+    if test "x$cache_file" != "x/dev/null"; then
       { $as_echo "$as_me:${as_lineno-$LINENO}: updating cache $cache_file" >&5
 $as_echo "$as_me: updating cache $cache_file" >&6;}
-    cat confcache >$cache_file
+      if test ! -f "$cache_file" || test -h "$cache_file"; then
+	cat confcache >"$cache_file"
+      else
+        case $cache_file in #(
+        */* | ?:*)
+	  mv -f confcache "$cache_file"$$ &&
+	  mv -f "$cache_file"$$ "$cache_file" ;; #(
+        *)
+	  mv -f confcache "$cache_file" ;;
+	esac
+      fi
+    fi
   else
     { $as_echo "$as_me:${as_lineno-$LINENO}: not updating unwritable cache $cache_file" >&5
 $as_echo "$as_me: not updating unwritable cache $cache_file" >&6;}
@@ -5364,6 +5429,7 @@ DEFS=-DHAVE_CONFIG_H
 
 ac_libobjs=
 ac_ltlibobjs=
+U=
 for ac_i in : $LIBOBJS; do test "x$ac_i" = x: && continue
   # 1. Remove the extension, and $U if already installed.
   ac_script='s/\$U\././;s/\.o$//;s/\.obj$//'
@@ -5387,23 +5453,23 @@ else
 fi
 
 if test -z "${MAINTAINER_MODE_TRUE}" && test -z "${MAINTAINER_MODE_FALSE}"; then
-  as_fn_error "conditional \"MAINTAINER_MODE\" was never defined.
+  as_fn_error $? "conditional \"MAINTAINER_MODE\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
 if test -z "${AMDEP_TRUE}" && test -z "${AMDEP_FALSE}"; then
-  as_fn_error "conditional \"AMDEP\" was never defined.
+  as_fn_error $? "conditional \"AMDEP\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
 if test -z "${am__fastdepCC_TRUE}" && test -z "${am__fastdepCC_FALSE}"; then
-  as_fn_error "conditional \"am__fastdepCC\" was never defined.
+  as_fn_error $? "conditional \"am__fastdepCC\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
 if test -z "${MINGW32_TRUE}" && test -z "${MINGW32_FALSE}"; then
-  as_fn_error "conditional \"MINGW32\" was never defined.
+  as_fn_error $? "conditional \"MINGW32\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
 
-: ${CONFIG_STATUS=./config.status}
+: "${CONFIG_STATUS=./config.status}"
 ac_write_fail=0
 ac_clean_files_save=$ac_clean_files
 ac_clean_files="$ac_clean_files $CONFIG_STATUS"
@@ -5504,6 +5570,7 @@ fi
 IFS=" ""	$as_nl"
 
 # Find who we are.  Look in the path if we contain no directory separator.
+as_myself=
 case $0 in #((
   *[\\/]* ) as_myself=$0 ;;
   *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
@@ -5549,19 +5616,19 @@ export LANGUAGE
 (unset CDPATH) >/dev/null 2>&1 && unset CDPATH
 
 
-# as_fn_error ERROR [LINENO LOG_FD]
-# ---------------------------------
+# as_fn_error STATUS ERROR [LINENO LOG_FD]
+# ----------------------------------------
 # Output "`basename $0`: error: ERROR" to stderr. If LINENO and LOG_FD are
 # provided, also output the error to LOG_FD, referencing LINENO. Then exit the
-# script with status $?, using 1 if that was 0.
+# script with STATUS, using 1 if that was 0.
 as_fn_error ()
 {
-  as_status=$?; test $as_status -eq 0 && as_status=1
-  if test "$3"; then
-    as_lineno=${as_lineno-"$2"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-    $as_echo "$as_me:${as_lineno-$LINENO}: error: $1" >&$3
+  as_status=$1; test $as_status -eq 0 && as_status=1
+  if test "$4"; then
+    as_lineno=${as_lineno-"$3"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+    $as_echo "$as_me:${as_lineno-$LINENO}: error: $2" >&$4
   fi
-  $as_echo "$as_me: error: $1" >&2
+  $as_echo "$as_me: error: $2" >&2
   as_fn_exit $as_status
 } # as_fn_error
 
@@ -5757,7 +5824,7 @@ $as_echo X"$as_dir" |
       test -d "$as_dir" && break
     done
     test -z "$as_dirs" || eval "mkdir $as_dirs"
-  } || test -d "$as_dir" || as_fn_error "cannot create directory $as_dir"
+  } || test -d "$as_dir" || as_fn_error $? "cannot create directory $as_dir"
 
 
 } # as_fn_mkdir_p
@@ -5811,7 +5878,7 @@ cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 # values after options handling.
 ac_log="
 This file was extended by zsync $as_me 0.6.2, which was
-generated by GNU Autoconf 2.65.  Invocation command line was
+generated by GNU Autoconf 2.68.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
   CONFIG_HEADERS  = $CONFIG_HEADERS
@@ -5877,10 +5944,10 @@ cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 ac_cs_config="`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`"
 ac_cs_version="\\
 zsync config.status 0.6.2
-configured by $0, generated by GNU Autoconf 2.65,
+configured by $0, generated by GNU Autoconf 2.68,
   with options \\"\$ac_cs_config\\"
 
-Copyright (C) 2009 Free Software Foundation, Inc.
+Copyright (C) 2010 Free Software Foundation, Inc.
 This config.status script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it."
 
@@ -5898,11 +5965,16 @@ ac_need_defaults=:
 while test $# != 0
 do
   case $1 in
-  --*=*)
+  --*=?*)
     ac_option=`expr "X$1" : 'X\([^=]*\)='`
     ac_optarg=`expr "X$1" : 'X[^=]*=\(.*\)'`
     ac_shift=:
     ;;
+  --*=)
+    ac_option=`expr "X$1" : 'X\([^=]*\)='`
+    ac_optarg=
+    ac_shift=:
+    ;;
   *)
     ac_option=$1
     ac_optarg=$2
@@ -5924,6 +5996,7 @@ do
     $ac_shift
     case $ac_optarg in
     *\'*) ac_optarg=`$as_echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"` ;;
+    '') as_fn_error $? "missing file argument" ;;
     esac
     as_fn_append CONFIG_FILES " '$ac_optarg'"
     ac_need_defaults=false;;
@@ -5936,7 +6009,7 @@ do
     ac_need_defaults=false;;
   --he | --h)
     # Conflict between --help and --header
-    as_fn_error "ambiguous option: \`$1'
+    as_fn_error $? "ambiguous option: \`$1'
 Try \`$0 --help' for more information.";;
   --help | --hel | -h )
     $as_echo "$ac_cs_usage"; exit ;;
@@ -5945,7 +6018,7 @@ Try \`$0 --help' for more information.";;
     ac_cs_silent=: ;;
 
   # This is an error.
-  -*) as_fn_error "unrecognized option: \`$1'
+  -*) as_fn_error $? "unrecognized option: \`$1'
 Try \`$0 --help' for more information." ;;
 
   *) as_fn_append ac_config_targets " $1"
@@ -6007,7 +6080,7 @@ do
     "libzsync/Makefile") CONFIG_FILES="$CONFIG_FILES libzsync/Makefile" ;;
     "doc/Makefile") CONFIG_FILES="$CONFIG_FILES doc/Makefile" ;;
 
-  *) as_fn_error "invalid argument: \`$ac_config_target'" "$LINENO" 5;;
+  *) as_fn_error $? "invalid argument: \`$ac_config_target'" "$LINENO" 5;;
   esac
 done
 
@@ -6030,9 +6103,10 @@ fi
 # after its creation but before its name has been assigned to `$tmp'.
 $debug ||
 {
-  tmp=
+  tmp= ac_tmp=
   trap 'exit_status=$?
-  { test -z "$tmp" || test ! -d "$tmp" || rm -fr "$tmp"; } && exit $exit_status
+  : "${ac_tmp:=$tmp}"
+  { test ! -d "$ac_tmp" || rm -fr "$ac_tmp"; } && exit $exit_status
 ' 0
   trap 'as_fn_exit 1' 1 2 13 15
 }
@@ -6040,12 +6114,13 @@ $debug ||
 
 {
   tmp=`(umask 077 && mktemp -d "./confXXXXXX") 2>/dev/null` &&
-  test -n "$tmp" && test -d "$tmp"
+  test -d "$tmp"
 }  ||
 {
   tmp=./conf$$-$RANDOM
   (umask 077 && mkdir "$tmp")
-} || as_fn_error "cannot create a temporary directory in ." "$LINENO" 5
+} || as_fn_error $? "cannot create a temporary directory in ." "$LINENO" 5
+ac_tmp=$tmp
 
 # Set up the scripts for CONFIG_FILES section.
 # No need to generate them if there are no CONFIG_FILES.
@@ -6062,12 +6137,12 @@ if test "x$ac_cr" = x; then
 fi
 ac_cs_awk_cr=`$AWK 'BEGIN { print "a\rb" }' </dev/null 2>/dev/null`
 if test "$ac_cs_awk_cr" = "a${ac_cr}b"; then
-  ac_cs_awk_cr='\r'
+  ac_cs_awk_cr='\\r'
 else
   ac_cs_awk_cr=$ac_cr
 fi
 
-echo 'BEGIN {' >"$tmp/subs1.awk" &&
+echo 'BEGIN {' >"$ac_tmp/subs1.awk" &&
 _ACEOF
 
 
@@ -6076,18 +6151,18 @@ _ACEOF
   echo "$ac_subst_vars" | sed 's/.*/&!$&$ac_delim/' &&
   echo "_ACEOF"
 } >conf$$subs.sh ||
-  as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
-ac_delim_num=`echo "$ac_subst_vars" | grep -c '$'`
+  as_fn_error $? "could not make $CONFIG_STATUS" "$LINENO" 5
+ac_delim_num=`echo "$ac_subst_vars" | grep -c '^'`
 ac_delim='%!_!# '
 for ac_last_try in false false false false false :; do
   . ./conf$$subs.sh ||
-    as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
+    as_fn_error $? "could not make $CONFIG_STATUS" "$LINENO" 5
 
   ac_delim_n=`sed -n "s/.*$ac_delim\$/X/p" conf$$subs.awk | grep -c X`
   if test $ac_delim_n = $ac_delim_num; then
     break
   elif $ac_last_try; then
-    as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
+    as_fn_error $? "could not make $CONFIG_STATUS" "$LINENO" 5
   else
     ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
   fi
@@ -6095,7 +6170,7 @@ done
 rm -f conf$$subs.sh
 
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-cat >>"\$tmp/subs1.awk" <<\\_ACAWK &&
+cat >>"\$ac_tmp/subs1.awk" <<\\_ACAWK &&
 _ACEOF
 sed -n '
 h
@@ -6143,7 +6218,7 @@ t delim
 rm -f conf$$subs.awk
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 _ACAWK
-cat >>"\$tmp/subs1.awk" <<_ACAWK &&
+cat >>"\$ac_tmp/subs1.awk" <<_ACAWK &&
   for (key in S) S_is_set[key] = 1
   FS = ""
 
@@ -6175,21 +6250,29 @@ if sed "s/$ac_cr//" < /dev/null > /dev/null 2>&1; then
   sed "s/$ac_cr\$//; s/$ac_cr/$ac_cs_awk_cr/g"
 else
   cat
-fi < "$tmp/subs1.awk" > "$tmp/subs.awk" \
-  || as_fn_error "could not setup config files machinery" "$LINENO" 5
+fi < "$ac_tmp/subs1.awk" > "$ac_tmp/subs.awk" \
+  || as_fn_error $? "could not setup config files machinery" "$LINENO" 5
 _ACEOF
 
-# VPATH may cause trouble with some makes, so we remove $(srcdir),
-# ${srcdir} and @srcdir@ from VPATH if srcdir is ".", strip leading and
+# VPATH may cause trouble with some makes, so we remove sole $(srcdir),
+# ${srcdir} and @srcdir@ entries from VPATH if srcdir is ".", strip leading and
 # trailing colons and then remove the whole line if VPATH becomes empty
 # (actually we leave an empty line to preserve line numbers).
 if test "x$srcdir" = x.; then
-  ac_vpsub='/^[	 ]*VPATH[	 ]*=/{
-s/:*\$(srcdir):*/:/
-s/:*\${srcdir}:*/:/
-s/:*@srcdir@:*/:/
-s/^\([^=]*=[	 ]*\):*/\1/
+  ac_vpsub='/^[	 ]*VPATH[	 ]*=[	 ]*/{
+h
+s///
+s/^/:/
+s/[	 ]*$/:/
+s/:\$(srcdir):/:/g
+s/:\${srcdir}:/:/g
+s/:@srcdir@:/:/g
+s/^:*//
 s/:*$//
+x
+s/\(=[	 ]*\).*/\1/
+G
+s/\n//
 s/^[^=]*=[	 ]*$//
 }'
 fi
@@ -6201,7 +6284,7 @@ fi # test -n "$CONFIG_FILES"
 # No need to generate them if there are no CONFIG_HEADERS.
 # This happens for instance with `./config.status Makefile'.
 if test -n "$CONFIG_HEADERS"; then
-cat >"$tmp/defines.awk" <<\_ACAWK ||
+cat >"$ac_tmp/defines.awk" <<\_ACAWK ||
 BEGIN {
 _ACEOF
 
@@ -6213,11 +6296,11 @@ _ACEOF
 # handling of long lines.
 ac_delim='%!_!# '
 for ac_last_try in false false :; do
-  ac_t=`sed -n "/$ac_delim/p" confdefs.h`
-  if test -z "$ac_t"; then
+  ac_tt=`sed -n "/$ac_delim/p" confdefs.h`
+  if test -z "$ac_tt"; then
     break
   elif $ac_last_try; then
-    as_fn_error "could not make $CONFIG_HEADERS" "$LINENO" 5
+    as_fn_error $? "could not make $CONFIG_HEADERS" "$LINENO" 5
   else
     ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
   fi
@@ -6302,7 +6385,7 @@ cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 _ACAWK
 _ACEOF
 cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-  as_fn_error "could not setup config headers machinery" "$LINENO" 5
+  as_fn_error $? "could not setup config headers machinery" "$LINENO" 5
 fi # test -n "$CONFIG_HEADERS"
 
 
@@ -6315,7 +6398,7 @@ do
   esac
   case $ac_mode$ac_tag in
   :[FHL]*:*);;
-  :L* | :C*:*) as_fn_error "invalid tag \`$ac_tag'" "$LINENO" 5;;
+  :L* | :C*:*) as_fn_error $? "invalid tag \`$ac_tag'" "$LINENO" 5;;
   :[FH]-) ac_tag=-:-;;
   :[FH]*) ac_tag=$ac_tag:$ac_tag.in;;
   esac
@@ -6334,7 +6417,7 @@ do
     for ac_f
     do
       case $ac_f in
-      -) ac_f="$tmp/stdin";;
+      -) ac_f="$ac_tmp/stdin";;
       *) # Look for the file first in the build tree, then in the source tree
 	 # (if the path is not absolute).  The absolute path cannot be DOS-style,
 	 # because $ac_f cannot contain `:'.
@@ -6343,7 +6426,7 @@ do
 	   [\\/$]*) false;;
 	   *) test -f "$srcdir/$ac_f" && ac_f="$srcdir/$ac_f";;
 	   esac ||
-	   as_fn_error "cannot find input file: \`$ac_f'" "$LINENO" 5;;
+	   as_fn_error 1 "cannot find input file: \`$ac_f'" "$LINENO" 5;;
       esac
       case $ac_f in *\'*) ac_f=`$as_echo "$ac_f" | sed "s/'/'\\\\\\\\''/g"`;; esac
       as_fn_append ac_file_inputs " '$ac_f'"
@@ -6369,8 +6452,8 @@ $as_echo "$as_me: creating $ac_file" >&6;}
     esac
 
     case $ac_tag in
-    *:-:* | *:-) cat >"$tmp/stdin" \
-      || as_fn_error "could not create $ac_file" "$LINENO" 5 ;;
+    *:-:* | *:-) cat >"$ac_tmp/stdin" \
+      || as_fn_error $? "could not create $ac_file" "$LINENO" 5 ;;
     esac
     ;;
   esac
@@ -6506,23 +6589,24 @@ s&@INSTALL@&$ac_INSTALL&;t t
 s&@MKDIR_P@&$ac_MKDIR_P&;t t
 $ac_datarootdir_hack
 "
-eval sed \"\$ac_sed_extra\" "$ac_file_inputs" | $AWK -f "$tmp/subs.awk" >$tmp/out \
-  || as_fn_error "could not create $ac_file" "$LINENO" 5
+eval sed \"\$ac_sed_extra\" "$ac_file_inputs" | $AWK -f "$ac_tmp/subs.awk" \
+  >$ac_tmp/out || as_fn_error $? "could not create $ac_file" "$LINENO" 5
 
 test -z "$ac_datarootdir_hack$ac_datarootdir_seen" &&
-  { ac_out=`sed -n '/\${datarootdir}/p' "$tmp/out"`; test -n "$ac_out"; } &&
-  { ac_out=`sed -n '/^[	 ]*datarootdir[	 ]*:*=/p' "$tmp/out"`; test -z "$ac_out"; } &&
+  { ac_out=`sed -n '/\${datarootdir}/p' "$ac_tmp/out"`; test -n "$ac_out"; } &&
+  { ac_out=`sed -n '/^[	 ]*datarootdir[	 ]*:*=/p' \
+      "$ac_tmp/out"`; test -z "$ac_out"; } &&
   { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $ac_file contains a reference to the variable \`datarootdir'
-which seems to be undefined.  Please make sure it is defined." >&5
+which seems to be undefined.  Please make sure it is defined" >&5
 $as_echo "$as_me: WARNING: $ac_file contains a reference to the variable \`datarootdir'
-which seems to be undefined.  Please make sure it is defined." >&2;}
+which seems to be undefined.  Please make sure it is defined" >&2;}
 
-  rm -f "$tmp/stdin"
+  rm -f "$ac_tmp/stdin"
   case $ac_file in
-  -) cat "$tmp/out" && rm -f "$tmp/out";;
-  *) rm -f "$ac_file" && mv "$tmp/out" "$ac_file";;
+  -) cat "$ac_tmp/out" && rm -f "$ac_tmp/out";;
+  *) rm -f "$ac_file" && mv "$ac_tmp/out" "$ac_file";;
   esac \
-  || as_fn_error "could not create $ac_file" "$LINENO" 5
+  || as_fn_error $? "could not create $ac_file" "$LINENO" 5
  ;;
   :H)
   #
@@ -6531,21 +6615,21 @@ which seems to be undefined.  Please make sure it is defined." >&2;}
   if test x"$ac_file" != x-; then
     {
       $as_echo "/* $configure_input  */" \
-      && eval '$AWK -f "$tmp/defines.awk"' "$ac_file_inputs"
-    } >"$tmp/config.h" \
-      || as_fn_error "could not create $ac_file" "$LINENO" 5
-    if diff "$ac_file" "$tmp/config.h" >/dev/null 2>&1; then
+      && eval '$AWK -f "$ac_tmp/defines.awk"' "$ac_file_inputs"
+    } >"$ac_tmp/config.h" \
+      || as_fn_error $? "could not create $ac_file" "$LINENO" 5
+    if diff "$ac_file" "$ac_tmp/config.h" >/dev/null 2>&1; then
       { $as_echo "$as_me:${as_lineno-$LINENO}: $ac_file is unchanged" >&5
 $as_echo "$as_me: $ac_file is unchanged" >&6;}
     else
       rm -f "$ac_file"
-      mv "$tmp/config.h" "$ac_file" \
-	|| as_fn_error "could not create $ac_file" "$LINENO" 5
+      mv "$ac_tmp/config.h" "$ac_file" \
+	|| as_fn_error $? "could not create $ac_file" "$LINENO" 5
     fi
   else
     $as_echo "/* $configure_input  */" \
-      && eval '$AWK -f "$tmp/defines.awk"' "$ac_file_inputs" \
-      || as_fn_error "could not create -" "$LINENO" 5
+      && eval '$AWK -f "$ac_tmp/defines.awk"' "$ac_file_inputs" \
+      || as_fn_error $? "could not create -" "$LINENO" 5
   fi
 # Compute "$ac_file"'s index in $config_headers.
 _am_arg="$ac_file"
@@ -6695,7 +6779,7 @@ _ACEOF
 ac_clean_files=$ac_clean_files_save
 
 test $ac_write_fail = 0 ||
-  as_fn_error "write failure creating $CONFIG_STATUS" "$LINENO" 5
+  as_fn_error $? "write failure creating $CONFIG_STATUS" "$LINENO" 5
 
 
 # configure is writing to config.log, and then calls config.status.
@@ -6716,7 +6800,7 @@ if test "$no_create" != yes; then
   exec 5>>config.log
   # Use ||, not &&, to avoid exiting from the if with $? = 1, which
   # would make configure fail if this is the last instruction.
-  $ac_cs_success || as_fn_exit $?
+  $ac_cs_success || as_fn_exit 1
 fi
 if test -n "$ac_unrecognized_opts" && test "$enable_option_checking" != no; then
   { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: unrecognized options: $ac_unrecognized_opts" >&5
diff --git a/configure.ac b/configure.ac
index 87b0be1..fa33553 100644
--- a/configure.ac
+++ b/configure.ac
@@ -38,6 +38,8 @@ X_DECL_H_ERRNO
 dnl Solaris needs -lsocket - and we need this for the getaddrinfo test
 AC_CHECK_LIB(socket,socket)
 
+AC_CHECK_LIB(curl, curl_easy_init, [], [AC_MSG_ERROR(libcurl not found.)])
+
 AC_REPLACE_FUNCS(getaddrinfo)
 
 dnl - Large file support if available
diff --git a/doc/Makefile.in b/doc/Makefile.in
index 2a2ae71..1d0eaae 100644
--- a/doc/Makefile.in
+++ b/doc/Makefile.in
@@ -1,9 +1,9 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.11.3 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011 Free Software
+# Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -69,6 +69,12 @@ am__nobase_list = $(am__nobase_strip_setup); \
 am__base_list = \
   sed '$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;s/\n/ /g' | \
   sed '$$!N;$$!N;$$!N;$$!N;s/\n/ /g'
+am__uninstall_files_from_dir = { \
+  test -z "$$files" \
+    || { test ! -d "$$dir" && test ! -f "$$dir" && test ! -r "$$dir"; } \
+    || { echo " ( cd '$$dir' && rm -f" $$files ")"; \
+         $(am__cd) "$$dir" && rm -f $$files; }; \
+  }
 man1dir = $(mandir)/man1
 am__installdirs = "$(DESTDIR)$(man1dir)"
 NROFF = nroff
@@ -243,9 +249,7 @@ uninstall-man1:
 	  sed -n '/\.1[a-z]*$$/p'; \
 	} | sed -e 's,.*/,,;h;s,.*\.,,;s,^[^1][0-9a-z]*$$,1,;x' \
 	      -e 's,\.[0-9a-z]*$$,,;$(transform);G;s,\n,.,'`; \
-	test -z "$$files" || { \
-	  echo " ( cd '$(DESTDIR)$(man1dir)' && rm -f" $$files ")"; \
-	  cd "$(DESTDIR)$(man1dir)" && rm -f $$files; }
+	dir='$(DESTDIR)$(man1dir)'; $(am__uninstall_files_from_dir)
 tags: TAGS
 TAGS:
 
@@ -313,10 +317,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
diff --git a/doc/zsync.1 b/doc/zsync.1
index f8b04dc..17b8f1d 100644
--- a/doc/zsync.1
+++ b/doc/zsync.1
@@ -4,7 +4,7 @@
 zsync \- Partial/differential file download client over HTTP
 .SH "SYNTAX"
 .LP 
-zsync [ \-u \fIurl\fR ] [ \-i \fIinputfile\fP ] [ \-o \fIoutputfile\fP ] [ { \-s | \-q } ] [ \-k \fIfile\fR.zsync ] [ -A \fIhostname\fP=\fIusername\fR:\fIpassword\fR ] { \fIfilename\fP | \fIurl\fR }
+zsync [ \-u \fIurl\fR ] [ \-i \fIinputfile\fP ] [ \-o \fIoutputfile\fP ] [ { \-s | \-q | \-v } ] [ \-k \fIfile\fR.zsync ] [ -A \fIhostname\fP=\fIusername\fR:\fIpassword\fR ] [ \-K ] [ -C cacert ] { \fIfilename\fP | \fIurl\fR }
 .LP 
 zsync \-V
 .SH "DESCRIPTION"
@@ -20,6 +20,8 @@ zsync retrieves the rest of the target file over HTTP. Once the download is fini
 .LP 
 .TP 
 \fB\-A\fR \fIhostname\fP=\fIusername\fR:\fIpassword\fR
+\fBNOTE:\fR This option has been removed, but may be restored in the future.
+
 Specifies a username and password to be used with the given hostname. \fB-A\fR
 can be used multiple times (with different hostnames), in cases where e.g. the
 .zsync file is on a different server from the download, or there are multiple
@@ -49,7 +51,28 @@ relative URL, you need to specify where you got the .zsync file from so that
 zsync knows which server and path to use for the rest of the download (this is
 analogous to adding a <base href="..."> to a downloaded web page to make the
 links work).
+.TP
+\fB\-C\fR \fIcacert\fP
+Use the specified certificate file to verify the peer when making https connections. This option overrides the ZSYNC_CA_BUNDLE environment variable.
+.TP
+\fB\-R\fR \fIsslcert\fP
+Use the specified client-side certificate file when making https connections.
+.TP
+\fB\-S\fR \fIsslkey\fP
+Use the specified client-side private key file when making https connections.
+.TP
+\fB\-I\fR \fIinterface\fP
+Attempt to use this interface name, IP address or hostname as the source of http connections.
+.TP
+\fB\-K\fR
+Do not perform peer verification when making https connections.
+.TP
+\fB\-T\fR \fItimeout\fP
+Timeout, in seconds, per HTTP transfer. Note that zsync may make multiple HTTP transfers over the course of one run. If this option is omitted, no timeout will be set.
 .TP 
+\fB\-v\fR
+Send HTTP debugging information to stderr, including request and response headers.
+.TP
 \fB\-V\fR
 Prints the version of zsync.
 .SH "FILES"
@@ -59,6 +82,9 @@ Prints the version of zsync.
 .TP 
 \fBhttp_proxy\fP
 Should be the [http://]hostname:port for your web proxy, if one is required to access the target web server(s).
+.TP
+\fBZSYNC_CA_BUNDLE\fP
+Tells zsync to use the specified certificate file to verify the peer when making https connections. If the \fB\-C\fR option is present, this environment variable will be ignored.
 .SH "EXAMPLES"
 .LP 
 zsync \-i /var/lib/apt/lists/server.debian.org_debian_dists_etch_main_binary-i386_Packages http://zsync.moria.org.uk/s/etch/Packages.zsync 
diff --git a/format_string.h b/format_string.h
index 7b21773..eb27b22 100644
--- a/format_string.h
+++ b/format_string.h
@@ -25,7 +25,7 @@
 # ifdef PRIu64
 #  define OFF_T_PF "%" PRIu64
 # else
-#  define OFF_T_PF "%llu"
+#  define OFF_T_PF "%qu"
 # endif
 #else
 # ifdef PRIu32
diff --git a/http.c b/http.c
index c175134..2c6bfdc 100644
--- a/http.c
+++ b/http.c
@@ -43,150 +43,38 @@
 #include "url.h"
 #include "progress.h"
 #include "format_string.h"
+#include "libzsync/zsync.h"
 
-/* socket = connect_to(host, service/port)
- * Establishes a TCP connection to the named host and port (which can be
- * supplied as a service name from /etc/services. Returns the socket handle, or
- * -1 on error. */
-int connect_to(const char *node, const char *service) {
-    struct addrinfo hint;
-    struct addrinfo *ai;
-    int rc;
-
-    memset(&hint, 0, sizeof hint);
-    hint.ai_family = AF_UNSPEC;
-    hint.ai_socktype = SOCK_STREAM;
-
-    if ((rc = getaddrinfo(node, service, &hint, &ai)) != 0) {
-        perror(node);
-        return -1;
-    }
-    else {
-        struct addrinfo *p;
-        int sd = -1;
-
-        for (p = ai; sd == -1 && p != NULL; p = p->ai_next) {
-            if ((sd =
-                 socket(p->ai_family, p->ai_socktype, p->ai_protocol)) == -1) {
-                perror("socket");
-            }
-            else if (connect(sd, p->ai_addr, p->ai_addrlen) < 0) {
-                perror(node);
-                close(sd);
-                sd = -1;
-            }
-        }
-        freeaddrinfo(ai);
-        return sd;
-    }
-}
-
-/* fh = http_get_stream(filedesc, &status_code)
- * Converts a socket into a stream, and reads the first line from it as an HTTP
- * status line (response to a request that the caller should have already sent)
- * and returns the stream, and the status code to the location specified by the
- * second parameter. 
- */
-FILE *http_get_stream(int fd, int *code) {
-    FILE *f = fdopen(fd, "r");
-    char buf[256];
-    char *p;
-
-    if (fgets(buf, sizeof(buf), f) == NULL || memcmp(buf, "HTTP/1", 6) != 0
-        || (p = strchr(buf, ' ')) == NULL) {
-        *code = 0;
-        fclose(f);
-        return NULL;
-    }
-
-    *code = atoi(++p);
-
-    return f;
-}
-
-/* url = get_location_url(stream, current_url)
- * Reads the HTTP response from the given stream and extracts the Location
- * header, making this URL absolute using the current URL. Returned as a
- * malloced string.
- * (it ought to be absolute anyway, by the RFC, but many servers send 
- * relative URIs). */
-char *get_location_url(FILE * f, const char *cur_url) {
-    char buf[1024];
+#include <curl/curl.h>
 
-    while (fgets(buf, sizeof(buf), f)) {
-        char *p;
+/* Settings for HTTP connections - auth details */
+static char **auth_details; /* This is a realloced array with 3*num_auth_details entries */
+static int num_auth_details; /* The groups of 3 strings are host, user, pass */
 
-        /* exit if end of headers */
-        if (buf[0] == '\r' || buf[0] == '\n')
-            return NULL;
+/* Remember .zsync control file URL */
+char *referer;
 
-        /* Look for Location header */
-        p = strchr(buf, ':');
-        if (!p)
-            return NULL;
-        *p++ = 0;
-        if (strcasecmp(buf, "Location"))
-            continue;
+/* Should we tell curl to use a different CA path? */
+char *cacert = NULL;
 
-        /* Skip leading whitespace */
-        while (*p == ' ')
-            p++;
+/* Should we tell curl to use a particular interface (or IP or hostname)? */
+char *want_interface = NULL;
 
-        {   /* Remove trailing whitespace */
-            char *q = p;
-            while (*q != '\r' && *q != '\n' && *q != ' ' && *q)
-                q++;
-            *q = 0;
-        }
-        if (!*p)
-            return NULL;
+/* Should we tell curl to use a particular SSL public / private cert? */
+char *sslcert = NULL;
+char *sslkey = NULL;
 
-        /* Return URL after making absolute */
-        return make_url_absolute(cur_url, p);
-    }
-    return NULL;                // TODO
-}
+/* Should we tell curl to ignore SSL peer verification? */
+int be_insecure = 0;
 
-/* Settings for HTTP connections - proxy host and port, auth details */
-static char *proxy;
-static char *pport;
-static char **auth_details; /* This is a realloced array with 3*num_auth_details entries */
-static int num_auth_details; /* The groups of 3 strings are host, user, pass */
+/* Should we tell curl to be verbose? */
+int be_verbose = 0;
 
-/* Remember referrer */
-char *referer;
+/* Should we tell curl to set a timeout? */
+long use_timeout = 0;
 
-/* set_proxy_from_string(str)
- * Sets the proxy settings for HTTP connections to use; these can be either as
- * a host[:port] or as http://host[:port].
- * Returns non-zero if the settings were obtained successfully. */
-int set_proxy_from_string(const char *s) {
-    if (!memcmp(s, http_scheme, strlen(http_scheme))) {
-        /* http:// style proxy string */
-        proxy = malloc(256);
-        if (!proxy)
-            return 0;
-        if (!get_http_host_port(s, proxy, 256, &pport))
-            return 0;
-        if (!pport) {
-            pport = strdup("webcache");
-        }
-        return 1;
-    }
-    else {
-        /* host:port style proxy string; have to parse this ourselves */
-        char *p;
-        proxy = strdup(s);
-        p = strchr(proxy, ':');
-        if (!p) {
-            pport = strdup("webcache");
-            return 1;
-        }
-        *p++ = 0;
-        pport = strdup(p);
-        return 1;
-    }
-}
+/* Declare up here so we can use it in make_curl_handle */
+int range_fetch_sockoptcallback( void *clientp, curl_socket_t curlfd, curlsocktype purpose );
 
 /* add_auth(host, user, pass)
  * Specify user & password combination to use connecting to the given host.
@@ -200,332 +88,242 @@ void add_auth(char *host, char *user, char *pass) {
     num_auth_details++;
 }
 
-/* str = get_auth_hdr(host)
- * For the given host, returns the extra HTTP header(s) that should be included
- * to provide authentication information. Returned as a malloced string.
- */
-const char auth_header_tmpl[] = { "Authorization: Basic %s\r\n" };
-
-static char *get_auth_hdr(const char *hn) {
-    /* Find any relevant entry in the auth table */
-    int i;
-    for (i = 0; i < num_auth_details * 3; i += 3) {
-        if (!strcasecmp(auth_details[i], hn)) {
-            char *b;
-            char *header;
-
-            /* We have found an entry in the auth details table for this
-             * hostname; get the user & pass to use */
-            char *u = auth_details[i + 1];
-            char *p = auth_details[i + 2];
-
-            /* Store unencoded user:pass */
-            size_t l = strlen(u) + strlen(p) + 2;
-            char *w = malloc(l);
-            snprintf(w, l, "%s:%s", u, p);
-
-            /* Now base64-encode that, and compose the header */
-            b = base64(w);
-            l = strlen(b) + strlen(auth_header_tmpl) + 1;
-            header = malloc(l);
-            snprintf(header, l, auth_header_tmpl, b);
-
-            /* And clean up */
-            free(w);
-            free(b);
-            return header;
-        }
+/* Get a curl easy handle based on our global options. Returns NULL on failure */
+CURL *make_curl_handle() {
+    CURL *curl;
+    CURLcode res;
+
+    curl = curl_easy_init();
+    if( !curl ) {
+        fprintf(stderr, "curl init failed miserably\n");
+        return NULL;
     }
-    return NULL;
-}
 
-/* http_date_string(time, buf, buflen)
- * Stores a valid ASCII representation of the supplied datetime in the supplied
- * buffer (length given as buflen). Returns non-NULL if successful.
- */
-static char *http_date_string(time_t t, char *const buf, const int blen) {
-    struct tm d;
+    /* Set options. Only check error codes if we care if they fail. */
 
-    if (gmtime_r(&t, &d) != NULL) {
-        if (strftime(buf, blen, "%a, %d %h %Y %T GMT", &d) > 0) {
-            return buf;
-        }
+    /* zsync only works with http(s), even though curl can do other things */
+    res = curl_easy_setopt( curl, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS );
+    if( res != CURLE_OK ) {
+        fprintf(stderr, "CURLOPT_PROTOCOLS: %s\n", curl_easy_strerror(res));
+        curl_easy_cleanup(curl);
+        return NULL;
     }
-    return NULL;
-}
 
-FILE *http_get(const char *orig_url, char **track_referer, const char *tfname) {
-    int allow_redirects = 5;
-    char *url;
-    FILE *f = NULL;
-    FILE *g = NULL;
-    char *fname = NULL;
-    char ifrange[200] = { "" };
-    char *authhdr = NULL;
-    int code;
-
-    /* If we have a (possibly older or incomplete) copy of this file already,
-     * add a suitable headers to only retrieve new/additional content */
-    if (tfname) {
-        struct stat st;
-
-        /* Construct the name of the incomplete transfer file that would have
-         * been used by a previous transfer */
-        fname = malloc(strlen(tfname) + 6);
-        strcpy(fname, tfname);
-        strcat(fname, ".part");
-
-        /* If we have an incomplete previous transfer, then our complete copy
-         * must be older but the incomplete copy may be current still and we
-         * could continue from that. */
-        if (stat(fname, &st) == 0) {
-            char buf[50];
-            if (http_date_string(st.st_mtime, buf, sizeof(buf)) != NULL)
-                snprintf(ifrange, sizeof(ifrange),
-                         "If-Unmodified-Since: %s\r\nRange: bytes=" OFF_T_PF
-                         "-\r\n", buf, st.st_size);
-        }
-        else if (errno == ENOENT && stat(tfname, &st) == 0) {
-            /* Else, if we have a complete possibly-old version, so only transfer
-             * if the remote has newer. */
-            char buf[50];
-            if (http_date_string(st.st_mtime, buf, sizeof(buf)) != NULL)
-                snprintf(ifrange, sizeof(ifrange), "If-Modified-Since: %s\r\n",
-                         buf);
-        }
+    /* We'd like to follow redirects */
+    curl_easy_setopt( curl, CURLOPT_FOLLOWLOCATION, 1 );
+
+    /* Set a User-Agent string */
+    curl_easy_setopt( curl, CURLOPT_USERAGENT, "zsync/" VERSION );
+
+    /* Turn on SO_KEEPALIVE */
+    curl_easy_setopt( curl, CURLOPT_SOCKOPTFUNCTION, range_fetch_sockoptcallback );
+
+    /* Command line options */
+
+    if(be_verbose) {
+        /* -v */
+        curl_easy_setopt( curl, CURLOPT_VERBOSE, 1 );
     }
 
-    /* Take a malloced copy of the URL, so we treat it the same as strduped
-     * URLs for any redirects followed. */
-    url = strdup(orig_url);
-    if (!url) {
-        free(fname);
-        return NULL;
+    if(cacert) {
+        /* -C */
+        res = curl_easy_setopt( curl, CURLOPT_CAINFO, cacert );
+        if( res != CURLE_OK ) {
+            fprintf(stderr, "--cacert: %s\n", curl_easy_strerror(res));
+            curl_easy_cleanup(curl);
+            return NULL;
+        }
     }
 
-    /* Loop for redirect handling */
-    for (; allow_redirects-- && url && !f;) {
-        char hostn[256];
-        const char *connecthost;
-        char *connectport;
-        char *p;
-        char *port;
+    if(sslcert) {
+        /* -R */
+        res = curl_easy_setopt( curl, CURLOPT_SSLCERT, sslcert );
+        if( res != CURLE_OK ) {
+            fprintf(stderr, "-R: %s\n", curl_easy_strerror(res));
+            curl_easy_cleanup(curl);
+            return NULL;
+        }
+    }
 
-        /* Extract host and port to connect to */
-        if ((p = get_http_host_port(url, hostn, sizeof(hostn), &port)) == NULL)
-            break;
-        if (!proxy) {
-            connecthost = hostn;
-            connectport = strdup(port);
+    if(sslkey) {
+        /* -S */
+        res = curl_easy_setopt( curl, CURLOPT_SSLKEY, sslkey );
+        if( res != CURLE_OK ) {
+            fprintf(stderr, "-S: %s\n", curl_easy_strerror(res));
+            curl_easy_cleanup(curl);
+            return NULL;
         }
-        else {
-            connecthost = proxy;
-            connectport = strdup(pport);
+    }
+
+    if(want_interface) {
+        /* -I */
+        res = curl_easy_setopt( curl, CURLOPT_INTERFACE, want_interface );
+        if( res != CURLE_OK ) {
+            /* Warn and continue. Let's try anyway even if this setopt fails */
+            fprintf(stderr, "--interface: %s\n", curl_easy_strerror(res));
         }
+    }
 
-        {   /* Connect */
-            int sfd = connect_to(connecthost, connectport);
-            free(connectport);
-            if (sfd == -1)
-                break;
+    if(be_insecure) {
+        /* -K */
+        curl_easy_setopt( curl, CURLOPT_SSL_VERIFYPEER, 0 );
+        curl_easy_setopt( curl, CURLOPT_SSL_VERIFYHOST, 0 );
+    }
 
-            {   /* Compose request */
-                char buf[1024];
-                snprintf(buf, sizeof(buf),
-                         "GET %s HTTP/1.0\r\nHost: %s%s%s\r\nUser-Agent: zsync/%s\r\n%s%s\r\n",
-                         proxy ? url : p, hostn, !strcmp(port,
-                                                         "http") ? "" : ":",
-                         !strcmp(port, "http") ? "" : port, VERSION,
-                         ifrange[0] ? ifrange : "", authhdr ? authhdr : "");
-
-                /* Send request to remote */
-                if (send(sfd, buf, strlen(buf), 0) == -1) {
-                    perror("sendmsg");
-                    close(sfd);
-                    break;
-                }
-            }
+    if(use_timeout) {
+        /* -T */
+        curl_easy_setopt( curl, CURLOPT_TIMEOUT, use_timeout );
+    }
 
-            /* Wrap the socket in a stream for convenient line reading of the
-             * response. */
-            f = http_get_stream(sfd, &code);
-            if (!f)
-                break;
+    return curl;
+}
 
-            /* Redirect - go around again with new URL. */
-            if (code == 301 || code == 302 || code == 307) {
-                char *oldurl = url;
-                url = get_location_url(f, oldurl);
-                free(oldurl);
-                fclose(f);
-                f = NULL;
-            }
-            else if (code == 401) {   /* Authorization required */
-                authhdr = get_auth_hdr(hostn);
-                if (authhdr) { /* Go around again with auth header */
-                    fclose(f);
-                    f = NULL;
-                }
-                else { /* No auth details available for this host - error out */
-                    fclose(f);
-                    f = NULL;
-                    break;
-                }
-            }
-            else if (code == 412) {     // Precondition (i.e. if-unmodified-since) failed
-                ifrange[0] = 0;
-                fclose(f);
-                f = NULL;       // and go round again without the conditional Range:
-            }
-            else if (code == 200) {     // Downloading whole file
-                /* Write new file (plus allow reading once we finish) */
-                g = fname ? fopen(fname, "w+") : tmpfile();
-            }
-            else if (code == 206 && fname) {    // Had partial content and server confirms not modified
-                /* Append to existing on-disk content (plus allow reading once we finish) */
-                g = fopen(fname, "a+");
-            }
-            else if (code == 304) {     // Unchanged (if-modified-since was false)
-                /* No fetching, just reuse on-disk file */
-                g = fopen(tfname, "r");
-            }
-            else {                      /* Don't know - error */
-                fclose(f);
-                f = NULL;
-                break;
-            }
-        }
-    }
+/* Parse a Content-Range header's value, like "bytes 0-5/6"
+ * Returns 0 on success, and puts parsed values into *from and *to
+ * Returns nonzero on failure
+ */
+int parse_content_range( char *buf, size_t len, off_t *from, off_t *to ) {
+    char* bufcpy;
+    int ret;
 
-    /* Store the referrer - we'll supply this when retrieving any content
-     * referrer to by this file retrieved. */
-    if (track_referer)
-        *track_referer = url;
-    else
-        free(url);
+    /* Copy so we can nul-terminate and use sscanf... there's probably a better way */
+    bufcpy = malloc(len+1);
+    memcpy(bufcpy,buf,len);
+    bufcpy[len] = 0;
 
-    /* If we got a 304 Not Modified, return the existing content as-is */
-    if (code == 304) {
-        fclose(f);
-        free(fname);
-        return g;
+    ret = sscanf(bufcpy, "bytes " OFF_T_PF "-" OFF_T_PF "/", from, to);
+    free(bufcpy);
+
+    if( ret == 2 ) {
+        return 0;
+    } else {
+        return -1;
     }
+}
 
-    /* Return errors from the above loop */
+/* Download content from orig_url into the file tfname (or tmpfile, if tfname
+ * is NULL), and return corresponding FILE*, or NULL on failure. Optionally
+ * store last used URL, after redirects, into track_referer.
+ *
+ * XXX: When tfname is set, non-curl version downloaded into a ".part" file and
+ *      then rename(1)ed
+ * XXX: When tfname is set, non-curl version used If-Modified-Since, 
+ *      If-Unmodified-Since, and Range to resume transfers on the .part file
+ * XXX: Non-curl version had a progress meter
+ */
+FILE *http_get(const char *orig_url, char **track_referer, const char *tfname) {
+    FILE *f;
+    CURL *curl;
+    CURLcode res;
+    long response_code;
+    char *effective_url;
+
+    /* We're either downloading to a file on disk (-k option) or a tmpfile */
+    f = tfname ? fopen(tfname, "w+") : tmpfile();
     if (!f) {
-        fprintf(stderr, "failed on url %s\n", url ? url : "(missing redirect)");
+        perror(tfname);
         return NULL;
     }
 
-    /* If our open of the output file failed, flag that error */
-    if (!g) {
+    curl = make_curl_handle();
+    if (!curl) {
+        /* make_curl_handle already printed an error message */
         fclose(f);
-        perror("fopen");
         return NULL;
     }
 
-    {   /* Read data returned by the request above, writing to the output file */
-        size_t len = 0;
-        {   /* Skip headers. TODO support content-encodings, Content-Location etc */
-            char buf[512];
-            do {
-                if (fgets(buf, sizeof(buf), f) == NULL) {
-                    perror("read");
-                    exit(1);
-                }
-
-                sscanf(buf, "Content-Length: " SIZE_T_PF, &len);
+    curl_easy_setopt( curl, CURLOPT_URL, orig_url );
+    curl_easy_setopt( curl, CURLOPT_WRITEDATA, f );
 
-            } while (buf[0] != '\r' && !feof(f));
-        }
-
-        {   /* Now the actual content. Show progress as we go. */
-            size_t got = 0;
-            struct progress p = { 0, 0, 0, 0 };
-            size_t r;
-            if (!no_progress)
-                do_progress(&p, 0, got);
-
-            while (!feof(f)) {
-                /* Read from the network */
-                char buf[1024];
-                r = fread(buf, 1, sizeof(buf), f);
-                if (r == 0 && ferror(f)) {
-                    perror("read");
-                    break;
-                }
+    /* Try URL fetch */
+    res = curl_easy_perform( curl );
+    if (res) {
+        fprintf(stderr, "Curl: %s\n", curl_easy_strerror(res));
+        fclose(f);
+        curl_easy_cleanup(curl);
+        return NULL;
+    }
 
-                /* And write anything received to the temp file */
-                if (r > 0) {
-                    if (r > fwrite(buf, 1, r, g)) {
-                        fprintf(stderr, "short write on %s\n", fname);
-                        break;
-                    }
+    /* Confirm we got a 200 OK */
+    res = curl_easy_getinfo( curl, CURLINFO_RESPONSE_CODE, &response_code );
+    if (res != CURLE_OK) {
+        fprintf(stderr, "Could not get HTTP response code!\n");
+        fclose(f);
+        curl_easy_cleanup(curl);
+        return NULL;
+    }
 
-                    /* And maintain progress indication */
-                    got += r;
-                    if (!no_progress)
-                        do_progress(&p, len ? (100.0 * got / len) : 0, got);
-                }
-            }
-            if (!no_progress)
-                end_progress(&p, feof(f) ? 2 : 0);
-        }
+    if (response_code != 200) {
+        fprintf(stderr, "Got HTTP %ld (expected 200)\n", response_code);
         fclose(f);
+        curl_easy_cleanup(curl);
+        return NULL;
     }
 
-    /* The caller wants the content we just downloaded; return the handle to
-     * the start of the file that we have just written. */
-    rewind(g);
+    /* Return effective URL if asked for it */
+    if (track_referer) {
+        res = curl_easy_getinfo( curl, CURLINFO_EFFECTIVE_URL, &effective_url );
+        if(res != CURLE_OK) {
+            fprintf(stderr, "Could not get last effective URL: %s\n", curl_easy_strerror(res));
+            fclose(f);
+            curl_easy_cleanup(curl);
+            return NULL;
+        }
 
-    /* If we are keeping the download too, move it to the desired name. */
-    if (fname) {
-        rename(fname, tfname);
-        free(fname);
+        *track_referer = strdup(effective_url);
     }
 
-    return g;
+    /* Done with the curl handle */
+    curl_easy_cleanup( curl );
+
+    /* The caller expects f to be at the beginning */
+    rewind(f);
+    return f;
 }
 
 /****************************************************************************
  *
- * HTTP Range: / 206 response interface 
- * 
- * The state engine here is:
- * If sd == -1, not connected;
- * else, if block_left is 0
- *     if boundary is unset, we're reading HTTP headers
- *     if boundary is set, we're reading a MIME boundary
- * else we're reading a block of actual data; block_left bytes still to read.
+ * HTTP Range: / 206 response interface
+ *
+ * Procedure:
+ *
+ * 1) range_fetch_perform resets all the "State for HTTP response parser"
+ *
+ * 2) range_fetch_read_http_headers sets:
+ *    - http_code, and
+ *    - if multipart: boundary
+ *    - if single range: block_left, offset
+ *
+ * 3) range_fetch_read_http_content can be in these states:
+ *    - block_left set: reading data block
+ *    - block_left unset, boundary set: reading MIME multipart delimiter,
+ *      on line number "multipart" of the delimiter
+ *    - block_left unset, boundary unset: inconsistent state. probable bad
+ *      response from server.
  */
 
 struct range_fetch {
-    /* URL to retrieve from, host:port, auth header */
-    char *url;
-    char hosth[256];
-    char *authh;
-
-    /* Host and port to connect to (could be the same as the URL, or proxy) */
-    char *chost;
-    char *cport;
-
-    int sd;         /* Currently open socket to the server, or -1 */
-    char *boundary; /* If we're in the middle of reading a mime/multipart
-                     * response, this is the boundary string. */
-
-    /* State for block currently being read */
+    CURL *curl;     /* Currently open curl handle to the server, or NULL */
+    char *url;      /* URL we're telling curl to use.
+                       Must be kept around after passing it to curl_easy_setopt */
+
+    /* zsync_receiver struct that will receive data we get from the remote */
+    struct zsync_receiver *zr;
+
+    /* State for HTTP response parser */
+    int http_code;      /* Most recent HTTP status code seen. Reset to 0 for every curl request. */
+    char *boundary;     /* If we're expecting a mime/multipart response, this is the boundary string. */
+    int multipart;      /* If we're reading a MIME multipart delimiter, the line number we're on
+                           1  = "--boundary" line
+                           2+ = Headers */
     size_t block_left;  /* non-zero if we're in the middle of reading a block */
     off_t offset;       /* and this is the offset of the start of the block we are reading */
-
-    /* Buffering of data from the remote server */
-    char buf[4096];
-    int buf_start, buf_end; /* Bytes buf_start .. buf_end-1 in buf[] are valid */
+    char buf[2048];     /* Buffering of MIME multipart delimiter lines from the remote server */
+    int buf_end;        /* Bytes 0 .. buf_end-1 in buf[] are valid */
 
     /* Keep count of total bytes retrieved */
     off_t bytes_down;
 
-    int server_close; /* 0: can send more, 1: cannot send more (but one set of headers still to read), 2: cannot send more and all existing headers read */
-
     /* Byte ranges to fetch */
     off_t *ranges_todo; /* Contains 2*nranges ranges, consisting of start and stop offset */
     int nranges;
@@ -535,162 +333,370 @@ struct range_fetch {
 
 /* range_fetch methods */
 
-/* range_fetch_set_url(rf, url)
- * Set up a range_fetch to fetch from a given URL. Private method. 
- * C is a nightmare for memory allocation here. At least the errors should be
- * caught, but minor memory leaks may occur on some error paths. */
-static int range_fetch_set_url(struct range_fetch* rf, const char* orig_url) {
-    /* Get the host, port and path from the URL. */
-    char hostn[sizeof(rf->hosth)];
-    char* cport;
-    char* p = get_http_host_port(orig_url, hostn, sizeof(hostn), &cport);
-    if (!p) {
-        return 0;
+/* Sets up the range_fetch struct to expect bytes from-to (fairly) immediately. Normally
+   called when the remote sends us a Content-Range header, either on a full HTTP response
+   or on a MIME multipart section.
+
+   Returns 0 on success, nonzero on failure. Can fail if we were not expecting to
+   be served this particular range. */
+int range_fetch_expect( struct range_fetch *rf, off_t from, off_t to ) {
+
+    /* If we're done, this is an error. */
+    if( rf->rangesdone >= rf->nranges ) {
+        fprintf( stderr, "Not expecting to see further range blocks!\n" );
+        return -1;
     }
 
-    free(rf->url);
-    if (rf->authh) free(rf->authh);
-
-    /* Get host:port for Host: header */
-    if (strcmp(cport, "http") != 0)
-        snprintf(rf->hosth, sizeof(rf->hosth), "%s:%s", hostn, cport);
-    else
-        snprintf(rf->hosth, sizeof(rf->hosth), "%s", hostn);
-
-    if (proxy) {
-        /* URL must be absolute; don't need cport anymore, just need full URL
-         * to give to proxy. */
-        free(cport);
-        rf->url = strdup(orig_url);
+    /* If this isn't the next range in the sequence, this is an error. */
+    if( rf->ranges_todo[2*rf->rangesdone] != from || rf->ranges_todo[2*rf->rangesdone+1] != to ) {
+        fprintf( stderr,
+                 "Expected Content-Range " OFF_T_PF "-" OFF_T_PF " but got " OFF_T_PF "-" OFF_T_PF " from server!\n",
+                 rf->ranges_todo[2*rf->rangesdone], rf->ranges_todo[2*rf->rangesdone+1], from, to );
+        return -1;
+    }
+
+    /* If we aren't done reading the previous range, this is an error. */
+    if( rf->block_left != 0 ) {
+        fprintf( stderr, "Range was truncated!\n" );
+        return -1;
+    }
+
+    /* Looks good. Set up block_left and offset. */
+    rf->block_left = to + 1 - from;
+    rf->offset = from;
+
+    return 0;
+}
+
+/* Curl SOCKOPTFUNCTION. Sets SO_KEEPALIVE on the socket. */
+int range_fetch_sockoptcallback( void *clientp, curl_socket_t curlfd, curlsocktype purpose ) {
+
+    /* CURLSOCKTYPE_IPCXN is the primary connection */
+    if( purpose == CURLSOCKTYPE_IPCXN ) {
+        int optval = 1;
+        if( setsockopt(curlfd, SOL_SOCKET, SO_KEEPALIVE, (void *)&optval, sizeof(optval) ) ) {
+            /* setsockopt failed. continue anyway. */
+            perror("setsockopt");
+        }
     }
-    else {
-        free(rf->cport);
-        free(rf->chost);
-        // Set url to relative part and chost, cport to the target
-        if ((rf->chost = strdup(hostn)) == NULL) {
-            free(cport);
+
+    /* Returns 0 on success */
+    return 0;
+}
+
+/* Curl HEADERFUNCTION. Gets headers one-by-one (including the HTTP status line) plus a range_fetch struct. */
+size_t range_fetch_read_http_headers( void *ptr, size_t size, size_t nmemb, void *userdata ) {
+    struct range_fetch *rf = (struct range_fetch *)userdata;
+    char *buf = (char *)ptr;
+    size_t len = size * nmemb;
+    char *end = buf + len;
+
+    /* Keep bytes_down up-to-date */
+    rf->bytes_down += len;
+
+    /* Look for HTTP status line */
+    if( len >= strlen("HTTP/1.1 XXX") && memcmp(buf, "HTTP/1.1 ", strlen("HTTP/1.1 ")) == 0 ) {
+
+        /* If previous HTTP code was 2xx, something bad is happening. We should only get
+         * one 2xx (previous codes in this request chain would have been redirects, if anything) */
+        if( rf->http_code >= 200 && rf->http_code < 300 ) {
+            fprintf(stderr, "Not expecting to see further HTTP responses after a 2xx (last code was %d)!\n", rf->http_code);
             return 0;
         }
-        rf->cport = cport;
-        rf->url = strdup(p);
+
+        /* Remember most recent HTTP code */
+        rf->http_code = (int)(buf[9]-'0')*100 + (int)(buf[10]-'0')*10 + (int)(buf[11]-'0');
     }
 
-    /* Get any auth header that we should use */
-    rf->authh = get_auth_hdr(hostn);
+    /* HTTP 200 + Content-Length -> Entire file */
+    else if( rf->http_code == 200 && len > strlen("content-length: x") && strncasecmp(buf, "content-length: ", strlen("content-length: ")) == 0) {
+        off_t to = (off_t)strtoll(buf + strlen("content-length: "), (void*)(buf + len), 10) - 1;
 
-    return !!rf->url;
-}
+        /* Found to, and from = 0 */
+        if( range_fetch_expect( rf, 0, to ) != 0 ) {
+            /* Error. range_fetch_expect has already printed a message, so just leave */
+            return 0;
+        }
+    }
 
-/* get_more_data - this is the method which owns all reads from the remote.
- * Nothing else reads from the remote. This buffers data, so that the
- * higher-level methods below can easily read whole lines from the remote. 
- * The higher-level methods call this function when they need more data: 
- * it refills the buffer with data from the network. Returns the bytes read. */
-static int get_more_data(struct range_fetch *rf) {
-    /* First, garbage collect - move the 'live' data in the buffer to the start
-     * of the buffer. */
-    if (rf->buf_start) {
-        memmove(rf->buf, &(rf->buf[rf->buf_start]),
-                rf->buf_end - rf->buf_start);
-        rf->buf_end -= rf->buf_start;
-        rf->buf_start = 0;
+    /* HTTP 206 + Content-Range -> Single range */
+    else if( rf->http_code == 206 && len > strlen("content-range: bytes ") && strncasecmp(buf, "content-range: bytes ", strlen("content-range: bytes ")) == 0 ) {
+        /* Okay, we're getting a non-MIME block from the remote. */
+        off_t from, to;
+
+        if( parse_content_range(buf + strlen("content-range: "), len - strlen("content-range: "), &from, &to) != 0 ) {
+            /* This Content-Range header is bogus */
+            fprintf(stderr, "Server sent us a bogus Content-Range!\n" );
+            return 0;
+        }
+
+        /* Found from, to */
+        if( range_fetch_expect( rf, from, to ) != 0 ) {
+            /* Error. range_fetch_expect has already printed a message, so just leave */
+            return 0;
+        }
     }
 
-    {   /* Read as much as the OS wants to give us, up to a limit of filling
-         * the rest of the buffer; ignore EINTR. */
-        int n;
-        do {
-            n = read(rf->sd, &(rf->buf[rf->buf_end]),
-                     sizeof(rf->buf) - rf->buf_end);
-        } while (n == -1 && errno == EINTR);
-        if (n < 0) {
-            perror("read");
+    /* HTTP 206 + Content-Type multipart/byteranges -> Multiple ranges */
+    else if( rf->http_code == 206 && len > strlen("content-type: multipart/byteranges") && strncasecmp(buf, "content-type: multipart/byteranges", strlen("content-type: multipart/byteranges")) == 0 ) {
+        char *p;
+
+        /* Goal is the multipart boundary string */
+
+        /* We don't expect it to be set already... */
+        if( rf->boundary ) {
+            fprintf(stderr, "Not expecting to see more than one multipart/byteranges response!\n");
+            return 0;
         }
-        else {
 
-            /* Add new bytes to buffer, and update total bytes count */
-            rf->buf_end += n;
-            rf->bytes_down += n;
+        /* Place pointer after "multipart/byteranges" */
+        p = buf + strlen("content-type: multipart/byteranges");
+
+        /* Look for the boundary= string */
+        while( p + strlen("boundary=") <= end ) {
+            if( memcmp(p, "boundary=", strlen("boundary=")) == 0 )
+                break;
+            p++;
+        }
+
+        if( p + strlen("boundary=") < end ) {
+            char *boundary;
+            int quoted = 0;
+
+            /* Found the boundary= string */
+            p += strlen("boundary=");
+
+            /* Allocate a buffer that might be a little big */
+            rf->boundary = boundary = malloc(end-p+1);
+            if(!boundary) {
+                perror("malloc");
+                return 0;
+            }
+
+            /* Possibly skip a quote mark */
+            if( *p == '"' ) {
+                quoted = 1;
+                p++;
+            }
+
+            /* Copy until the of the boundary */
+            while( p < end ) {
+                if( *p == 0 )
+                    break;
+
+                if( quoted && *p == '"' )
+                    break;
+
+                if( !quoted && ( *p == '\r' || *p == ' ' || *p == '\n' ) )
+                    break;
+
+                *boundary = *p;
+                boundary++;
+                p++;
+            }
+
+            /* nul-terminate the boundary */
+            *boundary = 0;
         }
-        return n;
     }
+
+    return len;
 }
 
-/* rfgets - get next line from the remote (terminated by LF or end-of-file)
- * (using the buffer, fetching more data if there's no full line in the buffer
- * yet) */
-static char *rfgets(char *buf, size_t len, struct range_fetch *rf) {
-    char *p;
-    while (1) {
-        /* Look for a line end in the in buffer */
-        p = memchr(rf->buf + rf->buf_start, '\n', rf->buf_end - rf->buf_start);
-
-        /* If we don't have the end of the line yet, fetch more data into the
-         * buffer (and go around again) */
-        if (!p) {
-            int n = get_more_data(rf);
-            if (n <= 0) {
-                /* EOF - just return all that we have left */
-                p = &(rf->buf[rf->buf_end]);
+/* Curl WRITEFUNCTION. Gets response data in batches, plus a range_fetch struct. */
+size_t range_fetch_read_http_content( void *ptr, size_t size, size_t nmemb, void *userdata ) {
+    struct range_fetch *rf = (struct range_fetch *)userdata;
+    char *buf = (char *)ptr;
+    size_t len = size * nmemb;
+
+    /* Make sure we're reading content from a 200 (ok) or 206 (partial content) */
+    if( rf->http_code != 200 && rf->http_code != 206 ) {
+        fprintf( stderr, "Expected HTTP 200 or 206 (partial content) but got code %d!\n", rf->http_code );
+        return 0;
+    }
+
+    /* Keep bytes_down up-to-date */
+    rf->bytes_down += len;
+
+    /* Loop until nothing left to read in this chunk */
+    while( len ) {
+
+        if( rf->block_left > 0 && rf->multipart == 0 ) {
+            /* In the middle of reading a block */
+
+            /* Read the min of block_left and len */
+            size_t block_todo = rf->block_left > len ? len : rf->block_left;
+
+            if( zsync_receive_data( rf->zr, buf, rf->offset, block_todo ) != 0 )
+                return 0;
+
+            rf->offset += block_todo;
+            rf->block_left -= block_todo;
+
+            if( rf->block_left == 0 ) {
+                /* One more range done */
+                rf->rangesdone ++;
             }
+
+            /* Move buf/len up past what we just read */
+            buf += block_todo;
+            len -= block_todo;
         }
-        else    /* We have a \n; set p to point just past it */
-            p++;
 
-        if (p) {
-            register char *bufstart = &(rf->buf[rf->buf_start]);
+        if( len ) {
+            /* More to read, not part of a block. We should be inside a multipart delimiter */
+
+            if( rf->multipart == -1 ) {
+                /* In the middle of the MIME epilogue. Ignore */
+                break;
+            }
+
+            if( !rf->boundary ) {
+                /* We weren't expecting a multipart delimiter. Abort. */
+                fprintf( stderr, "Not expecting more content from the server!\n" );
+                return 0;
+            }
+
+            /* Copy one line at a time into rf->buf (until CRLF) or until we run out of
+             * stuff to copy. The purpose of buffering is that curl might split a line. */
+            while( len ) {
+                /* Make sure we have enough space in rf->buf for this char and possibly a nul */
+                if( rf->buf_end >= (int)sizeof(rf->buf) - 2 ) {
+                    fprintf( stderr, "Overflow buffering multipart response!\n" );
+                    return 0;
+                }
+
+                /* Copy one more character */
+                rf->buf[rf->buf_end++] = *buf;
 
-            /* Work out how much data to return - the line, or at most 'len' bytes */
-            len--;              /* leave space for trailing \0 */
-            if (len > (size_t) (p - bufstart))
-                len = p - bufstart;
+                buf++;
+                len--;
 
-            /* Copy from input buffer to return buffer, nul terminate, and advance
-             * current position in the input buffer */
-            memcpy(buf, bufstart, len);
-            buf[len] = 0;
-            rf->buf_start += len;
-            return buf;
+                /* Detect possible end-of-line (CRLF) */
+                if( rf->buf_end >= 2 && rf->buf[rf->buf_end-2] == '\r' && rf->buf[rf->buf_end-1] == '\n' ) {
+                    /* nul-terminate rf->buf before the CRLF */
+                    rf->buf[rf->buf_end-2] = '\0';
+                    rf->buf_end -= 2;
+
+                    if( rf->multipart == 0 ) {
+                        /* Expecting empty line to toss. Just confirm it. */
+                        if( rf->buf_end > 0 ) {
+                            fprintf(stderr, "Missing CRLF before multipart boundary! [%s]\n", rf->buf);
+                            return 0;
+                        }
+
+                        rf->multipart ++;
+                    }
+                    else if( rf->multipart == 1 ) {
+                        /* Expecting --boundary */
+                        size_t boundarysz = strlen(rf->boundary);
+
+                        if(
+                            (size_t)rf->buf_end < 2 + boundarysz         /* too short */
+                            || rf->buf[0] != '-' || rf->buf[1] != '-'    /* no -- */
+                            || memcmp(rf->buf+2,rf->boundary,boundarysz) /* no boundary string */
+                        ) {
+                            fprintf(stderr, "Missing multipart boundary string! [%s]\n", rf->buf);
+                            return 0;
+                        }
+
+                        /* Two more dashes means that the multipart message is over */
+                        if( (size_t)rf->buf_end >= 4 + boundarysz && rf->buf[2+boundarysz] == '-' && rf->buf[3+boundarysz] == '-' ) {
+                            rf->multipart = -1;
+
+                            /* Clear rf->boundary so we don't try to read another multipart delimiter */
+                            free(rf->boundary);
+                            rf->boundary = NULL;
+                        }
+                        else {
+                            rf->multipart ++;
+                        }
+                    }
+                    else if( rf->multipart > 1 ) {
+                        /* Looking for content-range OR empty line */
+                        if( rf->buf_end > strlen("content-range: bytes ") && strncasecmp(rf->buf, "content-range: bytes ", strlen("content-range: bytes ")) == 0 ) {
+                            /* This is the content-range line */
+                            off_t from, to;
+
+                            if( parse_content_range( rf->buf + strlen("content-range: "), rf->buf_end - strlen("content-range: "), &from, &to) != 0 ) {
+                                /* This Content-Range header is bogus */
+                                fprintf(stderr, "Server sent us a bogus Content-Range!\n" );
+                                return 0;
+                            }
+
+                            /* Found from, to */
+                            if( range_fetch_expect( rf, from, to ) != 0 ) {
+                                /* Error. range_fetch_expect has already printed a message, so just leave */
+                                return 0;
+                            }
+
+                            rf->multipart ++;
+                        }
+                        else if( rf->buf_end == 0 ) {
+                            /* End of multipart delimiter */
+                            rf->multipart = 0;
+                        }
+                        else {
+                            /* Uninteresting header line */
+                            rf->multipart ++;
+                        }
+                    }
+
+                    /* Reset rf->buf */
+                    rf->buf_end = 0;
+
+                    /* Break out of the multipart delimiter loop. We'll come back to it if we need to. */
+                    break;
+                }
+            }
         }
     }
+
+    return size * nmemb;
 }
 
 /* range_fetch_start(origin_url)
  * Returns a new range fetch object, for the given URL.
  */
-struct range_fetch *range_fetch_start(const char *orig_url) {
-    struct range_fetch *rf = malloc(sizeof(struct range_fetch));
+struct range_fetch *range_fetch_start(const char *orig_url, struct zsync_receiver *zr) {
+    struct range_fetch *rf;
+
+    if (!zr || !orig_url) {
+        return NULL;
+    }
+
+    rf = malloc(sizeof(struct range_fetch));
     if (!rf)
         return NULL;
 
-    /* If going through a proxy, we can immediately set up the host and port to
-     * connect to */
-    if (proxy) {
-        rf->cport = strdup(pport);
-        rf->chost = strdup(proxy);
-    }
-    else {
-        rf->cport = NULL;
-        rf->chost = NULL;
-    }
-    /* Blank initialisation for other fields before set_url call */
-    rf->url = NULL;
-    rf->authh = NULL;
+    /* Copy pointer to zsync_receiver */
+    rf->zr = zr;
 
-    if (!range_fetch_set_url(rf, orig_url)) {
-        free(rf->cport);
-        free(rf->chost);
+    /* Init curl handle */
+    rf->curl = make_curl_handle();
+    if (!rf->curl) {
+        /* make_curl_handle already printed an error message */
         free(rf);
         return NULL;
     }
 
+    /* Copy url into a new string */
+    rf->url = strdup(orig_url);
+
+    curl_easy_setopt( rf->curl, CURLOPT_URL, rf->url );
+    curl_easy_setopt( rf->curl, CURLOPT_HEADERFUNCTION, range_fetch_read_http_headers );
+    curl_easy_setopt( rf->curl, CURLOPT_HEADERDATA, (void*)rf );
+    curl_easy_setopt( rf->curl, CURLOPT_WRITEFUNCTION, range_fetch_read_http_content );
+    curl_easy_setopt( rf->curl, CURLOPT_WRITEDATA, (void*)rf );
+
     /* Initialise other state fields */
     rf->block_left = 0;
     rf->bytes_down = 0;
     rf->boundary = NULL;
-    rf->sd = -1;                        /* Socket not open */
+    rf->multipart = 0;
+    rf->buf_end = 0;    /* Buffer initially empty */
     rf->ranges_todo = NULL;             /* And no ranges given yet */
-    rf->nranges = rf->rangesdone = 0;
+    rf->nranges = rf->rangessent = rf->rangesdone = 0;
 
     return rf;
 }
@@ -722,56 +728,69 @@ void range_fetch_addranges(struct range_fetch *rf, off_t * ranges, int nranges)
     rf->nranges += nranges;
 }
 
-/* range_fetch_connect
- * Connect this rf to its remote server */
-static void range_fetch_connect(struct range_fetch *rf) {
-    rf->sd = connect_to(rf->chost, rf->cport);
-    rf->server_close = 0;
-    rf->rangessent = rf->rangesdone;
-    rf->buf_start = rf->buf_end = 0;    /* Buffer initially empty */
+/* range_fetch_bytes_down
+ * Simple getter method, returns the total bytes retrieved */
+off_t range_fetch_bytes_down(const struct range_fetch * rf) {
+    return rf->bytes_down;
 }
 
-/* range_fetch_getmore
- * On a connected range fetch, send another request to the remote */
-static void range_fetch_getmore(struct range_fetch *rf) {
-    char request[2048];
-    int l;
+/* Destructor */
+void range_fetch_end(struct range_fetch *rf) {
+    curl_easy_cleanup( rf->curl );
+    free(rf->ranges_todo);
+    free(rf->boundary);
+    free(rf->url);
+    free(rf);
+}
+
+/* Return:
+ *  1 = Please call again, more work to do
+ *  0 = No more work to do
+ * -1 = error
+ */
+int range_fetch_perform(struct range_fetch *rf) {
+    CURLcode res;
     int max_range_per_request = 20;
+    char request[1024] = { 0 }; /* Range like "X-Y,N-M" */
 
-    /* Only if there's stuff queued to get */
-    if (rf->rangessent == rf->nranges)
-        return;
+    /* Reset per-request state in range_fetch */
+    rf->block_left = 0;
+    rf->offset = 0;
+    rf->http_code = 0;
+    rf->buf_end = 0;
+    rf->multipart = 0;
+    free(rf->boundary);
+    rf->boundary = NULL;
 
-    /* Build the base request, everything up to the Range: bytes= */
-    snprintf(request, sizeof(request),
-             "GET %s HTTP/1.1\r\n"
-             "User-Agent: zsync/" VERSION "\r\n"
-             "Host: %s"
-             "%s%s\r\n"
-             "%s"
-             "Range: bytes=",
-             rf->url, rf->hosth,
-             referer ? "\r\nReferer: " : "", referer ? referer : "",
-             rf->authh ? rf->authh : "");
+    /* Forget about any ranges requested last range_fetch_perform, but not received */
+    rf->rangessent = rf->rangesdone;
 
     /* The for loop here is just a sanity check, lastrange is the real loop control */
     for (; rf->rangessent < rf->nranges;) {
         int i = rf->rangessent;
         int lastrange = 0;
+        int chars;
+        int l;
 
-        /* Add at least one byterange to the request; but is this the last one? 
+        /* Add at least one byterange to the request; but is this the last one?
          * That's decided based on whether there are any more to add, whether
          * we've reached our self-imposed limit per request, and whether
          * there's buffer space to add more.
          */
-        l = strlen(request);
-        if (l > 1200 || !(--max_range_per_request) || i == rf->nranges - 1)
+        if (!(--max_range_per_request) || i == rf->nranges - 1)
             lastrange = 1;
 
         /* Append to the request */
-        snprintf(request + l, sizeof(request) - l, OFF_T_PF "-" OFF_T_PF "%s",
-                 rf->ranges_todo[2 * i], rf->ranges_todo[2 * i + 1],
-                 lastrange ? "" : ",");
+        l = strlen(request);
+        chars = snprintf(request + l, sizeof(request) - l, OFF_T_PF "-" OFF_T_PF "%s",
+                         rf->ranges_todo[2 * i], rf->ranges_todo[2 * i + 1],
+                         lastrange ? "" : ",");
+
+        if( chars >= (int)sizeof(request) - l ) {
+            /* Overflow. Extremely unlikely given max_range_per_request. */
+            fprintf(stderr, "Overflow setting up Range header!\n");
+            return -1;
+        }
 
         /* And record that we have sent this one */
         rf->rangessent++;
@@ -780,395 +799,84 @@ static void range_fetch_getmore(struct range_fetch *rf) {
         if (lastrange)
             break;
     }
-    l = strlen(request);
-
-    /* Possibly close the connection (and record the fact, so we definitely
-     * don't send more stuff) if this is the last */
-    snprintf(request + l, sizeof(request) - l, "\r\n%s\r\n",
-             rf->rangessent == rf->nranges ? (rf->server_close =
-                                              1, "Connection: close\r\n") : "");
-
-    {   /* Send the request */
-        size_t len = strlen(request);
-        char *p = request;
-        int r = 0;
-
-        while (len > 0
-               && ((r = send(rf->sd, p, len, 0)) != -1 || errno == EINTR)) {
-            if (r >= 0) {
-                p += r;
-                len -= r;
-            }
-        }
-        if (r == -1) {
-            perror("send");
-        }
-    }
-}
 
-/* buflwr(str) - in-place convert this string to lower case */
-static void buflwr(char *s) {
-    char c;
-    while ((c = *s) != 0) {
-        if (c >= 'A' && c <= 'Z')
-            *s = c - 'A' + 'a';
-        s++;
-    }
-}
-
-/* range_fetch_read_http_headers - read a set of HTTP headers, updating state
- * appropriately.
- * Returns: EOF returns 0, good returns 206 (reading a range block) or 30x
- *  (redirect), error returns <0 */
-int range_fetch_read_http_headers(struct range_fetch *rf) {
-    char buf[512];
-    int status;
-    int seen_location = 0;
-
-    {                           /* read status line */
-        char *p;
-
-        if (rfgets(buf, sizeof(buf), rf) == NULL)
-            return -1;
-        if (buf[0] == 0)
-            return 0;           /* EOF, caller decides if that's an error */
-        if (memcmp(buf, "HTTP/1", 6) != 0 || (p = strchr(buf, ' ')) == NULL) {
-            fprintf(stderr, "got non-HTTP response '%s'\n", buf);
-            return -1;
-        }
-        status = atoi(p + 1);
-        if (status != 206 && status != 301 && status != 302) {
-            if (status >= 300 && status < 400) {
-                fprintf(stderr,
-                        "\nzsync received a redirect/further action required status code: %d\nzsync specifically refuses to proceed when a server requests further action. This is because zsync makes a very large number of requests per file retrieved, and so if zsync has to perform additional actions per request, it further increases the load on the target server. The person/entity who created this zsync file should change it to point directly to a URL where the target file can be retrieved without additional actions/redirects needing to be followed.\nSee http://zsync.moria.orc.uk/server-issues\n",
-                        status);
-            }
-            else if (status == 200) {
-                fprintf(stderr,
-                        "\nzsync received a data response (code %d) but this is not a partial content response\nzsync can only work with servers that support returning partial content from files. The person/entity creating this .zsync has tried to use a server that is not returning partial content. zsync cannot be used with this server.\nSee http://zsync.moria.orc.uk/server-issues\n",
-                        status);
-            }
-            else {
-                /* generic error message otherwise */
-                fprintf(stderr, "bad status code %d\n", status);
-            }
-            return -1;
-        }
-        if (*(p - 1) == '0') {  /* HTTP/1.0 server? */
-            rf->server_close = 2;
-        }
+    if( rf->rangessent <= rf->rangesdone ) {
+        /* Nothing to do. Done! */
+        return 0;
     }
 
-    /* Read other headers */
-    while (1) {
-        char *p;
-
-        /* Get next line */
-        if (rfgets(buf, sizeof(buf), rf) == NULL)
-            return -1;
-
-        /* If it's the end of the headers */
-        if (buf[0] == '\r' || buf[0] == '\0') {
-            /* We are happy provided we got the block boundary, or an actual block is starting. */
-            if (((rf->boundary || rf->block_left)
-                 && !(rf->boundary && rf->block_left))
-                || (status >= 300 && status < 400 && seen_location))
-                return status;
-            break;
-        }
-
-        /* Parse header */
-        p = strstr(buf, ": ");
-        if (!p)
-            break;
-        *p = 0;
-        p += 2;
-        buflwr(buf);
-        {   /* Remove the trailing \r\n from the value */
-            int len = strcspn(p, "\r\n");
-            p[len] = 0;
-        }
-        /* buf is the header name (lower-cased), p the value */
-        /* Switch based on header */
-
-        /* If remote closes the connection on us, record that */
-        if (!strcmp(buf, "connection") && !strcmp(p, "close")) {
-            rf->server_close = 2;
-        }
-
-        if (status == 206 && !strcmp(buf, "content-range")) {
-            /* Okay, we're getting a non-MIME block from the remote. Get the
-             * range and set our state appropriately */
-            off_t from, to;
-            sscanf(p, "bytes " OFF_T_PF "-" OFF_T_PF "/", &from, &to);
-            if (from <= to) {
-                rf->block_left = to + 1 - from;
-                rf->offset = from;
-            }
-
-            /* Can only have got one range. */
-            rf->rangesdone++;
-            rf->rangessent = rf->rangesdone;
-        }
+    /* Need to ask curl to send these ranges */
+    curl_easy_setopt( rf->curl, CURLOPT_RANGE, NULL );
+    curl_easy_setopt( rf->curl, CURLOPT_RANGE, &request );
+    res = curl_easy_perform( rf->curl );
 
-        /* If we're about to get a MIME multipart block set */
-        if (status == 206 && !strcasecmp(buf, "content-type")
-            && !strncasecmp(p, "multipart/byteranges", 20)) {
+    /* Get rid of CURLOPT_RANGE, since the pointer will be invalid shortly. */
+    curl_easy_setopt( rf->curl, CURLOPT_RANGE, NULL );
 
-            /* Get the multipart boundary string */
-            char *q = strstr(p, "boundary=");
-            if (!q)
-                break;
-            q += 9;
-
-            /* Gah, we could really use a regexp here. Could be quoted... */
-            if (*q == '"') {
-                rf->boundary = strdup(q + 1);
-                q = strchr(rf->boundary, '"');
-                if (q)
-                    *q = 0;
-            }
-            else {  /* or unquoted */
-                rf->boundary = strdup(q);
-                q = rf->boundary + strlen(rf->boundary) - 1;
-
-                while (*q == '\r' || *q == ' ' || *q == '\n')
-                    *q-- = '\0';
-            }
+    /* If we got a curl error, we need to flag that to our caller */
+    if(res) {
+        if( res != CURLE_WRITE_ERROR ) {
+            /* CURLE_WRITE_ERROR means one of our callbacks wanted to abort
+               the transfer. It would have printed its own error message */
+            fprintf(stderr,
+                   "Could not fetch URL: %s\n",
+                   curl_easy_strerror(res));
         }
 
-        /* If remote is telling us to change URL */
-        if ((status == 302 || status == 301)
-            && !strcmp(buf, "location")) {
-            if (seen_location++) {
-                fprintf(stderr, "Error: multiple Location headers on redirect\n");
-                break;
-            }
-
-            /* Set new target URL 
-             * NOTE: we are violating the "the client SHOULD continue to use
-             * the Request-URI for future requests" of RFC2616 10.3.3 for 302s.
-             * It's not practical given the number of requests we are making to
-             * follow the RFC here, and at least we're only remembering it for
-             * the duration of this transfer. */
-            if (!no_progress)
-                fprintf(stderr, "followed redirect to %s\n", p);
-            range_fetch_set_url(rf, p);
-
-            /* Flag caller to reconnect; the new URL might be a new target. */
-            rf->server_close = 2;
-        }
-        /* No other headers that we care about. In particular:
-         *
-         * FIXME: non-conformant to HTTP/1.1 because we ignore
-         * Transfer-Encoding: chunked.
-         */
+        return -1;
     }
-    return -1;
-}
 
-/* get_range_block(self, &offset, buf[], buflen)
- *
- * This is where it all happens. This is a complex function to present a very
- * simple read(2)-like interface to the caller over the top of all the HTTP
- * going on.
- *
- * It returns blocks of actual data, retrieved from the origin URL, to the
- * caller. Data is returned in the buffer, up to the specified length, and the
- * offset in the file from which the data comes is written to the offset
- * parameter.
- *
- * Like read(2), it returns the total bytes read, 0 for EOF, -1 for error.
- *
- * The blocks that it returns are the ones previously registered by calls to
- * range_fetch_addranges (although it doesn't guarantee that only those block
- * are returned - that's just what it asks the remote for, but if the remote
- * returns more then it'll pass more to the caller - which doesn't matter).
- */
-int get_range_block(struct range_fetch *rf, off_t * offset, unsigned char *data,
-                    size_t dlen) {
-    size_t bytes_to_caller = 0;
-
-    /* If we're not in the middle of reading a block of actual data */
-    if (!rf->block_left) {
-      check_boundary:
-        /* And if not reading a MIME multipart boundary */
-        if (!rf->boundary) {
-
-            /* Then we're reading the start of a new set of HTTP headers
-             * (possibly after connecting and sending a request first. */
-            int newconn = 0;
-            int header_result;
-
-            /* If the server closed the connection on us, close our end. */
-            if (rf->sd != -1 && rf->server_close == 2) {
-                close(rf->sd);
-                rf->sd = -1;
-            }
+    /* If we did not get back all the ranges we wanted, consider it an error */
+    if( rf->rangessent != rf->rangesdone ) {
+        fprintf( stderr, "Missing ranges in response from server!\n" );
+        return -1;
+    }
 
-            /* If not connected, connect and immediately request a block */
-            if (rf->sd == -1) {
-                if (rf->rangesdone == rf->nranges)
-                    return 0;
-                range_fetch_connect(rf);
-                if (rf->sd == -1)
-                    return -1;
-                newconn = 1;
-                range_fetch_getmore(rf);
-            }
+    /* Else, let the zsync receiver know that we're at EOF; there
+     * could be data in its buffer that it can use or needs to process */
+    if( zsync_receive_data( rf->zr, NULL, rf->offset, 0 ) ) {
+        return -1;
+    }
 
-            /* read the response headers */
-            header_result = range_fetch_read_http_headers(rf);
+    /* If we got a redirect, we need to set a new target URL
+     * NOTE: we are violating the "the client SHOULD continue to use
+     * the Request-URI for future requests" of RFC2616 10.3.3 for 302s.
+     * It's not practical given the number of requests we are making to
+     * follow the RFC here, and at least we're only remembering it for
+     * the duration of this transfer. */
+    {
+        long nredir = 0;
+        char *redirurl;
+        char *p;
 
-            /* Might be the last */
-            if (rf->server_close == 1)
-                rf->server_close = 2;
+        res = curl_easy_getinfo( rf->curl, CURLINFO_REDIRECT_COUNT, &nredir );
+        if( res == CURLE_OK && nredir > 0 ) {
+            /* There were redirects */
 
-            /* EOF on first connect is fatal */
-            if (newconn && header_result == 0) {
-                fprintf(stderr, "EOF from %s\n", rf->url);
+            res = curl_easy_getinfo( rf->curl, CURLINFO_EFFECTIVE_URL, &redirurl );
+            if( res != CURLE_OK ) {
+                fprintf(stderr,
+                       "Could not get redirect target URL: %s\n",
+                       curl_easy_strerror(res));
                 return -1;
             }
 
-            /* Return EOF or error to caller */
-            if (header_result <= 0)
-                return header_result ? -1 : 0;
-
-            /* Reconnect for a redirect */
-            if (header_result >= 300 && header_result < 400) {
-                rf->server_close = 2;
-                goto check_boundary;
-            }
-
-            /* HTTP Pipelining - send next request before reading current response */
-            if (!rf->server_close)
-                range_fetch_getmore(rf);
-        }
-
-        /* Okay, if we're (now) reading a MIME boundary */
-        if (rf->boundary) {
-            /* Throw away blank line */
-            char buf[512];
-            int gotr = 0;
-            if (!rfgets(buf, sizeof(buf), rf))
-                return 0;
-
-            /* Get, hopefully, boundary marker line */
-            if (!rfgets(buf, sizeof(buf), rf))
-                return 0;
-            if (buf[0] != '-' || buf[1] != '-')
-                return 0;
-
-            if (memcmp(&buf[2], rf->boundary, strlen(rf->boundary))) {
-                fprintf(stderr, "got bad block boundary: %s != %s",
-                        rf->boundary, buf);
-                return -1;      /* This is an error now */
-            }
-
-            /* Last record marker has boundary followed by - */
-            if (buf[2 + strlen(rf->boundary)] == '-') {
-                free(rf->boundary);
-                rf->boundary = NULL;
-                goto check_boundary;
-            }
+            p = strdup(redirurl);
 
-            /* Otherwise, we're reading the MIME headers for this part until we get \r\n alone */
-            for (; buf[0] != '\r' && buf[0] != '\n' && buf[0] != '\0';) {
-                off_t from, to;
-
-                /* Get next header */
-                if (!rfgets(buf, sizeof(buf), rf))
-                    return 0;
-                buflwr(buf);  /* HTTP headers are case insensitive */
-
-                /* We're looking for the Content-Range: header, to tell us how
-                 * many bytes and what part of the target file they represent.
-                 */
-                if (2 ==
-                    sscanf(buf,
-                           "content-range: bytes " OFF_T_PF "-" OFF_T_PF "/",
-                           &from, &to)) {
-                    rf->offset = from;
-                    rf->block_left = to - from + 1;
-                    gotr = 1;
-                }
-            }
-
-            /* If we didn't get the byte range that this block represents, it's busted. */
-            if (!gotr) {
+            /* Remember the redirected URL for the next request */
+            res = curl_easy_setopt( rf->curl, CURLOPT_URL, p );
+            if( res != CURLE_OK ) {
                 fprintf(stderr,
-                        "got multipart/byteranges but no Content-Range?");
+                       "Could not save redirect target URL: %s\n",
+                       curl_easy_strerror(res));
                 return -1;
             }
 
-            /* Else, record that this range is (being) received */
-            rf->rangesdone++;
+            /* OK to free rf->url now, curl doesn't need it anymore */
+            free(rf->url);
+            rf->url = p;
         }
     }
 
-    /* Now the easy bit - we are reading a block of actual data */
-    if (!rf->block_left)
-        return 0;   /* pass EOF back to caller */
-    *offset = rf->offset;   /* caller wants to know what this data is */
-
-    /* Loop until we've retrieved a whole block */
-    for (;;) {
-        /* Calculate how much more we can return to the caller now. This is the
-         * minimum of:
-         *   the amount left in this block from the remote
-         *   space left in the caller's buffer
-         *   the amount we have actually read from the remote
-         */
-        size_t rl = rf->block_left;
-        if (rl > dlen)
-            rl = dlen;
-        if ((size_t) (rf->buf_end - rf->buf_start) < rl) {
-            rl = rf->buf_end - rf->buf_start;
-
-            /* There is more data in this block, and space for more in the
-             * caller's buffer, but we don't have any more read from the remote
-             * into our buffer yet. So read more now.
-             * If we don't get data, drop through and return what we have got.
-             * If we do, back to top of loop and try again.
-             */
-            if (!rl && get_more_data(rf) > 0)
-                continue;
-        }
-
-        /* If the caller's buffer is full or there's no more data in this block
-         * to give, we can now return. */
-        if (!rl)
-            return bytes_to_caller;
-
-        /* Copy that amount to the caller's their buffer from our buffer */
-        memcpy(data, &(rf->buf[rf->buf_start]), rl);
-        rf->buf_start += rl;    /* Track pos in our buffer... */
-        data += rl;
-        dlen -= rl;             /* ...and caller's */
-        bytes_to_caller += rl;  /* ...and the return value */
-
-        /* Keep track of how much of the current block is left to read */
-        rf->block_left -= rl;
-        /* and what position we are up to in the whole source file */
-        rf->offset += rl;
-        /* And go around again */
-    }
-}
-
-/* range_fetch_bytes_down
- * Simple getter method, returns the total bytes retrieved */
-off_t range_fetch_bytes_down(const struct range_fetch * rf) {
-    return rf->bytes_down;
-}
-
-/* Destructor */
-void range_fetch_end(struct range_fetch *rf) {
-    if (rf->sd != -1)
-        close(rf->sd);
-    free(rf->ranges_todo);
-    free(rf->boundary);
-    free(rf->url);
-    free(rf->cport);
-    free(rf->chost);
-    free(rf);
+    return 1;
 }
diff --git a/http.h b/http.h
index 36b6876..0ec81d5 100644
--- a/http.h
+++ b/http.h
@@ -14,19 +14,26 @@
  *   COPYING file for details.
  */
 
+#include "libzsync/zsync.h"
 
 
 extern char *referer;
 
-int set_proxy_from_string(const char* s);
+extern char *cacert;
+extern char *want_interface;
+extern char *sslcert;
+extern char *sslkey;
+extern int be_insecure;
+extern int be_verbose;
+extern long use_timeout;
 
-FILE* http_get(const char* orig_url, char** track_referer, const char* tfname);
+FILE* http_get(const char *orig_url, char **track_referer, const char *tfname);
 
 struct range_fetch;
 
-struct range_fetch* range_fetch_start(const char* orig_url);
+struct range_fetch* range_fetch_start(const char* orig_url, struct zsync_receiver* zr);
 void range_fetch_addranges(struct range_fetch* rf, off_t* ranges, int nranges);
-int get_range_block(struct range_fetch* rf, off_t* offset, unsigned char* data, size_t dlen);
+int range_fetch_perform(struct range_fetch* rf);
 off_t range_fetch_bytes_down(const struct range_fetch* rf);
 void range_fetch_end(struct range_fetch* rf);
 
diff --git a/librcksum/Makefile.in b/librcksum/Makefile.in
index 305029a..e161a50 100644
--- a/librcksum/Makefile.in
+++ b/librcksum/Makefile.in
@@ -1,9 +1,9 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.11.3 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011 Free Software
+# Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -215,14 +215,14 @@ $(am__aclocal_m4_deps):
 
 clean-noinstLIBRARIES:
 	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-librcksum.a: $(librcksum_a_OBJECTS) $(librcksum_a_DEPENDENCIES) 
+librcksum.a: $(librcksum_a_OBJECTS) $(librcksum_a_DEPENDENCIES) $(EXTRA_librcksum_a_DEPENDENCIES) 
 	-rm -f librcksum.a
 	$(librcksum_a_AR) librcksum.a $(librcksum_a_OBJECTS) $(librcksum_a_LIBADD)
 	$(RANLIB) librcksum.a
 
 clean-noinstPROGRAMS:
 	-test -z "$(noinst_PROGRAMS)" || rm -f $(noinst_PROGRAMS)
-md4test$(EXEEXT): $(md4test_OBJECTS) $(md4test_DEPENDENCIES) 
+md4test$(EXEEXT): $(md4test_OBJECTS) $(md4test_DEPENDENCIES) $(EXTRA_md4test_DEPENDENCIES) 
 	@rm -f md4test$(EXEEXT)
 	$(LINK) $(md4test_OBJECTS) $(md4test_LDADD) $(LIBS)
 
@@ -386,14 +386,15 @@ check-TESTS: $(TESTS)
 	  fi; \
 	  dashes=`echo "$$dashes" | sed s/./=/g`; \
 	  if test "$$failed" -eq 0; then \
-	    echo "$$grn$$dashes"; \
+	    col="$$grn"; \
 	  else \
-	    echo "$$red$$dashes"; \
+	    col="$$red"; \
 	  fi; \
-	  echo "$$banner"; \
-	  test -z "$$skipped" || echo "$$skipped"; \
-	  test -z "$$report" || echo "$$report"; \
-	  echo "$$dashes$$std"; \
+	  echo "$${col}$$dashes$${std}"; \
+	  echo "$${col}$$banner$${std}"; \
+	  test -z "$$skipped" || echo "$${col}$$skipped$${std}"; \
+	  test -z "$$report" || echo "$${col}$$report$${std}"; \
+	  echo "$${col}$$dashes$${std}"; \
 	  test "$$failed" -eq 0; \
 	else :; fi
 
@@ -442,10 +443,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
diff --git a/librcksum/md4.h b/librcksum/md4.h
index e90603a..9aea99c 100644
--- a/librcksum/md4.h
+++ b/librcksum/md4.h
@@ -16,6 +16,17 @@
 #ifndef _MD4_H_
 #define _MD4_H_
 
+/* Rename MD4 symbols to avoid namespace pollution. */
+#define MD4Init         zsync__MD4Init
+#define MD4Update       zsync__MD4Update
+#define MD4Pad          zsync__MD4Pad
+#define MD4Final        zsync__MD4Final
+#define MD4Transform    zsync__MD4Transform
+#define MD4End          zsync__MD4End
+#define MD4File         zsync__MD4File
+#define MD4FileChunk    zsync__MD4FileChunk
+#define MD4Data         zsync__MD4Data
+
 #include "zsglobal.h"
 
 #ifdef HAVE_INTTYPES_H
diff --git a/librcksum/state.c b/librcksum/state.c
index 0648bb2..824be92 100644
--- a/librcksum/state.c
+++ b/librcksum/state.c
@@ -86,8 +86,8 @@ struct rcksum_state *rcksum_init(zs_blockid nblocks, size_t blocksize,
             }
 
             z->blockhashes =
-                malloc(sizeof(z->blockhashes[0]) *
-                        (z->blocks + z->seq_matches));
+                calloc((z->blocks + z->seq_matches),
+                        sizeof(z->blockhashes[0]));
             if (z->blockhashes != NULL)
                 return z;
 
diff --git a/libzsync/Makefile.in b/libzsync/Makefile.in
index 1e5d6c0..84fb3c5 100644
--- a/libzsync/Makefile.in
+++ b/libzsync/Makefile.in
@@ -1,9 +1,9 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.11.3 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011 Free Software
+# Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -214,14 +214,14 @@ $(am__aclocal_m4_deps):
 
 clean-noinstLIBRARIES:
 	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libzsync.a: $(libzsync_a_OBJECTS) $(libzsync_a_DEPENDENCIES) 
+libzsync.a: $(libzsync_a_OBJECTS) $(libzsync_a_DEPENDENCIES) $(EXTRA_libzsync_a_DEPENDENCIES) 
 	-rm -f libzsync.a
 	$(libzsync_a_AR) libzsync.a $(libzsync_a_OBJECTS) $(libzsync_a_LIBADD)
 	$(RANLIB) libzsync.a
 
 clean-noinstPROGRAMS:
 	-test -z "$(noinst_PROGRAMS)" || rm -f $(noinst_PROGRAMS)
-sha1test$(EXEEXT): $(sha1test_OBJECTS) $(sha1test_DEPENDENCIES) 
+sha1test$(EXEEXT): $(sha1test_OBJECTS) $(sha1test_DEPENDENCIES) $(EXTRA_sha1test_DEPENDENCIES) 
 	@rm -f sha1test$(EXEEXT)
 	$(LINK) $(sha1test_OBJECTS) $(sha1test_LDADD) $(LIBS)
 
@@ -383,14 +383,15 @@ check-TESTS: $(TESTS)
 	  fi; \
 	  dashes=`echo "$$dashes" | sed s/./=/g`; \
 	  if test "$$failed" -eq 0; then \
-	    echo "$$grn$$dashes"; \
+	    col="$$grn"; \
 	  else \
-	    echo "$$red$$dashes"; \
+	    col="$$red"; \
 	  fi; \
-	  echo "$$banner"; \
-	  test -z "$$skipped" || echo "$$skipped"; \
-	  test -z "$$report" || echo "$$report"; \
-	  echo "$$dashes$$std"; \
+	  echo "$${col}$$dashes$${std}"; \
+	  echo "$${col}$$banner$${std}"; \
+	  test -z "$$skipped" || echo "$${col}$$skipped$${std}"; \
+	  test -z "$$report" || echo "$${col}$$report$${std}"; \
+	  echo "$${col}$$dashes$${std}"; \
 	  test "$$failed" -eq 0; \
 	else :; fi
 
@@ -439,10 +440,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
diff --git a/libzsync/sha1.c b/libzsync/sha1.c
index 05b8431..3b6b7f3 100644
--- a/libzsync/sha1.c
+++ b/libzsync/sha1.c
@@ -21,7 +21,13 @@ static const char rcsid[] = "$OpenBSD: sha1.c,v 1.19 2004/05/28 15:10:27 millert
 #endif /* LIBC_SCCS and not lint */
 
 #include <sys/param.h>
+
+#ifdef HAVE_INTTYPES_H
+#include <inttypes.h>
+#else
 #include <stdint.h>
+#endif
+
 #include <string.h>
 #include "sha1.h"
 
diff --git a/libzsync/sha1.h b/libzsync/sha1.h
index 3946505..11d2cfb 100644
--- a/libzsync/sha1.h
+++ b/libzsync/sha1.h
@@ -9,6 +9,17 @@
 #ifndef _SHA1_H
 #define _SHA1_H
 
+/* Rename SHA1 symbols to avoid namespace pollution. */
+#define SHA1Init         zsync__SHA1Init
+#define SHA1Pad          zsync__SHA1Pad
+#define SHA1Transform    zsync__SHA1Transform
+#define SHA1Update       zsync__SHA1Update
+#define SHA1Final        zsync__SHA1Final
+#define SHA1End          zsync__SHA1End
+#define SHA1File         zsync__SHA1File
+#define SHA1FileChunk    zsync__SHA1FileChunk
+#define SHA1Data         zsync__SHA1Data
+
 #include "config.h"
 
 #ifdef HAVE_INTTYPES_H
diff --git a/libzsync/zsync.c b/libzsync/zsync.c
index 8b18d42..2ca1fb1 100644
--- a/libzsync/zsync.c
+++ b/libzsync/zsync.c
@@ -42,6 +42,8 @@
 #include <ctype.h>
 #include <time.h>
 
+#include <errno.h>
+
 #include <arpa/inet.h>
 
 #ifdef WITH_DMALLOC
@@ -139,6 +141,7 @@ static char **append_ptrlist(int *n, char **p, char *a) {
 
 /* Constructor */
 struct zsync_state *zsync_begin(FILE * f) {
+  int valid_length=0;
     /* Defaults for the checksum bytes and sequential matches properties of the
      * rcksum_state. These are the defaults from versions of zsync before these
      * were variable. */
@@ -194,7 +197,11 @@ struct zsync_state *zsync_begin(FILE * f) {
                 }
             }
             else if (!strcmp(buf, "Length")) {
-                zs->filelen = atoll(p);
+                errno = 0;
+                zs->filelen = strtoll(p, 0, 10);
+                if (errno == 0) {
+                    valid_length = 1;
+                }
             }
             else if (!strcmp(buf, "Filename")) {
                 zs->filename = strdup(p);
@@ -303,7 +310,12 @@ struct zsync_state *zsync_begin(FILE * f) {
             return NULL;
         }
     }
-    if (!zs->filelen || !zs->blocksize) {
+    /* zero length file, skip blocksums */
+    if (valid_length && !zs->filelen) {
+        return zs;
+    }
+    /* cannot test !zs->filelen or we will fail on valid 0 length files */
+    if (!valid_length || !zs->blocksize) {
         fprintf(stderr, "Not a zsync file (looked for Blocksize and Length lines)\n");
         free(zs);
         return NULL;
@@ -326,6 +338,7 @@ struct zsync_state *zsync_begin(FILE * f) {
 static int zsync_read_blocksums(struct zsync_state *zs, FILE * f,
                                 int rsum_bytes, int checksum_bytes,
                                 int seq_matches) {
+    zs_blockid id = 0;
     /* Make the rcksum_state first */
     if (!(zs->rs = rcksum_init(zs->blocks, zs->blocksize, rsum_bytes,
                                checksum_bytes, seq_matches))) {
@@ -333,7 +346,6 @@ static int zsync_read_blocksums(struct zsync_state *zs, FILE * f,
     }
 
     /* Now read in and store the checksums */
-    zs_blockid id = 0;
     for (; id < zs->blocks; id++) {
         struct rsum r = { 0, 0 };
         unsigned char checksum[CHECKSUM_SIZE];
@@ -364,6 +376,9 @@ static int zsync_read_blocksums(struct zsync_state *zs, FILE * f,
 static time_t parse_822(const char* ts) {
     struct tm t;
 
+    /* strptime will not initialize isdst */
+    t.tm_isdst = -1;
+
     if (strptime(ts, "%a, %d %b %Y %H:%M:%S %z", &t) == NULL
         && strptime(ts, "%d %b %Y %H:%M:%S %z", &t) == NULL) {
         return -1;
@@ -388,7 +403,12 @@ int zsync_blocksize(const struct zsync_state *zs) {
  * Returns the suggested filename to be used for the final result of this
  * zsync.  Malloced string to be freed by the caller. */
 char *zsync_filename(const struct zsync_state *zs) {
-    return strdup(zs->gzhead && zs->zfilename ? zs->zfilename : zs->filename);
+    char *p = zs->gzhead && zs->zfilename ? zs->zfilename : zs->filename;
+    return p ? strdup(p) : NULL;
+}
+
+off_t zsync_filelen(const struct zsync_state *zs) {
+    return zs->filelen;
 }
 
 /* time_t = zsync_mtime(self)
@@ -479,6 +499,10 @@ off_t *zsync_needed_byte_ranges(struct zsync_state * zs, int *num, int type) {
     for (i = 0; i < nrange; i++) {
         byterange[2 * i] = blrange[2 * i] * (off_t)zs->blocksize;
         byterange[2 * i + 1] = blrange[2 * i + 1] * (off_t)zs->blocksize - 1;
+
+        /* Don't go past the end of the file */
+        if( byterange[2*i+1] > zs->filelen - 1 )
+            byterange[2*i+1] = zs->filelen - 1;
     }
     free(blrange);      /* And release the blocks, we're done with them */
 
diff --git a/libzsync/zsync.h b/libzsync/zsync.h
index 06ae222..ff6b3e5 100644
--- a/libzsync/zsync.h
+++ b/libzsync/zsync.h
@@ -13,6 +13,9 @@
  *   COPYING file for details.
  */
 
+#ifndef ZSYNC_ZSYNC_H
+#define ZSYNC_ZSYNC_H
+
 struct zsync_state;
 
 /* zsync_begin - load a zsync file and return data structure to use for the rest of the process.
@@ -25,6 +28,8 @@ int zsync_hint_decompress(const struct zsync_state*);
 
 /* zsync_filename - return the suggested filename from the .zsync file */
 char* zsync_filename(const struct zsync_state*);
+/* zsync_filelen - return the length from the .zsync file */
+off_t zsync_filelen(const struct zsync_state*);
 /* zsync_mtime - return the suggested mtime from the .zsync file */
 time_t zsync_mtime(const struct zsync_state*);
 
@@ -93,3 +98,4 @@ void zsync_end_receive(struct zsync_receiver* zr);
  * Returns 0 for success; if not, you should not submit more data. */
 int zsync_receive_data(struct zsync_receiver* zr, const unsigned char* buf, off_t offset, size_t len);
 
+#endif
diff --git a/url.c b/url.c
index 6448e09..871e81f 100644
--- a/url.c
+++ b/url.c
@@ -29,57 +29,6 @@
 
 const char http_scheme[] = { "http://" };
 
-/* path_str = get_http_host_port(url_str, &host, host_len, &port_str)
- * For the given url_str, returns:
- * the hostname, in host[] array provided by caller (up to length host_len)
- * the port (if any) as a malloced string, pointer to this stored in *port_str
- * return value is the path part of the URL, a malloced string.
- * Or return value NULL on failure (host and port could have been written to).
- */
-char *get_http_host_port(const char *url, char *hostn, int hnlen, char **port) {
-    char *p, *q;
-
-    /* Check it's HTTP */
-    if (memcmp(url, http_scheme, strlen(http_scheme)))
-        return NULL;
-
-    q = url + strlen(http_scheme);
-
-    p = strchr(q, ':');
-    if (p) {                    /* if : is after the first /, we have looked too far ahead */
-        char *r = strchr(q, '/');
-        if (r && r < p)
-            p = NULL;
-    }
-    if (!p) {
-        *port = strdup("http");
-        p = strchr(q, '/');
-    }
-
-    if (!p)
-        return NULL;
-
-    if (p - q < hnlen - 1) {
-        memcpy(hostn, q, p - q);
-        hostn[p - q] = 0;
-    }
-
-    if (*p == ':') {
-        size_t l;
-        q = p;
-        p = strchr(p, '/');
-        l = p ? (size_t) (p - q - 1) : strlen(q) - 1;
-        *port = malloc(l + 1);
-        if (!*port)
-            return NULL;
-        memcpy(*port, q + 1, l);
-        (*port)[l] = 0;
-        if (!p)
-            p = strdup("/");
-    }
-    return p;
-}
-
 /* abs_url_str = make_url_absolute(base_str, url_str)
  * Returns an absolute version of url_str relative to base_str, as a malloced
  * string. Or NULL on error. */
diff --git a/url.h b/url.h
index b03de29..0a477bb 100644
--- a/url.h
+++ b/url.h
@@ -15,13 +15,6 @@
 
 extern const char http_scheme[];
 
-/* Given an HTTP URL, return the path path of the URL as the return value, and
- * return the hostname in the provided buffer (hostn, length hnlen)
- * and, if present, return a (malloced) string buffer containing the port string.
- * Or return NULL if not HTTP or other parsing failure.
- */
-char* get_http_host_port(const char* url, char* hostn, int hnlen, char** port);
-
 char* __attribute__((pure)) make_url_absolute(const char* base, const char* url);
 
 int __attribute__((pure)) is_url_absolute(const char* url);
diff --git a/zlib/Makefile.am b/zlib/Makefile.am
index 1415670..b59b9ae 100644
--- a/zlib/Makefile.am
+++ b/zlib/Makefile.am
@@ -4,3 +4,6 @@ noinst_LIBRARIES = libinflate.a libdeflate.a
 libinflate_a_SOURCES = zlib.h inflate.c inflate.h inffixed.h adler32.c inftrees.c inftrees.h zutil.c zutil.h crc32.c crc32.h zconf.h
 
 libdeflate_a_SOURCES = deflate.c deflate.h compress.c trees.c trees.h
+
+EXTRA_DIST = README.zsync
+
diff --git a/zlib/Makefile.in b/zlib/Makefile.in
index 388bb37..cda5fbb 100644
--- a/zlib/Makefile.in
+++ b/zlib/Makefile.in
@@ -1,9 +1,9 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.11.3 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011 Free Software
+# Foundation, Inc.
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -174,6 +174,7 @@ top_srcdir = @top_srcdir@
 noinst_LIBRARIES = libinflate.a libdeflate.a
 libinflate_a_SOURCES = zlib.h inflate.c inflate.h inffixed.h adler32.c inftrees.c inftrees.h zutil.c zutil.h crc32.c crc32.h zconf.h
 libdeflate_a_SOURCES = deflate.c deflate.h compress.c trees.c trees.h
+EXTRA_DIST = README.zsync
 all: all-am
 
 .SUFFIXES:
@@ -211,11 +212,11 @@ $(am__aclocal_m4_deps):
 
 clean-noinstLIBRARIES:
 	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libdeflate.a: $(libdeflate_a_OBJECTS) $(libdeflate_a_DEPENDENCIES) 
+libdeflate.a: $(libdeflate_a_OBJECTS) $(libdeflate_a_DEPENDENCIES) $(EXTRA_libdeflate_a_DEPENDENCIES) 
 	-rm -f libdeflate.a
 	$(libdeflate_a_AR) libdeflate.a $(libdeflate_a_OBJECTS) $(libdeflate_a_LIBADD)
 	$(RANLIB) libdeflate.a
-libinflate.a: $(libinflate_a_OBJECTS) $(libinflate_a_DEPENDENCIES) 
+libinflate.a: $(libinflate_a_OBJECTS) $(libinflate_a_DEPENDENCIES) $(EXTRA_libinflate_a_DEPENDENCIES) 
 	-rm -f libinflate.a
 	$(libinflate_a_AR) libinflate.a $(libinflate_a_OBJECTS) $(libinflate_a_LIBADD)
 	$(RANLIB) libinflate.a
@@ -345,10 +346,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
diff --git a/zlib/README.zsync b/zlib/README.zsync
new file mode 100644
index 0000000..37cd965
--- /dev/null
+++ b/zlib/README.zsync
@@ -0,0 +1,89 @@
+Local changes to zlib used by zsync
+-----------------------------------
+
+There are two different modes of operation that zsync supports that
+these patches are designed to support:
+
+Changes to the deflate code: Compressing a file in a way that is optimised for
+zsync's block-based rsync algorithm - starting a new zlib block for each 1024
+byte (for example) block in the source file. cf
+http://zsync.moria.org.uk/paper/ch03s04.html . This is used by makegz.c in the
+zsync source.
+
+Changes to the inflate code: Working with files compressed with the standard
+gzip(1). To enable people to get started with zsync, I want it to work with
+existing compressed content. To achieve optimal results with standard gzip
+files, I made zsync capable of starting decompression in the middle of a block.
+In these cases it has to download the block header, then skips forward to the
+part of the block that gives it the data that it wants.  cf
+http://zsync.moria.org.uk/paper/ch03s02.html
+
+Contrary to some internet discussion, the changes are not related to rsync's
+changes nor to rsync compatibility (zsync isn't compatible with rsync -
+whatever that would mean - nor do these changes relate in any way to the
+rsyncable gzip patch).
+
+Changes to the deflate code
+---------------------------
+
+Essentially, I hijacked Z_PARTIAL_FLUSH to mean something new - I want to start
+a new zlib block, but unlike Z_PARTIAL_FLUSH I don't need to emit a whole byte
+between blocks, so I took that out. Correctly this ought to be implemented by
+adding a Z_NEWBLOCKONLY_FLUSH or something like that instead of repurposing an
+existing state.
+
+(If this were the only issue preventing the use of a standard zlib, distros
+could change it to use Z_PARTIAL_FLUSH with only a slight loss of compression
+efficiency.)
+
+Changes to the inflate code
+---------------------------
+
+zsync uses the rsync algorithm to construct a desired file from an
+(e.g.) older local version of the file and then downloading any
+new/needed blocks from a server; the aim being to minimise the amount of
+data downloaded to construct the target file. It supports downloading
+those blocks from a gzipped version of the file on the server. If I want
+e.g. bytes 4096-8192 of the file from inside the gzipped file, I could
+download the whole zlib block (using a map of the compressed file that I
+construct beforehand and is downloaded first) containing the range
+4096-8192 (zsync 0.1.0 used this method); but it can do better (fewer
+bytes downloaded) than that, by downloading just the block header and
+then downloading the bytes within that compressed block that correspond
+to bytes 4096-8192 of the contained data.
+
+To do that, I need:
+a) to be able to start inflating at the start of "*any* length/literal/eob code
+in any dynamic or fixed block, or at *any* stored byte in a stored block.".
+That is what additional function inflate_advance() and the export of
+updatewindow() allow me to do.
+
+b) make a map of the gzip file that lets me know what points I should start
+downloading at in order to inflate particular byte ranges of the contained
+content. To do this, I can decompress each byte range into a buffer of that
+size and then quiz zlib for the position in the stream; but I need to know that
+the position in the stream does correspond to the start of a code or the middle
+of a stored block (not, e.g., that we have just read a backref and the backref
+expands to span the boundary - in that case, I would need to know that position
+where the backref started and the lib doesn't give me a way to find that out).
+
+This is given by inflateSafePoint(), and the implicit guarantee provided by
+using my own copy of the library that I know how the library behaves around
+internal states and stream position (I need a guarantee that the library won't
+read ahead more than it needs to, and I need to access certain member variables
+directly to get the bit position in the stream).
+
+I also removed inflate_fast as I did not want to spend the time working out if
+it was compatible with these changes.
+
+I have started a discussion with one of the zlib maintainers about getting
+changes such as I would need put into zlib, but it is too early to know whether
+suitable changes will developed or accepted.
+
+Copyright
+---------
+
+I place all my modifications to these files in the public domain.
+
+- Colin Phipps, 2009/12/13
+
diff --git a/zlib/zconf.in.h b/zlib/zconf.in.h
new file mode 100644
index 0000000..3cea897
--- /dev/null
+++ b/zlib/zconf.in.h
@@ -0,0 +1,323 @@
+/* zconf.h -- configuration of the zlib compression library
+ * Copyright (C) 1995-2003 Jean-loup Gailly.
+ * For conditions of distribution and use, see copyright notice in zlib.h
+ */
+
+/* @(#) $Id$ */
+
+#ifndef ZCONF_H
+#define ZCONF_H
+
+/*
+ * If you *really* need a unique prefix for all types and library functions,
+ * compile with -DZ_PREFIX. The "standard" zlib should be compiled without it.
+ */
+#ifdef Z_PREFIX
+#  define deflateInit_  z_deflateInit_
+#  define deflate       z_deflate
+#  define deflateEnd    z_deflateEnd
+#  define inflateInit_  z_inflateInit_
+#  define inflate       z_inflate
+#  define inflateEnd    z_inflateEnd
+#  define deflateInit2_ z_deflateInit2_
+#  define deflateSetDictionary z_deflateSetDictionary
+#  define deflateCopy   z_deflateCopy
+#  define deflateReset  z_deflateReset
+#  define deflatePrime  z_deflatePrime
+#  define deflateParams z_deflateParams
+#  define deflateBound  z_deflateBound
+#  define inflateInit2_ z_inflateInit2_
+#  define inflateSetDictionary z_inflateSetDictionary
+#  define inflateSync   z_inflateSync
+#  define inflateSyncPoint z_inflateSyncPoint
+#  define inflateCopy   z_inflateCopy
+#  define inflateReset  z_inflateReset
+#  define compress      z_compress
+#  define compress2     z_compress2
+#  define compressBound z_compressBound
+#  define uncompress    z_uncompress
+#  define adler32       z_adler32
+#  define crc32         z_crc32
+#  define get_crc_table z_get_crc_table
+
+#  define Byte          z_Byte
+#  define uInt          z_uInt
+#  define uLong         z_uLong
+#  define Bytef         z_Bytef
+#  define charf         z_charf
+#  define intf          z_intf
+#  define uIntf         z_uIntf
+#  define uLongf        z_uLongf
+#  define voidpf        z_voidpf
+#  define voidp         z_voidp
+#endif
+
+#if defined(__MSDOS__) && !defined(MSDOS)
+#  define MSDOS
+#endif
+#if (defined(OS_2) || defined(__OS2__)) && !defined(OS2)
+#  define OS2
+#endif
+#if defined(_WINDOWS) && !defined(WINDOWS)
+#  define WINDOWS
+#endif
+#if (defined(_WIN32) || defined(__WIN32__)) && !defined(WIN32)
+#  define WIN32
+#endif
+#if (defined(MSDOS) || defined(OS2) || defined(WINDOWS)) && !defined(WIN32)
+#  if !defined(__GNUC__) && !defined(__FLAT__) && !defined(__386__)
+#    ifndef SYS16BIT
+#      define SYS16BIT
+#    endif
+#  endif
+#endif
+
+/*
+ * Compile with -DMAXSEG_64K if the alloc function cannot allocate more
+ * than 64k bytes at a time (needed on systems with 16-bit int).
+ */
+#ifdef SYS16BIT
+#  define MAXSEG_64K
+#endif
+#ifdef MSDOS
+#  define UNALIGNED_OK
+#endif
+
+#ifdef __STDC_VERSION__
+#  ifndef STDC
+#    define STDC
+#  endif
+#  if __STDC_VERSION__ >= 199901L
+#    ifndef STDC99
+#      define STDC99
+#    endif
+#  endif
+#endif
+#if !defined(STDC) && (defined(__STDC__) || defined(__cplusplus))
+#  define STDC
+#endif
+#if !defined(STDC) && (defined(__GNUC__) || defined(__BORLANDC__))
+#  define STDC
+#endif
+#if !defined(STDC) && (defined(MSDOS) || defined(WINDOWS) || defined(WIN32))
+#  define STDC
+#endif
+#if !defined(STDC) && (defined(OS2) || defined(__HOS_AIX__))
+#  define STDC
+#endif
+
+#if defined(__OS400__) && !defined(STDC)    /* iSeries (formerly AS/400). */
+#  define STDC
+#endif
+
+#ifndef STDC
+#  ifndef const /* cannot use !defined(STDC) && !defined(const) on Mac */
+#    define const       /* note: need a more gentle solution here */
+#  endif
+#endif
+
+/* Some Mac compilers merge all .h files incorrectly: */
+#if defined(__MWERKS__)||defined(applec)||defined(THINK_C)||defined(__SC__)
+#  define NO_DUMMY_DECL
+#endif
+
+/* Maximum value for memLevel in deflateInit2 */
+#ifndef MAX_MEM_LEVEL
+#  ifdef MAXSEG_64K
+#    define MAX_MEM_LEVEL 8
+#  else
+#    define MAX_MEM_LEVEL 9
+#  endif
+#endif
+
+/* Maximum value for windowBits in deflateInit2 and inflateInit2.
+ * WARNING: reducing MAX_WBITS makes minigzip unable to extract .gz files
+ * created by gzip. (Files created by minigzip can still be extracted by
+ * gzip.)
+ */
+#ifndef MAX_WBITS
+#  define MAX_WBITS   15 /* 32K LZ77 window */
+#endif
+
+/* The memory requirements for deflate are (in bytes):
+            (1 << (windowBits+2)) +  (1 << (memLevel+9))
+ that is: 128K for windowBits=15  +  128K for memLevel = 8  (default values)
+ plus a few kilobytes for small objects. For example, if you want to reduce
+ the default memory requirements from 256K to 128K, compile with
+     make CFLAGS="-O -DMAX_WBITS=14 -DMAX_MEM_LEVEL=7"
+ Of course this will generally degrade compression (there's no free lunch).
+
+   The memory requirements for inflate are (in bytes) 1 << windowBits
+ that is, 32K for windowBits=15 (default value) plus a few kilobytes
+ for small objects.
+*/
+
+                        /* Type declarations */
+
+#ifndef OF /* function prototypes */
+#  ifdef STDC
+#    define OF(args)  args
+#  else
+#    define OF(args)  ()
+#  endif
+#endif
+
+/* The following definitions for FAR are needed only for MSDOS mixed
+ * model programming (small or medium model with some far allocations).
+ * This was tested only with MSC; for other MSDOS compilers you may have
+ * to define NO_MEMCPY in zutil.h.  If you don't need the mixed model,
+ * just define FAR to be empty.
+ */
+#ifdef SYS16BIT
+#  if defined(M_I86SM) || defined(M_I86MM)
+     /* MSC small or medium model */
+#    define SMALL_MEDIUM
+#    ifdef _MSC_VER
+#      define FAR _far
+#    else
+#      define FAR far
+#    endif
+#  endif
+#  if (defined(__SMALL__) || defined(__MEDIUM__))
+     /* Turbo C small or medium model */
+#    define SMALL_MEDIUM
+#    ifdef __BORLANDC__
+#      define FAR _far
+#    else
+#      define FAR far
+#    endif
+#  endif
+#endif
+
+#if defined(WINDOWS) || defined(WIN32)
+   /* If building or using zlib as a DLL, define ZLIB_DLL.
+    * This is not mandatory, but it offers a little performance increase.
+    */
+#  ifdef ZLIB_DLL
+#    if defined(WIN32) && (!defined(__BORLANDC__) || (__BORLANDC__ >= 0x500))
+#      ifdef ZLIB_INTERNAL
+#        define ZEXTERN extern __declspec(dllexport)
+#      else
+#        define ZEXTERN extern __declspec(dllimport)
+#      endif
+#    endif
+#  endif  /* ZLIB_DLL */
+   /* If building or using zlib with the WINAPI/WINAPIV calling convention,
+    * define ZLIB_WINAPI.
+    * Caution: the standard ZLIB1.DLL is NOT compiled using ZLIB_WINAPI.
+    */
+#  ifdef ZLIB_WINAPI
+#    ifdef FAR
+#      undef FAR
+#    endif
+#    include <windows.h>
+     /* No need for _export, use ZLIB.DEF instead. */
+     /* For complete Windows compatibility, use WINAPI, not __stdcall. */
+#    define ZEXPORT WINAPI
+#    ifdef WIN32
+#      define ZEXPORTVA WINAPIV
+#    else
+#      define ZEXPORTVA FAR CDECL
+#    endif
+#  endif
+#endif
+
+#if defined (__BEOS__)
+#  ifdef ZLIB_DLL
+#    ifdef ZLIB_INTERNAL
+#      define ZEXPORT   __declspec(dllexport)
+#      define ZEXPORTVA __declspec(dllexport)
+#    else
+#      define ZEXPORT   __declspec(dllimport)
+#      define ZEXPORTVA __declspec(dllimport)
+#    endif
+#  endif
+#endif
+
+#ifndef ZEXTERN
+#  define ZEXTERN extern
+#endif
+#ifndef ZEXPORT
+#  define ZEXPORT
+#endif
+#ifndef ZEXPORTVA
+#  define ZEXPORTVA
+#endif
+
+#ifndef FAR
+#  define FAR
+#endif
+
+#if !defined(__MACTYPES__)
+typedef unsigned char  Byte;  /* 8 bits */
+#endif
+typedef unsigned int   uInt;  /* 16 bits or more */
+typedef unsigned long  uLong; /* 32 bits or more */
+
+#ifdef SMALL_MEDIUM
+   /* Borland C/C++ and some old MSC versions ignore FAR inside typedef */
+#  define Bytef Byte FAR
+#else
+   typedef Byte  FAR Bytef;
+#endif
+typedef char  FAR charf;
+typedef int   FAR intf;
+typedef uInt  FAR uIntf;
+typedef uLong FAR uLongf;
+
+#ifdef STDC
+   typedef void const *voidpc;
+   typedef void FAR   *voidpf;
+   typedef void       *voidp;
+#else
+   typedef Byte const *voidpc;
+   typedef Byte FAR   *voidpf;
+   typedef Byte       *voidp;
+#endif
+
+#if 0           /* HAVE_UNISTD_H -- this line is updated by ./configure */
+#  include <sys/types.h> /* for off_t */
+#  include <unistd.h>    /* for SEEK_* and off_t */
+#  ifdef VMS
+#    include <unixio.h>   /* for off_t */
+#  endif
+#  define z_off_t  off_t
+#endif
+#ifndef SEEK_SET
+#  define SEEK_SET        0       /* Seek from beginning of file.  */
+#  define SEEK_CUR        1       /* Seek from current position.  */
+#  define SEEK_END        2       /* Set file pointer to EOF plus "offset" */
+#endif
+#ifndef z_off_t
+#  define  z_off_t long
+#endif
+
+#if defined(__OS400__)
+#define NO_vsnprintf
+#endif
+
+#if defined(__MVS__)
+#  define NO_vsnprintf
+#  ifdef FAR
+#    undef FAR
+#  endif
+#endif
+
+/* MVS linker does not support external names larger than 8 bytes */
+#if defined(__MVS__)
+#   pragma map(deflateInit_,"DEIN")
+#   pragma map(deflateInit2_,"DEIN2")
+#   pragma map(deflateEnd,"DEEND")
+#   pragma map(deflateBound,"DEBND")
+#   pragma map(inflateInit_,"ININ")
+#   pragma map(inflateInit2_,"ININ2")
+#   pragma map(inflateEnd,"INEND")
+#   pragma map(inflateSync,"INSY")
+#   pragma map(inflateSetDictionary,"INSEDI")
+#   pragma map(compressBound,"CMBND")
+#   pragma map(inflate_table,"INTABL")
+#   pragma map(inflate_fast,"INFA")
+#   pragma map(inflate_copyright,"INCOPY")
+#endif
+
+#endif /* ZCONF_H */
diff --git a/zlib/zlib.h b/zlib/zlib.h
index 71ffa23..e007251 100644
--- a/zlib/zlib.h
+++ b/zlib/zlib.h
@@ -31,6 +31,7 @@
 #ifndef ZLIB_H
 #define ZLIB_H
 
+#include "zsync_zlib_rename.h"
 #include "zconf.h"
 
 #ifdef __cplusplus
diff --git a/zlib/zsync_zlib_rename.h b/zlib/zsync_zlib_rename.h
new file mode 100644
index 0000000..63bc803
--- /dev/null
+++ b/zlib/zsync_zlib_rename.h
@@ -0,0 +1,49 @@
+/* Rename zlib symbols to avoid namespace pollution. */
+
+#define deflateInit_  zsync__deflateInit_
+#define deflate       zsync__deflate
+#define deflateEnd    zsync__deflateEnd
+#define inflateInit_  zsync__inflateInit_
+#define inflate       zsync__inflate
+#define inflateEnd    zsync__inflateEnd
+#define deflateInit2_ zsync__deflateInit2_
+#define deflateSetDictionary zsync__deflateSetDictionary
+#define deflateCopy   zsync__deflateCopy
+#define deflateReset  zsync__deflateReset
+#define deflatePrime  zsync__deflatePrime
+#define deflateParams zsync__deflateParams
+#define deflateBound  zsync__deflateBound
+#define inflateInit2_ zsync__inflateInit2_
+#define inflateSetDictionary zsync__inflateSetDictionary
+#define inflateSync   zsync__inflateSync
+#define inflateSyncPoint zsync__inflateSyncPoint
+#define inflateCopy   zsync__inflateCopy
+#define inflateReset  zsync__inflateReset
+#define compress      zsync__compress
+#define compress2     zsync__compress2
+#define compressBound zsync__compressBound
+#define uncompress    zsync__uncompress
+#define adler32       zsync__adler32
+#define crc32         zsync__crc32
+#define get_crc_table zsync__get_crc_table
+ 
+#define Byte          zsync__Byte
+#define uInt          zsync__uInt
+#define uLong         zsync__uLong
+#define Bytef         zsync__Bytef
+#define charf         zsync__charf
+#define intf          zsync__intf
+#define uIntf         zsync__uIntf
+#define uLongf        zsync__uLongf
+#define voidpf        zsync__voidpf
+#define voidp         zsync__voidp
+
+#define inflate_advance zsync__inflate_advance
+#define inflateSafePoint zsync__inflateSafePoint
+#define updatewindow zsync__updatewindow
+#define inflate_table zsync__inflate_table
+#define zcalloc zsync__zcalloc
+#define zcfree zsync__zcfree
+#define zError zsync__zError
+#define zlibCompileFlags zsync__zlibCompileFlags
+#define zlibVersion zsync__zlibVersion
-- 
1.8.5.1+fc2

