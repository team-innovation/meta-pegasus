From 415373897156f061615c93ce6b367c5836c42156 Mon Sep 17 00:00:00 2001
From: Ajit Modi <ajitmodi05@gmail.com>
Date: Tue, 17 Dec 2019 11:18:00 -0700
Subject: [PATCH 2/2] VID-7204: fix video preload issue

---
 .../BasicUsageEnvironment.cpp                 |  5 +++
 .../include/BasicUsageEnvironment.hh          |  1 +
 UsageEnvironment/include/UsageEnvironment.hh  |  1 +
 liveMedia/ProxyServerMediaSession.cpp         | 34 +++++++++++++++----
 liveMedia/RTPInterface.cpp                    | 12 +++++++
 liveMedia/include/ProxyServerMediaSession.hh  |  2 ++
 6 files changed, 48 insertions(+), 7 deletions(-)

diff --git a/BasicUsageEnvironment/BasicUsageEnvironment.cpp b/BasicUsageEnvironment/BasicUsageEnvironment.cpp
index a58bfdc..e98be42 100644
--- a/BasicUsageEnvironment/BasicUsageEnvironment.cpp
+++ b/BasicUsageEnvironment/BasicUsageEnvironment.cpp
@@ -64,6 +64,11 @@ UsageEnvironment& BasicUsageEnvironment::operator<<(int i) {
   return *this;
 }
 
+UsageEnvironment& BasicUsageEnvironment::operator<<(long i) {
+  fprintf(stderr, "%ld", i);
+  return *this;
+}
+
 UsageEnvironment& BasicUsageEnvironment::operator<<(unsigned u) {
   fprintf(stderr, "%u", u);
   return *this;
diff --git a/BasicUsageEnvironment/include/BasicUsageEnvironment.hh b/BasicUsageEnvironment/include/BasicUsageEnvironment.hh
index 7d5133f..bc2752b 100644
--- a/BasicUsageEnvironment/include/BasicUsageEnvironment.hh
+++ b/BasicUsageEnvironment/include/BasicUsageEnvironment.hh
@@ -33,6 +33,7 @@ public:
 
   virtual UsageEnvironment& operator<<(char const* str);
   virtual UsageEnvironment& operator<<(int i);
+  virtual UsageEnvironment& operator<<(long i);
   virtual UsageEnvironment& operator<<(unsigned u);
   virtual UsageEnvironment& operator<<(double d);
   virtual UsageEnvironment& operator<<(void* p);
diff --git a/UsageEnvironment/include/UsageEnvironment.hh b/UsageEnvironment/include/UsageEnvironment.hh
index 2527c2c..c3e213e 100644
--- a/UsageEnvironment/include/UsageEnvironment.hh
+++ b/UsageEnvironment/include/UsageEnvironment.hh
@@ -82,6 +82,7 @@ public:
   // 'console' output:
   virtual UsageEnvironment& operator<<(char const* str) = 0;
   virtual UsageEnvironment& operator<<(int i) = 0;
+  virtual UsageEnvironment& operator<<(long i) = 0;
   virtual UsageEnvironment& operator<<(unsigned u) = 0;
   virtual UsageEnvironment& operator<<(double d) = 0;
   virtual UsageEnvironment& operator<<(void* p) = 0;
diff --git a/liveMedia/ProxyServerMediaSession.cpp b/liveMedia/ProxyServerMediaSession.cpp
index 0701239..e61e424 100644
--- a/liveMedia/ProxyServerMediaSession.cpp
+++ b/liveMedia/ProxyServerMediaSession.cpp
@@ -248,7 +248,7 @@ ProxyRTSPClient::ProxyRTSPClient(ProxyServerMediaSession& ourServerMediaSession,
   : RTSPClient(ourServerMediaSession.envir(), rtspURL, verbosityLevel, "ProxyRTSPClient",
 	       tunnelOverHTTPPortNum == (portNumBits)(~0) ? 0 : tunnelOverHTTPPortNum, socketNumToServer),
     fOurServerMediaSession(ourServerMediaSession), fOurURL(strDup(rtspURL)), fStreamRTPOverTCP(tunnelOverHTTPPortNum != 0),
-    fSetupQueueHead(NULL), fSetupQueueTail(NULL), fNumSetupsDone(0), fNextDESCRIBEDelay(1),
+    fSetupQueueHead(NULL), fSetupQueueTail(NULL), fNumSetupsDone(0), fNextDESCRIBEDelay(1), fBurstDescribeCount(0),
     fServerSupportsGetParameter(False), fLastCommandWasPLAY(False), fDoneDESCRIBE(False),
     fLivenessCommandTask(NULL), fDESCRIBECommandTask(NULL), fSubsessionTimerTask(NULL), fResetTask(NULL) {
   if (username != NULL && password != NULL) {
@@ -257,7 +257,11 @@ ProxyRTSPClient::ProxyRTSPClient(ProxyServerMediaSession& ourServerMediaSession,
     fOurAuthenticator = NULL;
   }
 }
-
+void ProxyRTSPClient::resetForDescribe() {
+    reset();
+    fOurServerMediaSession.resetDESCRIBEState();
+    setBaseURL(fOurURL); // because we'll be sending an initial "DESCRIBE" all over again
+}
 void ProxyRTSPClient::reset() {
   envir().taskScheduler().unscheduleDelayedTask(fLivenessCommandTask);
   envir().taskScheduler().unscheduleDelayedTask(fDESCRIBECommandTask);
@@ -304,7 +308,15 @@ void ProxyRTSPClient::continueAfterDESCRIBE(char const* sdpDescription) {
     // ("OPTIONS" or "GET_PARAMETER") commands.  (The usual RTCP liveness mechanism wouldn't work here, because RTCP packets
     // don't get sent until after the "PLAY" command.)
     scheduleLivenessCommand();
+    fBurstDescribeCount = 0;
   } else {
+
+    // Vivint - this was added to reset the state back to how it was initially.  Somehow the socket is getting messed up
+    // when rtspd is resetting.  This code is used when liveness fails to reset the socket.
+    unsigned tempNextDESCRIBEDelay = fNextDESCRIBEDelay; // preserve current delay
+    resetForDescribe();
+    fNextDESCRIBEDelay = tempNextDESCRIBEDelay;
+
     // The "DESCRIBE" command failed, most likely because the server or the stream is not yet running.
     // Reschedule another "DESCRIBE" command to take place later:
     scheduleDESCRIBECommand();
@@ -466,12 +478,20 @@ void ProxyRTSPClient::doReset(void* clientData) {
 void ProxyRTSPClient::scheduleDESCRIBECommand() {
   // Delay 1s, 2s, 4s, 8s ... 256s until sending the next "DESCRIBE".  Then, keep delaying a random time from [256..511] seconds:
   unsigned secondsToDelay;
-  if (fNextDESCRIBEDelay <= 256) {
-    secondsToDelay = fNextDESCRIBEDelay;
-    fNextDESCRIBEDelay *= 2;
-  } else {
-    secondsToDelay = 256 + (our_random()&0xFF); // [256..511] seconds
+  if (fBurstDescribeCount >= 10){
+    if(fNextDESCRIBEDelay <= 256) {
+      secondsToDelay = fNextDESCRIBEDelay;
+      fNextDESCRIBEDelay *= 2;
+    } else {
+      secondsToDelay = 256 + (our_random()&0xFF); // [256..511] seconds
+    }
   }
+  else{
+    fBurstDescribeCount++;
+    fNextDESCRIBEDelay = 1;
+    secondsToDelay = 1;
+  }
+
 
   if (fVerbosityLevel > 0) {
     envir() << *this << ": RTSP \"DESCRIBE\" command failed; trying again in " << secondsToDelay << " seconds\n";
diff --git a/liveMedia/RTPInterface.cpp b/liveMedia/RTPInterface.cpp
index c9a72d5..e799664 100644
--- a/liveMedia/RTPInterface.cpp
+++ b/liveMedia/RTPInterface.cpp
@@ -262,6 +262,18 @@ Boolean RTPInterface::sendPacket(unsigned char* packet, unsigned packetSize) {
 
 void RTPInterface
 ::startNetworkReading(TaskScheduler::BackgroundHandlerProc* handlerProc) {
+  /* Clear out the buffer before playing the streams from camera side
+     to fix preload video issue */
+  char buf[16384];
+  ssize_t bytes_read, total_bytes_read = 0;
+  do {
+    bytes_read = recv(fGS->socketNum(), buf, sizeof(buf), 0);
+    if (bytes_read > 0) {
+      total_bytes_read += bytes_read;
+      /* Discard the data read read from the buffer */
+    }
+  } while (bytes_read > 0);
+  envir() << "SocketNum: <"<< fGS->socketNum() << "> Total bytes discarded: <" << total_bytes_read << ">\n";
   // Normal case: Arrange to read UDP packets:
   envir().taskScheduler().
     turnOnBackgroundReadHandling(fGS->socketNum(), handlerProc, fOwner);
diff --git a/liveMedia/include/ProxyServerMediaSession.hh b/liveMedia/include/ProxyServerMediaSession.hh
index a45a19b..3812014 100644
--- a/liveMedia/include/ProxyServerMediaSession.hh
+++ b/liveMedia/include/ProxyServerMediaSession.hh
@@ -61,6 +61,7 @@ protected:
 private:
   void reset();
   int connectToServer(int socketNum, portNumBits remotePortNum);
+  void resetForDescribe();
 
   Authenticator* auth() { return fOurAuthenticator; }
 
@@ -84,6 +85,7 @@ private:
   class ProxyServerMediaSubsession *fSetupQueueHead, *fSetupQueueTail;
   unsigned fNumSetupsDone;
   unsigned fNextDESCRIBEDelay; // in seconds
+  unsigned fBurstDescribeCount;
   Boolean fServerSupportsGetParameter, fLastCommandWasPLAY, fDoneDESCRIBE;
   TaskToken fDESCRIBECommandTask, fSubsessionTimerTask, fResetTask;
 };
-- 
2.38.1

