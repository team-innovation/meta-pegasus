From 6e237e9cd80b25d76ffb9ffbd07296b75718c99d Mon Sep 17 00:00:00 2001
From: Tanner Oakes <tanner.oakes@vivint.com>
Date: Wed, 1 Sep 2021 10:18:44 -0600
Subject: [PATCH 4/5] Add latency control

---
 src/gsttools/qgstreamerplayersession.cpp | 9 +++++++++
 src/gsttools/qgstreamerplayersession_p.h | 2 ++
 2 files changed, 11 insertions(+)

diff --git a/src/gsttools/qgstreamerplayersession.cpp b/src/gsttools/qgstreamerplayersession.cpp
index 0f0311dee..adfd715c4 100644
--- a/src/gsttools/qgstreamerplayersession.cpp
+++ b/src/gsttools/qgstreamerplayersession.cpp
@@ -361,6 +361,7 @@ void QGstreamerPlayerSession::loadFromUri(const QNetworkRequest &request)
         emit tagsChanged();
 
         g_object_set(G_OBJECT(m_playbin), "uri", m_request.url().toEncoded().constData(), nullptr);
+	g_signal_connect(G_OBJECT(m_playbin), "source-setup", G_CALLBACK(handleSourceCreated), this);
 
         if (!m_streamTypes.isEmpty()) {
             m_streamProperties.clear();
@@ -1906,6 +1907,14 @@ GstAutoplugSelectResult QGstreamerPlayerSession::handleAutoplugSelect(GstBin *bi
     return res;
 }
 
+void QGstreamerPlayerSession::handleSourceCreated(GstElement *pipe, GstElement *source, QGstreamerPlayerSession *session)
+{
+    Q_UNUSED(pipe);
+
+    if (session->m_isLiveSource)
+        g_object_set(source, "latency", session->m_latency, nullptr);
+}
+
 void QGstreamerPlayerSession::handleElementAdded(GstBin *bin, GstElement *element, QGstreamerPlayerSession *session)
 {
     Q_UNUSED(bin);
diff --git a/src/gsttools/qgstreamerplayersession_p.h b/src/gsttools/qgstreamerplayersession_p.h
index 797229e69..1fcb1c67f 100644
--- a/src/gsttools/qgstreamerplayersession_p.h
+++ b/src/gsttools/qgstreamerplayersession_p.h
@@ -196,6 +196,7 @@ private:
 #if !GST_CHECK_VERSION(1,0,0)
     static void insertColorSpaceElement(GstElement *element, gpointer data);
 #endif
+    static void handleSourceCreated(GstElement *pipe, GstElement *source, QGstreamerPlayerSession *session);
     static void handleElementAdded(GstBin *bin, GstElement *element, QGstreamerPlayerSession *session);
     static void handleStreamsChange(GstBin *bin, gpointer user_data);
     static GstAutoplugSelectResult handleAutoplugSelect(GstBin *bin, GstPad *pad, GstCaps *caps, GstElementFactory *factory, QGstreamerPlayerSession *session);
@@ -252,6 +253,7 @@ private:
     QGstreamerAudioProbeControl *m_audioProbe = nullptr;
 
     int m_volume = 100;
+    int m_latency = 2500000000;
     qreal m_playbackRate = 1.0;
     bool m_muted = false;
     bool m_audioAvailable = false;
-- 
2.33.0

