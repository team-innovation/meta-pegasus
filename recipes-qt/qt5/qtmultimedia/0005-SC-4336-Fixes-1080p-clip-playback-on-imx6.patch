From 2d93152559189e7354c7b96af65b36fa9df3f36d Mon Sep 17 00:00:00 2001
From: builder <builder@vivint.com>
Date: Fri, 19 Aug 2016 13:51:59 -0600
Subject: [PATCH] SC-4336 - Fixes 1080p clip playback on imx6

---
 src/gsttools/qvideosurfacegstsink.cpp                  |  7 +++++++
 src/multimedia/video/qvideoframe.cpp                   | 14 ++++++++++++++
 src/multimedia/video/qvideoframe.h                     |  1 +
 src/plugins/videonode/imx6/qsgvivantevideomaterial.cpp |  2 +-
 4 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/src/gsttools/qgstutils.cpp b/src/gsttools/qgstutils.cpp
index 94aaee7..09ac575 100644
--- a/src/gsttools/qgstutils.cpp
+++ b/src/gsttools/qgstutils.cpp
@@ -1180,6 +1180,13 @@ QVideoSurfaceFormat QGstUtils::formatForCaps(GstCaps *caps, int *byte
         if (bytesPerLine)
             *bytesPerLine = ((size.width() * bitsPerPixel / 8) + 3) & ~3;
 
+	if (info.finfo->format == GST_VIDEO_FORMAT_I420) {
+	   if (size.width() == 1920) {
+		//SC-4336 for the imx6, crop the 8 extra lines on the bottom
+		format.setViewport(QRect(0, 0, 1920, 1072));
+	   }
+        }
+
         return format;
     }
 
diff --git a/src/multimedia/video/qvideoframe.cpp b/src/multimedia/video/qvideoframe.cpp
index 8dd23d2..dfa26d8 100644
--- a/src/multimedia/video/qvideoframe.cpp
+++ b/src/multimedia/video/qvideoframe.cpp
@@ -429,6 +429,20 @@ int QVideoFrame::height() const
 }
 
 /*!
+    Returns the extra height of padding for an imx6 frame
+*/
+int QVideoFrame::extraHeight() const
+{
+    //Fixes SC-4336.
+    //The gstreamer-imx decodes 1080p video frames with
+    //8 extra lines of padding for the GPU but doesn't
+    //pass this information along the GstVideoMetadata.
+    //So this is a fix for Qt to inform the GPU and to
+    //crop the boundary of the extra 8 lines.
+    return d->size.height() == 1080 ? 8 : 0;
+}
+
+/*!
     Returns the field an interlaced video frame belongs to.
 
     If the video is not interlaced this will return WholeFrame.
diff --git a/src/multimedia/video/qvideoframe.h b/src/multimedia/video/qvideoframe.h
index d44219d..d4ccd49 100644
--- a/src/multimedia/video/qvideoframe.h
+++ b/src/multimedia/video/qvideoframe.h
@@ -117,6 +117,7 @@ public:
     QSize size() const;
     int width() const;
     int height() const;
+    int extraHeight() const; //This is to patch 1080p video on imx6
 
     FieldType fieldType() const;
     void setFieldType(FieldType);
diff --git a/src/plugins/videonode/imx6/qsgvivantevideomaterial.cpp b/src/plugins/videonode/imx6/qsgvivantevideomaterial.cpp
index 948e9f9..e0946bf 100644
--- a/src/plugins/videonode/imx6/qsgvivantevideomaterial.cpp
+++ b/src/plugins/videonode/imx6/qsgvivantevideomaterial.cpp
@@ -173,7 +173,7 @@ GLuint QSGVivanteVideoMaterial::vivanteMapping(QVideoFrame vF)
 
             glBindTexture(GL_TEXTURE_2D, tmpTexId);
             glTexDirectVIVMap_LOCAL(GL_TEXTURE_2D,
-                                     vF.width(), vF.height(),
+                                     vF.width(), vF.height() + vF.extraHeight(),
                                      QSGVivanteVideoNode::getVideoFormat2GLFormatMap().value(vF.pixelFormat()),
                                      &bits, &physical);
 
-- 
1.9.1

