#!/bin/sh
#
# Copyright Vivint. 2017 mwaddel@vivint.com
# Run the dhrystone benchmark to force the CPU utilization up
#
set -e

SCRIPTNAME=$(basename $BASH_SOURCE)

# Utility functions
carp() {
        echo "$SCRIPTNAME: fatalerror:"
        echo "$1"
        exit 1
}

usage() {
        carp   "usage: $SCRIPTNAME {net} %load time
               net: sends command to network module
               load:  30% = ~5s loaded, ~7sec unloaded
                      50% = ~5s loaded, ~5sec unloaded
                      70% = ~5s loaded, ~3sec unloaded
                     100% = ~5s loaded,  0sec unloaded
               time: min = 10s, max = really big number"
}

check_net() {
        if [ $1 -lt 2 ] || [ $1 -gt 3 ]; then
               usage
               exit 1
        fi
}

check_param_1() {
        if [ $1 -lt 31 ]; then
                LOAD=7
                return
        fi
        if [ $1 -lt 51 ]; then
                LOAD=5
                return
        fi
        if [ $1 -lt 71 ]; then
                LOAD=3
                return
        fi
	LOAD=0
}

check_param_2() {
        if [ $1 -lt 10 ]; then
                TIME_TO_RUN=10
        else
                TIME_TO_RUN=$1
        fi
}

fork_net_process() {
	LOOP_TIMER=$(($1+5))
	TIME=$(($2/$LOOP_TIMER))
	COUNT=1
	while [ $COUNT -le $TIME ]; do
		echo -n -e "Pass: $COUNT of $TIME\r"
		send_net_router_command "dhrystone 3800000 &" > /dev/null
		sleep $LOOP_TIMER
		COUNT=$((COUNT+1))
	done

}

fork_local_process () {
	LOOP_TIMER=$(($1+5))
	TIME=$(($2/$LOOP_TIMER))
	COUNT=1
	while [ $COUNT -le $TIME ]; do
		echo -n -e "Pass: $COUNT of $TIME\r"
		echo 25000000 | taskset 0x1 dhry > /dev/null 2>&1 &
		echo 25000000 | taskset 0x2 dhry > /dev/null 2>&1 &
		sleep $LOOP_TIMER
		COUNT=$(($COUNT+1))
	done
}

PARAMS=$#
check_net "$PARAMS"

if [ "$1" == "net" ]; then
        # run command on network module
        check_param_1 $2
        check_param_2 $3
	ACTUAL_LOAD=$((100-($LOAD*10)))
        echo "Run load MTK, Load: $ACTUAL_LOAD%, Time: $TIME_TO_RUN sec"
	fork_net_process $LOAD $TIME_TO_RUN
else
        check_param_1 $1
        check_param_2 $2
	ACTUAL_LOAD=$((100-($LOAD*10)))
        echo "Run load NXP, Load: $ACTUAL_LOAD%, Time: $TIME_TO_RUN sec"
	fork_local_process $LOAD $TIME_TO_RUN
fi

exit 0
